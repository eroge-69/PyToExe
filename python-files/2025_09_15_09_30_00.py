import openpyxl
from openpyxl.styles import Font, PatternFill, Alignment, Border, Side
from openpyxl.utils import get_column_letter

# Создаем новую книгу Excel
wb = openpyxl.Workbook()

# Удаляем лист по умолчанию и создаем нужные нам листы
if 'Sheet' in wb.sheetnames:
    wb.remove(wb['Sheet'])

ws_input = wb.create_sheet('Исходные_данные')
ws_calc = wb.create_sheet('Расчет_завесы')
ws_ref = wb.create_sheet('Справочники')

# Настраиваем стили
header_fill = PatternFill(start_color="E0E0E0", end_color="E0E0E0", fill_type="solid")
yellow_fill = PatternFill(start_color="FFFF00", end_color="FFFF00", fill_type="solid")
border = Border(left=Side(style='thin'), right=Side(style='thin'), 
                top=Side(style='thin'), bottom=Side(style='thin'))
center_alignment = Alignment(horizontal='center', vertical='center')
left_alignment = Alignment(horizontal='left', vertical='center')

# Заполняем лист "Справочники" (таблица труб по СП 485.1311500.2020)
ref_data = [
    ['Условный проход, мм', 'Наружный диаметр х толщина стенки, мм', 'Удельное сопротивление Kт'],
    [15, '20×2.0', 350000],
    [20, '25×2.0', 110000],
    [25, '32×2.5', 38000],
    [32, '38×2.5', 13000],
    [40, '45×2.5', 7000],
    [50, '57×2.5', 110],
    [65, '76×3.0', 2500],
    [80, '89×3.0', 1100],
    [100, '108×2.8', 4322],
    [125, '133×3.2', 150],
    [150, '159×3.5', 50]
]

for row_idx, row in enumerate(ref_data, 1):
    for col_idx, value in enumerate(row, 1):
        cell = ws_ref.cell(row=row_idx, column=col_idx, value=value)
        cell.border = border
        if row_idx == 1:
            cell.fill = header_fill
            cell.font = Font(bold=True)

# Заполняем лист "Исходные_данные"
input_data = [
    ['Параметр', 'Обозначение', 'Значение', 'Ед. изм.', 'Примечание'],
    ['Данные по завесе', '', '', '', ''],
    ['Ширина завесы', 'L', 4.34, 'м', ''],
    ['Требуемый удельный расход', 'q_двз', 1.0, 'л/с на м', 'СП 5.13150.2020'],
    ['', '', '', '', ''],
    ['Ороситель', '', '', '', ''],
    ['Коэффициент производительности', 'K', 0.56, '', 'Для ЗВН-180'],
    ['Рабочее давление (принятое)', 'P_орс', 0.1, 'МПа', ''],
    ['Высота установки (h)', 'h', 0.28, 'м', 'Для расчета расхода'],
    ['', '', '', '', ''],
    ['Трубопровод', '', '', '', ''],
    ['Скорость воды в трубе', 'V', 10.0, 'м/с', 'п. 6.7.1.37 СП 485...'],
    ['Коэффициент расхода трубы', 'μ', 0.90, '', 'Приложение Б СП 485...'],
    ['', '', '', '', ''],
    ['Геометрия размещения', '', '', '', ''],
    ['Расстояние от края', 'l_кр', 0.50, 'м', 'Не более 0.5 м по СТУ'],
    ['', '', '', '', ''],
    ['Узел управления', '', '', '', ''],
    ['Коэф. потерь УУ', 'ξ_УУд', 0.00000023148, '', 'Для УУ-Д100/1,6...'],
    ['Плотность воды', 'γ', 998.2, 'кг/м³', '']
]

for row_idx, row in enumerate(input_data, 1):
    for col_idx, value in enumerate(row, 1):
        cell = ws_input.cell(row=row_idx, column=col_idx, value=value)
        cell.border = border
        if row_idx == 1:
            cell.fill = header_fill
            cell.font = Font(bold=True)
        if row_idx in [3, 4, 7, 8, 9, 11, 12, 15, 18, 19]:
            ws_input.cell(row=row_idx, column=3).fill = yellow_fill

# Заполняем лист "Расчет_завесы"
calculation_data = [
    ['Шаг', 'Расчетный параметр', 'Формула / Значение', 'Ед. изм.', 'Примечание'],
    [1, 'Треб. расход на завесу (q)', '=Исходные_данные!C3*Исходные_данные!C4', 'л/с', 'q = L × q_двз'],
    [2, 'Расход 1 оросителя при P_орс (Q1)', '=10*Исходные_данные!C7*КОРЕНЬ(Исходные_данные!C8)*КОРЕНЬ(Исходные_данные!C9)', 'л/с', 'Q=10×K×√P×√h'],
    [3, 'Расчетное кол-во оросителей (n)', '=ОКРУВВЕРХ(C2/C3;0)', 'шт.', 'n = q / Q1'],
    [4, 'Итоговое кол-во оросителей (N)', '=C4+2', 'шт.', 'N = n + 2 (по краям)'],
    [5, 'Шаг между оросителями (S)', '=(Исходные_данные!C3-2*Исходные_данные!C15)/(C5-1)', 'м', 'S = (L - 2×l_кр) / (N-1)'],
    ['', '', '', '', ''],
    [6, 'Диаметр трубопровода завесы (расч.)', '=КОРЕНЬ((4*(C3*C5)*1000)/(ПИ()*Исходные_данные!C12*Исходные_данные!C11))', 'мм', ''],
    [6.1, 'Диаметр трубопровода завесы (принятый)', '=ВПР(C8;Справочники!A2:C12;1;1)', 'мм', 'По таблице Б.2 СП 485'],
    [6.2, 'Уд. сопр. трубы завесы (Kт)', '=ВПР(C8;Справочники!A2:C12;3;1)', '', ''],
    ['', '', '', '', ''],
    [7, 'Потери на участке 1.1-1.2 (ΔP1)', '=(C3^2*C6)/(100*C10)', 'МПа', 'ΔP = (Q² × L) / (100 × Kт)'],
    [8, 'Давление у оросителя 2 (P1.2)', '=Исходные_данные!C8+C11', 'МПа', ''],
    [9, 'Расход оросителя 2 (Q1.2)', '=10*Исходные_данные!C7*КОРЕНЬ(C12)*КОРЕНЬ(Исходные_данные!C9)', 'л/с', ''],
    [10, 'Суммарный расход до узла 1.3 (ΣQ1.2)', '=C3+C13', 'л/с', ''],
    ['', '', '', '', ''],
    [11, 'Потери на участке 1.2-1.3 (ΔP2)', '=(C14^2*C6)/(100*C10)', 'МПа', ''],
    [12, 'Давление у оросителя 3 (P1.3)', '=C12+C15', 'МПа', ''],
    [13, 'Расход оросителя 3 (Q1.3)', '=10*Исходные_данные!C7*КОРЕНЬ(C16)*КОРЕНЬ(Исходные_данные!C9)', 'л/с', ''],
    [14, 'Суммарный расход до узла 1.4 (ΣQ1.3)', '=C14+C17', 'л/с', ''],
    ['', '', '', '', ''],
    [15, 'ИТОГО: Суммарный расход всех оросителей (Qсум)', '=C18*C5', 'л/с', 'Упрощенный расчет'],
    ['', '', '', '', ''],
    [16, 'Диаметр распред. трубопровода (расч.)', '=КОРЕНЬ((4*C21*1000)/(ПИ()*Исходные_данные!C12*Исходные_данные!C11))', 'мм', ''],
    [16.1, 'Диаметр распред. трубопровода (принятый)', '=ВПР(C22;Справочники!A2:C12;1;1)', 'мм', 'По таблице Б.2 СП 485'],
    [16.2, 'Уд. сопр. трубы распред. (Kт_100)', '=ВПР(C22;Справочники!A2:C12;3;1)', '', ''],
    ['', '', '', '', ''],
    [17, 'Потери в узле управления (P_УУд)', '=Исходные_данные!C18*Исходные_данные!C19*(C21*3,6)^2', 'МПа', 'P_УУд = ξ×γ×Q²'],
    [18, 'Общие потери в системе (ΔP_общ)', '=C11+C15+0.002', 'МПа', 'Примерное значение'],
    ['', '', '', '', ''],
    [19, 'ТРЕБУЕМОЕ ДАВЛЕНИЕ у ВПВ (Pmax)', '=Исходные_данные!C8+C28', 'МПа', ''],
    [20, 'ТРЕБУЕМЫЙ РАСХОД у ВПВ (Qmax)', '=C21', 'л/с', '']
]

for row_idx, row in enumerate(calculation_data, 1):
    for col_idx, value in enumerate(row, 1):
        cell = ws_calc.cell(row=row_idx, column=col_idx, value=value)
        cell.border = border
        if row_idx == 1:
            cell.fill = header_fill
            cell.font = Font(bold=True)

# Настраиваем ширину колонок
for ws in [ws_input, ws_calc, ws_ref]:
    for col in range(1, 6):
        ws.column_dimensions[get_column_letter(col)].width = 20

# Сохраняем файл
file_path = "calculation_sprinklers_corrected.xlsx"
wb.save(file_path)

print(f"Файл успешно создан: {file_path}")
print("Листы в файле:")
print("- Исходные_данные: Входные параметры для расчета (меняйте значения в желтых ячейках)")
print("- Расчет_завесы: Автоматический расчет всех параметров")
print("- Справочники: Таблица труб по СП 485.1311500.2020")