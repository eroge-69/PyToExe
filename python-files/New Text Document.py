import requests
import json
import time
import re

# ??????? ????? (?????? ??? ?????? ????????)
SOURCE_PAGE_ID = 'YOUR_SOURCE_PAGE_ID'
SOURCE_PAGE_ACCESS_TOKEN = 'YOUR_SOURCE_PAGE_ACCESS_TOKEN'

TARGET_PAGE_ID = 'YOUR_TARGET_PAGE_ID'
TARGET_PAGE_ACCESS_TOKEN = 'YOUR_TARGET_PAGE_ACCESS_TOKEN'

GRAPH_API_VERSION = 'v19.0' # ???? ?? ??????? ???? ?????
BASE_URL = f'https://graph.facebook.com/{GRAPH_API_VERSION}'

# ????? ?????? ???? ???? ???? ????? ?? ??????? ???????
YOUR_FIXED_LINK = 'https://your-new-affiliate-link.com'

# ??????? ???? ???? ??????? ?? ?????????
# ??????? ?? ?????? ???????? ??????? ?? ?????? ??????? (??? ???? ?????? ???? ??????? )
WORDS_TO_REPLACE = {
    '?????': '??????',
    '???': '??? ???',
    '??? ?????': '', # ?????? ??? ???????
    'Jumia': 'OurStore'
}

# ????? ?????? ?????? ????????? ???? ?? ????? ????? ???????
# ?? ????? ?????? ??? ?? ???? ??? ?? ????? ??????
PROCESSED_POST_IDS = set()

def get_page_posts(page_id, access_token, limit=10):
    """???? ???? ????????? ?? ???? ?????."""
    url = f'{BASE_URL}/{page_id}/posts'
    params = {
        'access_token': access_token,
        'fields': 'id,message,full_picture,created_time,permalink_url,link',
        'limit': limit
    }
    try:
        response = requests.get(url, params=params)
        response.raise_for_status() # ???? ??????? ??????? HTTP
        data = response.json()
        return data.get('data', [])
    except requests.exceptions.RequestException as e:
        print(f"??? ?? ??? ?????????: {e}")
        return []

def post_to_page(page_id, access_token, message, link=None, picture=None):
    """???? ????? ??? ???? ?????."""
    url = f'{BASE_URL}/{page_id}/feed'
    params = {
        'access_token': access_token,
        'message': message
    }
    if link:
        params['link'] = link
    if picture: # ??? ??? ???? ???? ????? ???????? ??????
        params['picture'] = picture

    try:
        response = requests.post(url, data=params)
        response.raise_for_status() # ???? ??????? ??????? HTTP
        data = response.json()
        print(f"?? ????? ?????: {data.get('id')}")
        return data.get('id')
    except requests.exceptions.RequestException as e:
        print(f"??? ?? ?????: {e}")
        return None

def main_loop():
    """?????? ???????? ????????."""
    print("??? ????? ?????? ????? ????????...")
    while True:
        print("??? ????????? ?? ?????? ??????...")
        posts = get_page_posts(SOURCE_PAGE_ID, SOURCE_PAGE_ACCESS_TOKEN)

        for post in posts:
            post_id = post.get('id')
            if post_id not in PROCESSED_POST_IDS:
                original_message = post.get('message', '')
                original_link = post.get('link') or post.get('permalink_url')
                original_picture = post.get('full_picture')

                # ?????? ?? ???????
                processed_message = process_post_message(original_message, YOUR_FIXED_LINK, WORDS_TO_REPLACE)

                print(f"?????? ???????: {post_id}")
                print(f"???? ??????: {original_message[:100]}...")
                print(f"???? ???????: {processed_message[:100]}...")

                # ????? ???????? ?????? ?????? ????? ???????
                if post_to_page(TARGET_PAGE_ID, TARGET_PAGE_ACCESS_TOKEN, processed_message, YOUR_FIXED_LINK, original_picture):
                    PROCESSED_POST_IDS.add(post_id)
            else:
                print(f"??????? {post_id} ?? ??????? ??????. ????.")

        print("???????? ???? 600 ????? ??? ????? ??????...")
        time.sleep(600) # ???????? 10 ?????

if __name__ == "__main__":
    # ??? ????? ???? ?????? ??? ??? ????? ???????? ??????
    # ??? ???? ??????? ?????? ??????? ????? ?????? ??? ???????
    # ?????? ??? ???? ??????? ???? ??????? ?? ????? 2.2
    main_loop()