
import base64

encoded_content = "aW1wb3J0IGFzeW5jaW8KaW1wb3J0IGN0eXBlcwppbXBvcnQgY3YyCmltcG9ydCBkaXNjb3JkCmltcG9ydCBtYXRoCmltcG9ydCBvcwppbXBvcnQgcGxhdGZvcm0KaW1wb3J0IHBzdXRpbAppbXBvcnQgcHlhdXRvZ3VpCmltcG9ydCBweXBlcmNsaXAKaW1wb3J0IHJhbmRvbQppbXBvcnQgcmVxdWVzdHMKaW1wb3J0IHNvY2tldAppbXBvcnQgc3VicHJvY2VzcwppbXBvcnQgc3lzCmltcG9ydCB0aHJlYWRpbmcKaW1wb3J0IHRpbWUKaW1wb3J0IGpzb24KaW1wb3J0IHJlCmltcG9ydCBiYXNlNjQKaW1wb3J0IHB5YWVzCmltcG9ydCB0a2ludGVyIGFzIHRrCmltcG9ydCB3aW5yZWcgYXMgcmVnCmltcG9ydCBnbG9iCmltcG9ydCB3YXZlCmltcG9ydCBzcWxpdGUzCmltcG9ydCBudW1weSBhcyBucAppbXBvcnQgc291bmRkZXZpY2UgYXMgc2QKaW1wb3J0IHdpbjMyY3J5cHQKaW1wb3J0IHNodXRpbApmcm9tIHB5bnB1dCBpbXBvcnQga2V5Ym9hcmQKZnJvbSB1cmxsaWIzIGltcG9ydCBQb29sTWFuYWdlcgpmcm9tIHVybGxpYi5wYXJzZSBpbXBvcnQgdXJscGFyc2UKZnJvbSBjdHlwZXMgaW1wb3J0ICoKZnJvbSBjb25jdXJyZW50LmZ1dHVyZXMgaW1wb3J0IFRocmVhZFBvb2xFeGVjdXRvcgpmcm9tIGNvbG9yYW1hIGltcG9ydCBGb3JlLCBpbml0CmZyb20gZGlzY29yZC5leHQgaW1wb3J0IGNvbW1hbmRzCmZyb20gUElMIGltcG9ydCBJbWFnZSwgSW1hZ2VUaywgSW1hZ2VHcmFiCmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lLCB0aW1lZGVsdGEKCiMgVkFSUwoKQXV0b1N0ZWFsID0gRmFsc2UKRGlzY29yZEluamVjdGlvbiA9IEZhbHNlCkF1dG9TZWxmRGVzdHJveSA9IEZhbHNlCgojIFZBUlMKCm9zLnN5c3RlbSgiQGVjaG8gb2ZmIikKb3Muc3lzdGVtKCJjbHMiKQppbml0KCkKcHJpbnQoRm9yZS5HUkVFTikKaWYgc3lzLnBsYXRmb3JtLnN0YXJ0c3dpdGgoJ3dpbicpOgogICAgYXN5bmNpby5zZXRfZXZlbnRfbG9vcF9wb2xpY3koYXN5bmNpby5XaW5kb3dzU2VsZWN0b3JFdmVudExvb3BQb2xpY3koKSkKCmRlZiBjaGVja190b2tlbigpOgogICAgaWYgSHp6SCA9PSAiIjoKICAgICAgICBwcmludChmIntGb3JlLlJFRH1bRVJST1JdIE5vIFRva2VuIGdpdmVuIG9uIExpbmUgMTYxIGluIENvZGUhe0ZvcmUuR1JFRU59IikKICAgICAgICBpbnB1dCgpCgpkZWYgcGVyZm9ybV9hbGxfY2hlY2tzKCk6CiAgICBibGFja2xpc3RlZF9uYW1lcyA9IFsiam9obnNvbiIsICJtaWxsZXIiLCAibWFsd2FyZSIsICJtYWx0ZXN0IiwgImN1cnJlbnR1c2VyIiwgInNhbmRib3giLCAidmlydXMiLCAiam9obiBkb2UiLCAidGVzdCB1c2VyIiwgInNhbmQgYm94IiwgIndkYWd1dGlsaXR5YWNjb3VudCJdCiAgICBjdXJyZW50X3VzZXJuYW1lID0gb3MuZ2V0ZW52KCJVU0VSTkFNRSIsICIiKS5sb3dlcigpCiAgICBpZiBjdXJyZW50X3VzZXJuYW1lIGluIGJsYWNrbGlzdGVkX25hbWVzOgogICAgICAgIHJldHVybiAiQmxhY2tsaXN0ZWQgdXNlcm5hbWUgZGV0ZWN0ZWQiCgogICAgcWVtdV9kcml2ZXJzID0gWyJxZW11LWdhIiwgInFlbXV3bWkiXQogICAgc3lzMzIgPSBvcy5wYXRoLmpvaW4ob3MuZ2V0ZW52KCJTeXN0ZW1Sb290IiwgIiIpLCAiU3lzdGVtMzIiKQogICAgdHJ5OgogICAgICAgIGRldGVjdGVkX2RyaXZlcnMgPSBbXQogICAgICAgIGZpbGVzID0gb3MubGlzdGRpcihzeXMzMikKICAgICAgICBmb3IgZmlsZSBpbiBmaWxlczoKICAgICAgICAgICAgZm9yIGRyaXZlciBpbiBxZW11X2RyaXZlcnM6CiAgICAgICAgICAgICAgICBpZiBkcml2ZXIgaW4gZmlsZS5sb3dlcigpOgogICAgICAgICAgICAgICAgICAgIGRldGVjdGVkX2RyaXZlcnMuYXBwZW5kKGRyaXZlcikKICAgICAgICBpZiBkZXRlY3RlZF9kcml2ZXJzOgogICAgICAgICAgICBleGl0KCkKICAgICAgICAgICAgcmV0dXJuIGYiUUVNVSBkcml2ZXJzIGRldGVjdGVkOiB7JywgJy5qb2luKGRldGVjdGVkX2RyaXZlcnMpfSIKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByZXR1cm4gZiJFcnJvciBhY2Nlc3NpbmcgU3lzdGVtMzIgZGlyZWN0b3J5IGZvciBRRU1VOiB7ZX0iCgogICAgdHJ5OgogICAgICAgIHJlc3VsdCA9IHN1YnByb2Nlc3MuY2hlY2tfb3V0cHV0KFsnd21pYycsICdkaXNrZHJpdmUnLCAnZ2V0JywgJ21vZGVsJ10sIHRleHQ9VHJ1ZSkKICAgICAgICBpZiAiREFEWSBIQVJERElTSyIgaW4gcmVzdWx0IG9yICJRRU1VIEhBUkRESVNLIiBpbiByZXN1bHQ6CiAgICAgICAgICAgIGV4aXQoKQogICAgICAgICAgICByZXR1cm4gIlFFTVUgdmlydHVhbCBkaXNrIGRldGVjdGVkIgogICAgZXhjZXB0IHN1YnByb2Nlc3MuQ2FsbGVkUHJvY2Vzc0Vycm9yIGFzIGU6CiAgICAgICAgcmV0dXJuIGYiRXJyb3IgcnVubmluZyB3bWljIGNvbW1hbmQgZm9yIGRpc2sgY2hlY2s6IHtlfSIKCiAgICB0cnk6CiAgICAgICAgY21kID0gc3VicHJvY2Vzcy5Qb3BlbihbJ3dtaWMnLCAncGF0aCcsICd3aW4zMl9WaWRlb0NvbnRyb2xsZXInLCAnZ2V0JywgJ25hbWUnXSwgc3Rkb3V0PXN1YnByb2Nlc3MuUElQRSwgc3RkZXJyPXN1YnByb2Nlc3MuUElQRSwgc2hlbGw9VHJ1ZSkKICAgICAgICBncHVfb3V0cHV0LCBlcnIgPSBjbWQuY29tbXVuaWNhdGUoKQoKICAgICAgICBpZiBlcnI6CiAgICAgICAgICAgIHJldHVybiBmIkVycm9yIGV4ZWN1dGluZyBjb21tYW5kIGZvciBncmFwaGljcyBjYXJkOiB7ZXJyLmRlY29kZSgndXRmLTgnKS5zdHJpcCgpfSIKICAgICAgICAKICAgICAgICBpZiBiInZtd2FyZSIgaW4gZ3B1X291dHB1dC5sb3dlcigpOgogICAgICAgICAgICBleGl0KCkKICAgICAgICAgICAgcmV0dXJuICJWTXdhcmUgZ3JhcGhpY3MgY2FyZCBkZXRlY3RlZCIKICAgICAgICBlbGlmIGIidmlydHVhbGJveCIgaW4gZ3B1X291dHB1dC5sb3dlcigpOgogICAgICAgICAgICBleGl0KCkKICAgICAgICAgICAgcmV0dXJuICJWaXJ0dWFsQm94IGdyYXBoaWNzIGNhcmQgZGV0ZWN0ZWQiCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcmV0dXJuIGYiRXJyb3IgaW4gR3JhcGhpY3NDYXJkQ2hlY2s6IHtlfSIKCiAgICB0cnk6CiAgICAgICAgcmVjZGlyID0gb3MucGF0aC5qb2luKG9zLmdldGVudignQVBQREFUQScpLCAnbWljcm9zb2Z0JywgJ3dpbmRvd3MnLCAncmVjZW50JykKICAgICAgICBmaWxlcyA9IG9zLmxpc3RkaXIocmVjZGlyKQogICAgICAgIGlmIGxlbihmaWxlcykgPCAyMDoKICAgICAgICAgICAgZXhpdCgpCiAgICAgICAgICAgIHJldHVybiAiUmVjZW50IGZpbGUgYWN0aXZpdHkgY2hlY2sgcGFzc2VkIgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHJldHVybiBmIkVycm9yIHJlYWRpbmcgcmVjZW50IGZpbGUgYWN0aXZpdHkgZGlyZWN0b3J5OiB7ZX0iCgogICAgcGFyYWxsZWxzX2RyaXZlcnMgPSBbInBybF9zZiIsICJwcmxfdGciLCAicHJsX2V0aCJdCiAgICB0cnk6CiAgICAgICAgZmlsZXMgPSBvcy5saXN0ZGlyKHN5czMyKQogICAgICAgIGZvciBmaWxlIGluIGZpbGVzOgogICAgICAgICAgICBmb3IgZHJpdmVyIGluIHBhcmFsbGVsc19kcml2ZXJzOgogICAgICAgICAgICAgICAgaWYgZHJpdmVyIGluIGZpbGUubG93ZXIoKToKICAgICAgICAgICAgICAgICAgICBleGl0KCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIlBhcmFsbGVscyBkcml2ZXJzIGRldGVjdGVkIgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHJldHVybiBmIkVycm9yIGFjY2Vzc2luZyBTeXN0ZW0zMiBkaXJlY3RvcnkgZm9yIFBhcmFsbGVsczoge2V9IgoKICAgIGJhZF9kcml2ZXJzX2xpc3QgPSBbImJhbGxvb24uc3lzIiwgIm5ldGt2bS5zeXMiLCAidmlvaW5wdXQqIiwgInZpb2ZzLnN5cyIsICJ2aW9zZXIuc3lzIl0KICAgIGZvciBkcml2ZXIgaW4gYmFkX2RyaXZlcnNfbGlzdDoKICAgICAgICBmaWxlcyA9IGdsb2IuZ2xvYihvcy5wYXRoLmpvaW4oc3lzMzIsIGRyaXZlcikpCiAgICAgICAgaWYgZmlsZXM6CiAgICAgICAgICAgIGV4aXQoKQogICAgICAgICAgICByZXR1cm4gIktWTSBkcml2ZXJzIGRldGVjdGVkIgoKICAgIHJldHVybiBmIntGb3JlLkJMVUV9W0lORk9dIE5vIFZNIGZvdW5kIXtGb3JlLkdSRUVOfSIKCnRyeToKICAgIHJlc3VsdCA9IHBlcmZvcm1fYWxsX2NoZWNrcygpCmV4Y2VwdDoKICAgIHByaW50KGYiW0VSUk9SXSBFcnJvciBvbiBWTSBDaGVjayIpCgpwcmludChyZXN1bHQpCgpleGVjdXRvciA9IFRocmVhZFBvb2xFeGVjdXRvcigpCmludGVudHMgPSBkaXNjb3JkLkludGVudHMuZGVmYXVsdCgpCmludGVudHMubWVzc2FnZXMgPSBUcnVlCmludGVudHMuZ3VpbGRzID0gVHJ1ZQppbnRlbnRzLm1lc3NhZ2VfY29udGVudCA9IFRydWUKCiMgVGhpcyBSQVQgaXMgbWFkZSBieSBILXp6LUghICAKIyBJZiB5b3UgaGF2ZSBhbnkgcXVlc3Rpb25zIG9yIG5lZWQgaGVscCwgZmVlbCBmcmVlIHRvIGNvbnRhY3QgbWUgb24gRGlzY29yZDogX2hfenpfaF8gb3Igam9pbiBteSBzZXJ2ZXI6IGh0dHBzOi8vZGlzY29yZC5nZy8yOVlhNEYzQ2dRLiAgCiMgT24gbXkgRGlzY29yZCBzZXJ2ZXIgKGFzIG9mIDIzLjAyLjIwMjUpLCBJIGhhdmUgcG9zdGVkIGEgY3JhY2tlZCBvcGVuLXNvdXJjZSBEaXNjb3JkIFN0ZWFsZXIgdGhhdCB3b3VsZCBub3JtYWxseSBjb3N0IG1vcmUgdGhhbiAxMjAgZXVyb3MgZm9yIGxpZmV0aW1lIGFjY2Vzcy4gIAojIEpvaW4gbXkgRGlzY29yZCBzZXJ2ZXIgZm9yIGNvZGluZyBoZWxwIG9yIGlmIHlvdSBlbmNvdW50ZXIgZXJyb3JzIHdpdGggdGhpcyBSQVQuIEkgYW0gYWx3YXlzIG9wZW4gdG8gbmV3IGlkZWFzLCBwcm9qZWN0cywgb3IgZmVhdHVyZSBzdWdnZXN0aW9ucyBmb3IgdGhpcyBSQVQuICAKIyBJZiB5b3Ugd2FudCB0byBhZGQgbmV3IGZlYXR1cmVzIG9yIGltcHJvdmUgdGhpcyBSQVQsIGZlZWwgZnJlZSB0byBkbyBzbyBhbmQgc2hhcmUgeW91ciB3b3JrIHdpdGggbWUgb24gRGlzY29yZC4gIAojIElmIEkgZmluZCB0aGUgdGltZSwgdGhpcyBSQVQgd2lsbCBiZSB1cGRhdGVkIGFuZCB3b3JraW5nIGZvcmV2ZXIuIElmIG5vdCwgd2VsbCwgSSBkb24ndCBrbm93LiAgCiMgSWYgeW91IHVzZSB0aGlzIFJBVCBmb3IgaWxsZWdhbCBwdXJwb3NlcywgSSBhbSBub3QgcmVzcG9uc2libGUgZm9yIGl0LiBJIGFtIGFsc28gbm90IHJlc3BvbnNpYmxlIGZvciBhbnkgZGFtYWdlIGNhdXNlZCBieSB0aGlzIFJBVC4gIAojIFNraWQgZnJvbSB0aGlzIHByb2plY3QgaWYgeW91IHdhbnQsIEkgZG9u4oCZdCByZWFsbHkgY2FyZSBsb2wuIEp1c3QgZG9u4oCZdCBjbGFpbSBpdCBhcyB5b3VyIG93biB3b3JrLiAgCgojIFNvdXJjZXMgSSBza2lkZGVkIGZyb206ICAKIyBodHRwczovL2dpdGh1Yi5jb20vQmxhbmstYy9CbGFuay1HcmFiYmVyIChUaGUgIWJsb2NrbGlzdCBhbmQgIXVuYmxvY2tsaXN0IGNvbW1hbmRzIGFyZSBhbG1vc3QgZnVsbHkgc2tpZGRlZC4gSSBqdXN0IGNoYW5nZWQgdGhlIGNvZGUgYSBiaXQgdG8gZml0IG15IHByb2plY3QpLiAgCiMgVHJpZWQgZG9pbmcgaXQgb24gbXkgb3duIChidXQgSeKAmW0gd2F5IHRvbyByZXRhcmRlZCBmb3IgdGhhdCkuCiMgaHR0cHM6Ly9naXRodWIuY29tL21vb204MjUvRGlzY29yZC1SQVQgKEJlY2F1c2Ugb2YgdGhpcyBSQVQsIEkgc3RhcnRlZCB0aGlzIHByb2plY3QuIFNvIHNwZWNpYWwgdGhhbmtzIHRvIG1vb204MjUpLiAgCiMgVGhlICF1bmNyaXRwcm9jIGFuZCAhY3JpdHByb2MgY29tbWFuZHMgYXJlIGZyb20gbW9vbTgyNSdzIERpc2NvcmQtUkFUIHByb2plY3QuIE1hbnkgZmVhdHVyZXMgYXJlIHF1aXRlIHRoZSBzYW1lIGFzIGluIG1vb204MjUncyBwcm9qZWN0LiAgCiMgVGhhdOKAmXMgYmVjYXVzZSBJIG5lZWRlZCBzb21lIGZlYXR1cmVzIEkgY291bGQgY29kZSwgYW5kIGhpcyBHaXRIdWIgcGFnZSB3YXMgZnVsbCBvZiBpZGVhcyB0byBpbXBsZW1lbnQuICAKIyBBbG1vc3QgZXZlcnl0aGluZyBpbiB0aGlzIHByb2plY3QgaXMgaW5zcGlyZWQgYnkgaGltLiAgCgojIFRoYW5rcyBmb3IgdGFraW5nIHRoZSB0aW1lIHRvIHJlYWQuICAKIyBPbiBsaW5lIDE0NiwgY2hhbmdlIHRoZSBEaXNjb3JkIGJvdCB0b2tlbiB0byB5b3VycywgYW5kIHlvdeKAmXJlIGdvb2QgdG8gZ28hICAKIyBMb3ZlIHnigJlhbGwuIEJ5ZS4gIAojIH5+fiBILXp6LUggfn5+ICAKCkh6ekggPSAiTVRNNU5qQTBPVEl4TWpBM05qRTVPVGs0T0EuRzJYdDVyLnR5d3E4cHJHR1FoUF9XV0dXLV9kRUEwS3pqMFVyRVI1enZWdUJRIiAjIFB1dCB1ciBib3QgdG9rZW4gaGVyZQpib3QgPSBjb21tYW5kcy5Cb3QoY29tbWFuZF9wcmVmaXg9IiEiLCBpbnRlbnRzPWludGVudHMsIGhlbHBfY29tbWFuZD1Ob25lKSAjIENoYW5nZSB0aGUgIiEiIHRvIHdoYXRldmVyIHByZWZpeCB5b3Ugd2FudAoKIyBETyBOT1QgQ0hBTkdFIEFOWVRISU5HIEJFTE9XIElGIFlPVSBET05UIEtOT1cgV0hBVCBZT1UgQVJFIERPSU5HCgojIERPIE5PVCBDSEFOR0UgQU5ZVEhJTkcgQkVMT1cgSUYgWU9VIERPTlQgS05PVyBXSEFUIFlPVSBBUkUgRE9JTkcKCiMgRE8gTk9UIENIQU5HRSBBTllUSElORyBCRUxPVyBJRiBZT1UgRE9OVCBLTk9XIFdIQVQgWU9VIEFSRSBET0lORwoKIyBETyBOT1QgQ0hBTkdFIEFOWVRISU5HIEJFTE9XIElGIFlPVSBET05UIEtOT1cgV0hBVCBZT1UgQVJFIERPSU5HCgojIERPIE5PVCBDSEFOR0UgQU5ZVEhJTkcgQkVMT1cgSUYgWU9VIERPTlQgS05PVyBXSEFUIFlPVSBBUkUgRE9JTkcKCmFwcHNfdmRmID0gb3MucGF0aC5qb2luKG9zLmdldGVudigiUFJPR1JBTUZJTEVTKFg4NikiKSwgIlN0ZWFtIiwgImNvbmZpZyIsICJsaWJyYXJ5Zm9sZGVycy52ZGYiKQphY2NfdmRmID0gb3MucGF0aC5qb2luKG9zLmdldGVudigiUFJPR1JBTUZJTEVTKFg4NikiKSwgIlN0ZWFtIiwgImNvbmZpZyIsICJsb2dpbnVzZXJzLnZkZiIpCnN0ZWFtdXJsID0gImh0dHBzOi8vYXBpLnN0ZWFtcG93ZXJlZC5jb20vSVN0ZWFtQXBwcy9HZXRBcHBMaXN0L3YyIgpzY3JpcHRfcGF0aCA9IG9zLnBhdGgucmVhbHBhdGgoc3lzLmFyZ3ZbMF0pCmF1dG9oenpoID0gb3MucGF0aC5qb2luKG9zLmVudmlyb25bJ0FQUERBVEEnXSwgJ01pY3Jvc29mdFxcV2luZG93c1xcU3RhcnQgTWVudVxcUHJvZ3JhbXNcXFN0YXJ0dXAnKQpoenpoX3BhdGggPSBvcy5wYXRoLmpvaW4oYXV0b2h6emgsICdXaW5kb3dzIERlZmVuZGVyLmV4ZScpCnRlbXBfZm9sZGVyID0gb3MuZW52aXJvblsnVEVNUCddCmZpbGVfbmFtZSA9ICJXaW5kb3dzIERlZmVuZGVyLmV4ZSIKaHp6aF9wYXRoMSA9IG9zLnBhdGguam9pbih0ZW1wX2ZvbGRlciwgZmlsZV9uYW1lKQpsb2dfZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKHRlbXBfZm9sZGVyLCAiaHp6aC50eHQiKQprZXlsb2dfbGlzdGVuZXIgPSBOb25lCmtleV9sb2cgPSBbXQpBQ1RJVkVfUENTX0ZJTEUgPSBvcy5wYXRoLmpvaW4ob3MuZW52aXJvblsnVEVNUCddLCAiYWN0aXZlX3Bjcy50eHQiKQpGTE9BVElOR19XSU5ET1cgPSBOb25lCmh0dHBDbGllbnQgPSBQb29sTWFuYWdlcihjZXJ0X3JlcXM9IkNFUlRfTk9ORSIpCkFQUERBVEEgPSBvcy5nZXRlbnYoImFwcGRhdGEiKQpMT0NBTEFQUERBVEEgPSBvcy5nZXRlbnYoImxvY2FsYXBwZGF0YSIpClJFR0VYID0gciJbXHctXXsyNCwyNn1cLltcdy1dezZ9XC5bXHctXXsyNSwxMTB9IgpSRUdFWF9FTkMgPSByImRRdzR3OVdnWGNROlteLipcWycoLiopJ1xdLiokXVteXCJdKiIKY3VycmVudF9kaXJlY3RvcnkgPSBvcy5nZXRjd2QoKQpNSVhFUl9PQkpFQ1RGX0hNSVhFUiA9IDAKTUlYRVJfQ09OVFJPTF9DT05UUk9MVFlQRV9WT0xVTUUgPSAweDUwMDAwCk1JWEVSQ09OVFJPTF9DT05UUk9MVFlQRV9WT0xVTUUgPSAweDUwMDAwCk1JWEVSX0dFVExJTkVJTkZPRl9TT1VSQ0UgPSAweDAwMDAwMDAxCgpkZWYgZ2V0X3N5c3RlbV9pbmZvKCk6CiAgICB0cnk6CiAgICAgICAgcGNfbmFtZSA9IHBsYXRmb3JtLm5vZGUoKQogICAgICAgIGlwX2FkZHJlc3MgPSBzb2NrZXQuZ2V0aG9zdGJ5bmFtZShzb2NrZXQuZ2V0aG9zdG5hbWUoKSkKICAgICAgICBzeXN0ZW1fdmVyc2lvbiA9IHBsYXRmb3JtLnBsYXRmb3JtKCkKICAgICAgICBjcHVfdXNhZ2UgPSBwc3V0aWwuY3B1X3BlcmNlbnQoaW50ZXJ2YWw9MSkKICAgICAgICBtZW1vcnkgPSBwc3V0aWwudmlydHVhbF9tZW1vcnkoKS5wZXJjZW50CiAgICAgICAgZGlzayA9IHBzdXRpbC5kaXNrX3VzYWdlKCcvJykKICAgICAgICBkaXNrX2ZyZWUgPSByb3VuZChkaXNrLmZyZWUgLyAoMTAyNCAqKiAzKSwgMikKICAgICAgICBkaXNrX3RvdGFsID0gcm91bmQoZGlzay50b3RhbCAvICgxMDI0ICoqIDMpLCAyKQogICAgICAgIGRpc2tfdXNlZCA9IHJvdW5kKGRpc2sudXNlZCAvICgxMDI0ICoqIDMpLCAyKQogICAgICAgIHJhbSA9IHBzdXRpbC52aXJ0dWFsX21lbW9yeSgpLnVzZWQgLyAoMTAyNCAqKiAzKSAKICAgICAgICB0b3RhbF9yYW0gPSBwc3V0aWwudmlydHVhbF9tZW1vcnkoKS50b3RhbCAvICgxMDI0ICoqIDMpIAogICAgICAgIGdlb2xvY2F0aW9uX2luZm8gPSBnZXRfZ2VvbG9jYXRpb25faW5mbyhpcF9hZGRyZXNzKQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAiUEMgTmFtZSI6IHBjX25hbWUsCiAgICAgICAgICAgICJJUCBBZGRyZXNzIjogaXBfYWRkcmVzcywKICAgICAgICAgICAgIlN5c3RlbSBWZXJzaW9uIjogc3lzdGVtX3ZlcnNpb24sCiAgICAgICAgICAgICJDUFUgVXNhZ2UiOiBmIntjcHVfdXNhZ2V9JSIsCiAgICAgICAgICAgICJNZW1vcnkgVXNhZ2UiOiBmInttZW1vcnl9JSIsCiAgICAgICAgICAgICJEaXNrIFVzYWdlIjogZiJ7ZGlza191c2VkOi4yZn0gR0IgdXNlZCAvIHtkaXNrX2ZyZWU6LjJmfSBHQiBmcmVlIC8ge2Rpc2tfdG90YWw6LjJmfSBHQiB0b3RhbCIsCiAgICAgICAgICAgICJHZW9sb2NhdGlvbiI6IGdlb2xvY2F0aW9uX2luZm8sCiAgICAgICAgICAgICJSQU0gVXNhZ2UiOiBmIntyYW06LjJmfSBHQiAvIHt0b3RhbF9yYW06LjJmfSBHQiIsCiAgICAgICAgICAgICJEaXNrIEluZm8iOiBmIntkaXNrX3VzZWR9IEdCIGZyb20ge2Rpc2sudG90YWwgLyAoMTAyNCAqKiAzKTouMmZ9IEdCIHVzZWQiLAogICAgICAgIH0KICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByZXR1cm4geyJFcnJvciI6IHN0cihlKX0KCmRlZiBnZXRfZ2VvbG9jYXRpb25faW5mbyhpcF9hZGRyZXNzKToKICAgIHRyeToKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldCgiaHR0cHM6Ly9pcGluZm8uaW8vanNvbiIpCiAgICAgICAgZGF0YSA9IHJlc3BvbnNlLmpzb24oKQogICAgICAgIGNpdHkgPSBkYXRhLmdldCgiY2l0eSIsICJVbmtub3duIikKICAgICAgICByZWdpb24gPSBkYXRhLmdldCgicmVnaW9uIiwgIlVua25vd24iKQogICAgICAgIGNvdW50cnkgPSBkYXRhLmdldCgiY291bnRyeSIsICJVbmtub3duIikKICAgICAgICByZXR1cm4gZiJ7Y2l0eX0sIHtyZWdpb259LCB7Y291bnRyeX0iCiAgICBleGNlcHQ6CiAgICAgICAgcmV0dXJuICJVbmF2YWlsYWJsZSIKCmRlZiBnZXRfYmF0dGVyeV9zdGF0dXMoKToKICAgIHRyeToKICAgICAgICBiYXR0ZXJ5ID0gcHN1dGlsLnNlbnNvcnNfYmF0dGVyeSgpCiAgICAgICAgaWYgYmF0dGVyeToKICAgICAgICAgICAgcmV0dXJuIGYie2JhdHRlcnkucGVyY2VudH0lIHJlbWFpbmluZyAocGx1Z2dlZCBpbjoge2JhdHRlcnkucG93ZXJfcGx1Z2dlZH0pIgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiAiTm8gYmF0dGVyeSBmb3VuZCIKICAgIGV4Y2VwdDoKICAgICAgICByZXR1cm4gIkVycm9yIHJldHJpZXZpbmcgYmF0dGVyeSBpbmZvIgoKZGVmIGdldF9ydW5uaW5nX3Rhc2tzKCk6CiAgICB0cnk6CiAgICAgICAgdGFza3MgPSBbXQogICAgICAgIGZvciBwcm9jIGluIHBzdXRpbC5wcm9jZXNzX2l0ZXIoWydwaWQnLCAnbmFtZSddKToKICAgICAgICAgICAgdGFza3MuYXBwZW5kKGYie3Byb2MuaW5mb1snbmFtZSddfSAoUElEOiB7cHJvYy5pbmZvWydwaWQnXX0pIikKICAgICAgICByZXR1cm4gdGFza3MgaWYgdGFza3MgZWxzZSBbIk5vIHRhc2tzIHJ1bm5pbmcuIl0KICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByZXR1cm4gW2YiRXJyb3IgZmV0Y2hpbmcgdGFza3M6IHtlfSJdCgpkZWYgY2hhbmdlX3dhbGxwYXBlcl93aW5kb3dzKGltYWdlX3BhdGgpOgogICAgdHJ5OgogICAgICAgIGN0eXBlcy53aW5kbGwudXNlcjMyLlN5c3RlbVBhcmFtZXRlcnNJbmZvVygyMCwgMCwgaW1hZ2VfcGF0aCwgMykKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAiIgoKZGVmIGlzX2FkbWluKCk6CiAgICByZXR1cm4gY3R5cGVzLndpbmRsbC5zaGVsbDMyLklzVXNlckFuQWRtaW4oKSAhPSAwCiAgICAKZGVmIGFza19mb3JfYWRtaW4oKToKICAgIGlmIGlzX2FkbWluKCk6CiAgICAgICAgcmV0dXJuIFRydWUKICAgIHJldHVybiBGYWxzZQoKZGVmIHRyaWdnZXJfdWFjKCk6CiAgICBpZiBub3QgaXNfYWRtaW4oKToKICAgICAgICBleGVfcGF0aCA9IHN5cy5hcmd2WzBdCgogICAgICAgIGFyZ3VtZW50cyA9ICIgIi5qb2luKHN5cy5hcmd2WzE6XSkKCiAgICAgICAgaWYgZXhlX3BhdGguZW5kc3dpdGgoIi5weSIpOgogICAgICAgICAgICBweXRob25fZXhlID0gc3lzLmV4ZWN1dGFibGUKICAgICAgICAgICAgcmVzdWx0ID0gY3R5cGVzLndpbmRsbC5zaGVsbDMyLlNoZWxsRXhlY3V0ZVcoCiAgICAgICAgICAgICAgICBOb25lLCAicnVuYXMiLCBweXRob25fZXhlLCBmJyJ7ZXhlX3BhdGh9IiB7YXJndW1lbnRzfScsIE5vbmUsIDEKICAgICAgICAgICAgKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJlc3VsdCA9IGN0eXBlcy53aW5kbGwuc2hlbGwzMi5TaGVsbEV4ZWN1dGVXKAogICAgICAgICAgICAgICAgTm9uZSwgInJ1bmFzIiwgZXhlX3BhdGgsIGFyZ3VtZW50cywgTm9uZSwgMQogICAgICAgICAgICApCgogICAgICAgIGlmIHJlc3VsdCA8PSAzMjoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIFRydWUKICAgIApkZWYgaHp6aCgpOgogICAgdHJ5OgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhoenpoX3BhdGgpOgogICAgICAgICAgICBzaHV0aWwuY29weShzY3JpcHRfcGF0aCwgaHp6aF9wYXRoKQogICAgZXhjZXB0OgogICAgICAgIHBhc3MKZGVmIGh6emh0ZW1wKCk6CiAgICB0cnk6CiAgICAgICAgc2h1dGlsLmNvcHkoc2NyaXB0X3BhdGgsIGh6emhfcGF0aDEpCiAgICBleGNlcHQ6CiAgICAgICAgcGFzcwpkZWYgaHp6aHJlZygpOgogICAgdHJ5OgogICAgICAgIHJlZ2lzdHJ5X2tleSA9IHJlZy5PcGVuS2V5KHJlZy5IS0VZX0NVUlJFTlRfVVNFUiwgciJTb2Z0d2FyZVxNaWNyb3NvZnRcV2luZG93c1xDdXJyZW50VmVyc2lvblxSdW4iLCAwLCByZWcuS0VZX1dSSVRFKQogICAgICAgIHJlZy5TZXRWYWx1ZUV4KHJlZ2lzdHJ5X2tleSwgIldpbmRvd3MgRGVmZW5kZXIiLCAwLCByZWcuUkVHX1NaLCBoenpoX3BhdGgpCiAgICAgICAgcmVnLkNsb3NlS2V5KHJlZ2lzdHJ5X2tleSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwYXNzCmRlZiBoenpoX3J1bm9uY2UoKToKICAgIHRyeToKICAgICAgICByZWdpc3RyeV9rZXkgPSByZWcuT3BlbktleShyZWcuSEtFWV9DVVJSRU5UX1VTRVIsIHIiU29mdHdhcmVcTWljcm9zb2Z0XFdpbmRvd3NcQ3VycmVudFZlcnNpb25cUnVuT25jZSIsIDAsIHJlZy5LRVlfV1JJVEUpCiAgICAgICAgcmVnLlNldFZhbHVlRXgocmVnaXN0cnlfa2V5LCAiV2luZG93cyBEZWZlbmRlciIsIDAsIHJlZy5SRUdfU1osIGh6emhfcGF0aDEpCiAgICAgICAgcmVnLkNsb3NlS2V5KHJlZ2lzdHJ5X2tleSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwYXNzCmRlZiBoenpoX3Rhc2tfc2NoZWR1bGVyKCk6CiAgICB0cnk6CiAgICAgICAgdGFza19uYW1lID0gIldpbmRvd3NEZWZlbmRlclRhc2siCiAgICAgICAgY29tbWFuZCA9IGYnc2NodGFza3MgL2NyZWF0ZSAvdG4gInt0YXNrX25hbWV9IiAvdHIgIntoenpoX3BhdGh9IiAvc2Mgb25sb2dvbiAvcmwgaGlnaGVzdCcKICAgICAgICBzdWJwcm9jZXNzLnJ1bihjb21tYW5kLCBzaGVsbD1UcnVlKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHBhc3MKCmRlZiBwcmV2ZW50X2Nsb3NlKCk6CiAgICBwYXNzCgpkZWYgc21vb3RoX21vdmVfd2luZG93KHJvb3QsIHN0YXJ0X3gsIHN0YXJ0X3ksIGVuZF94LCBlbmRfeSwgc3RlcHM9MjApOgogICAgZGVsdGFfeCA9IChlbmRfeCAtIHN0YXJ0X3gpIC8gc3RlcHMKICAgIGRlbHRhX3kgPSAoZW5kX3kgLSBzdGFydF95KSAvIHN0ZXBzCiAgICBmb3IgaSBpbiByYW5nZShzdGVwcyk6CiAgICAgICAgbmV3X3ggPSBpbnQoc3RhcnRfeCArIGRlbHRhX3ggKiAoaSArIDEpKQogICAgICAgIG5ld195ID0gaW50KHN0YXJ0X3kgKyBkZWx0YV95ICogKGkgKyAxKSkKICAgICAgICByb290Lmdlb21ldHJ5KGYie25ld194fXh7bmV3X3l9IikKICAgICAgICByb290LnVwZGF0ZSgpCiAgICAgICAgdGltZS5zbGVlcCgwLjAxKQoKZGVmIG1vdmVfd2luZG93X3JhbmRvbWx5KHJvb3QpOgogICAgaWYgcmFuZG9tLmNob2ljZShbVHJ1ZSwgRmFsc2VdKToKICAgICAgICBzY3JlZW5fd2lkdGggPSByb290LndpbmZvX3NjcmVlbndpZHRoKCkKICAgICAgICBzY3JlZW5faGVpZ2h0ID0gcm9vdC53aW5mb19zY3JlZW5oZWlnaHQoKQoKICAgICAgICBjdXJyZW50X2dlb21ldHJ5ID0gcm9vdC5nZW9tZXRyeSgpCiAgICAgICAgY3VycmVudF94ID0gaW50KGN1cnJlbnRfZ2VvbWV0cnkuc3BsaXQoJysnKVsxXSkKICAgICAgICBjdXJyZW50X3kgPSBpbnQoY3VycmVudF9nZW9tZXRyeS5zcGxpdCgnKycpWzJdKQoKICAgICAgICBuZXdfeCA9IHJhbmRvbS5yYW5kaW50KDAsIHNjcmVlbl93aWR0aCAtIHJvb3Qud2luZm9fd2lkdGgoKSkKICAgICAgICBuZXdfeSA9IHJhbmRvbS5yYW5kaW50KDAsIHNjcmVlbl9oZWlnaHQgLSByb290LndpbmZvX2hlaWdodCgpKQoKICAgICAgICBzbW9vdGhfbW92ZV93aW5kb3cocm9vdCwgY3VycmVudF94LCBjdXJyZW50X3ksIG5ld194LCBuZXdfeSkKICAgIAogICAgcm9vdC5hZnRlcihyYW5kb20ucmFuZGludCg1MDAsIDIwMDApLCBtb3ZlX3dpbmRvd19yYW5kb21seSwgcm9vdCkKCmRlZiBkb3dubG9hZF9pbWFnZShpbWFnZV91cmwpOgogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKHRlbXBfZm9sZGVyKToKICAgICAgICBvcy5tYWtlZGlycyh0ZW1wX2ZvbGRlcikKCiAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldChpbWFnZV91cmwsIHN0cmVhbT1UcnVlKQogICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgIT0gMjAwOgogICAgICAgIHJhaXNlIEV4Y2VwdGlvbihmIkZhaWxlZCB0byBkb3dubG9hZCBpbWFnZToge3Jlc3BvbnNlLnN0YXR1c19jb2RlfSIpCgogICAgZmlsZV9leHRlbnNpb24gPSBpbWFnZV91cmwuc3BsaXQoIi4iKVstMV0uc3BsaXQoIj8iKVswXS5sb3dlcigpCiAgICB2YWxpZF9leHRlbnNpb25zID0gWyJqcGciLCAianBlZyIsICJwbmciLCAiYm1wIiwgImdpZiIsICJ3ZWJwIl0KICAgIAogICAgaWYgZmlsZV9leHRlbnNpb24gbm90IGluIHZhbGlkX2V4dGVuc2lvbnM6CiAgICAgICAgZmlsZV9leHRlbnNpb24gPSAicG5nIgoKICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbih0ZW1wX2ZvbGRlciwgZiJmbG9hdGluZ19pbWFnZS57ZmlsZV9leHRlbnNpb259IikKCiAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAnd2InKSBhcyBmaWxlOgogICAgICAgIGZvciBjaHVuayBpbiByZXNwb25zZS5pdGVyX2NvbnRlbnQoMTAyNCk6CiAgICAgICAgICAgIGZpbGUud3JpdGUoY2h1bmspCgogICAgdHJ5OgogICAgICAgIHdpdGggSW1hZ2Uub3BlbihmaWxlX3BhdGgpIGFzIGltZzoKICAgICAgICAgICAgaW1nLnZlcmlmeSgpIAogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIG9zLnJlbW92ZShmaWxlX3BhdGgpIAogICAgICAgIHJhaXNlIEV4Y2VwdGlvbihmIkRvd25sb2FkZWQgZmlsZSBpcyBub3QgYSB2YWxpZCBpbWFnZToge2V9IikKCiAgICBpZiBmaWxlX2V4dGVuc2lvbiA9PSAid2VicCI6CiAgICAgICAgY29udmVydGVkX3BhdGggPSBvcy5wYXRoLmpvaW4odGVtcF9mb2xkZXIsICJmbG9hdGluZ19pbWFnZS5wbmciKQogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBJbWFnZS5vcGVuKGZpbGVfcGF0aCkgYXMgaW1nOgogICAgICAgICAgICAgICAgaW1nLmNvbnZlcnQoIlJHQkEiKS5zYXZlKGNvbnZlcnRlZF9wYXRoLCAiUE5HIikKICAgICAgICAgICAgZmlsZV9wYXRoID0gY29udmVydGVkX3BhdGggCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oZiJFcnJvciBjb252ZXJ0aW5nIFdlYlA6IHtlfSIpCgogICAgcmV0dXJuIGZpbGVfcGF0aAoKZGVmIGNyZWF0ZV93aW5kb3coZHVyYXRpb24sIGZpbGVfcGF0aCk6CiAgICBnbG9iYWwgRkxPQVRJTkdfV0lORE9XCiAgICBGTE9BVElOR19XSU5ET1cgPSB0ay5UaygpCiAgICBGTE9BVElOR19XSU5ET1cudGl0bGUoIkZsb2F0aW5nIEltYWdlIikKICAgIEZMT0FUSU5HX1dJTkRPVy5yZXNpemFibGUoRmFsc2UsIEZhbHNlKQogICAgRkxPQVRJTkdfV0lORE9XLm92ZXJyaWRlcmVkaXJlY3QoVHJ1ZSkKICAgIEZMT0FUSU5HX1dJTkRPVy5hdHRyaWJ1dGVzKCctdG9wbW9zdCcsIDEpCgogICAgdHJ5OgogICAgICAgIGltYWdlID0gSW1hZ2Uub3BlbihmaWxlX3BhdGgpLmNvbnZlcnQoIlJHQkEiKSAgCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgIiIKICAgICAgICByZXR1cm4KICAgIAogICAgd2lkdGgsIGhlaWdodCA9IGltYWdlLnNpemUgIAogICAgRkxPQVRJTkdfV0lORE9XLmdlb21ldHJ5KGYie3dpZHRofXh7aGVpZ2h0fSIpIAoKICAgIHBob3RvID0gSW1hZ2VUay5QaG90b0ltYWdlKGltYWdlKQogICAgbGFiZWwgPSB0ay5MYWJlbChGTE9BVElOR19XSU5ET1csIGltYWdlPXBob3RvKQogICAgbGFiZWwuaW1hZ2UgPSBwaG90bwogICAgbGFiZWwucGFjaygpCgogICAgRkxPQVRJTkdfV0lORE9XLnByb3RvY29sKCJXTV9ERUxFVEVfV0lORE9XIiwgcHJldmVudF9jbG9zZSkKICAgIG1vdmVfd2luZG93X3JhbmRvbWx5KEZMT0FUSU5HX1dJTkRPVykKICAgIAogICAgdGhyZWFkaW5nLlRpbWVyKGR1cmF0aW9uLCBGTE9BVElOR19XSU5ET1cuZGVzdHJveSkuc3RhcnQoKQogICAgRkxPQVRJTkdfV0lORE9XLm1haW5sb29wKCkKCmRlZiB3YWl0X2Zvcl93aWZpKCk6CiAgICB3aGlsZSBUcnVlOgogICAgICAgIHRyeToKICAgICAgICAgICAgc29ja2V0LmNyZWF0ZV9jb25uZWN0aW9uKCgiOC44LjguOCIsIDUzKSwgdGltZW91dD01KQogICAgICAgICAgICBwcmludChGb3JlLkdSRUVOICsgIltTVUNDRVNTXSBGb3VuZCBXaS1GaSIgKyBGb3JlLlJFU0VUKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBleGNlcHQgKHNvY2tldC50aW1lb3V0LCBzb2NrZXQuZXJyb3IpOgogICAgICAgICAgICBwcmludChGb3JlLkJMVUUgKyAiW0lORk9dIFdhaXRpbmcgZm9yIFdpLUZpIiArIEZvcmUuR1JFRU4pCiAgICAgICAgICAgIHRpbWUuc2xlZXAoNSkKCkBib3QuZXZlbnQKYXN5bmMgZGVmIG9uX3JlYWR5KCk6CiAgICBndWlsZCA9IGJvdC5ndWlsZHNbMF0gCiAgICBzeXN0ZW1faW5mbyA9IGdldF9zeXN0ZW1faW5mbygpCiAgICBwY19uYW1lID0gc3lzdGVtX2luZm8uZ2V0KCJQQyBOYW1lIiwgIlVua25vd24tUEMiKQoKICAgIGFjdGl2aXR5ID0gZGlzY29yZC5BY3Rpdml0eSh0eXBlPWRpc2NvcmQuQWN0aXZpdHlUeXBlLndhdGNoaW5nLCBuYW1lPSJvbiByYW5kb20ga2lkcyB8ICFoZWxwIikKICAgIGF3YWl0IGJvdC5jaGFuZ2VfcHJlc2VuY2Uoc3RhdHVzPWRpc2NvcmQuU3RhdHVzLm9ubGluZSwgYWN0aXZpdHk9YWN0aXZpdHkpCgogICAgZXhpc3RpbmdfY2hhbm5lbCA9IGRpc2NvcmQudXRpbHMuZ2V0KGd1aWxkLmNoYW5uZWxzLCBuYW1lPXBjX25hbWUubG93ZXIoKSkKICAgIGlmIGV4aXN0aW5nX2NoYW5uZWw6CiAgICAgICAgcHJpbnQoZiJDaGFubmVsIGZvciB7cGNfbmFtZX0gYWxyZWFkeSBleGlzdHMuIikKICAgICAgICBhd2FpdCBleGlzdGluZ19jaGFubmVsLnNlbmQoZW1iZWQ9ZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLwn5CAICoqW0gtenotSF0gT2xkIFZpY3RpbSoqIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiKipQQyBOYW1lOiDwn5al77iPKioge3N5c3RlbV9pbmZvWydQQyBOYW1lJ119XG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmIioqUHJpdmF0ZSBJUDog8J+MkCoqIHtzeXN0ZW1faW5mb1snSVAgQWRkcmVzcyddfVxuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZiIqKkdlb2xvY2F0aW9uOiDwn5ONKioge3N5c3RlbV9pbmZvWydHZW9sb2NhdGlvbiddfVxuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZiIqKlN5c3RlbSBWZXJzaW9uOiDwn5ax77iPKioge3N5c3RlbV9pbmZvWydTeXN0ZW0gVmVyc2lvbiddfVxuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZiIqKkNQVSBVc2FnZTog4pqZ77iPKioge3N5c3RlbV9pbmZvWydDUFUgVXNhZ2UnXX1cbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYiKipNZW1vcnkgVXNhZ2U6IPCfkr4qKiB7c3lzdGVtX2luZm9bJ01lbW9yeSBVc2FnZSddfVxuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZiIqKkRpc2sgVXNhZ2U6IPCfl4LvuI8qKiB7c3lzdGVtX2luZm9bJ0Rpc2sgSW5mbyddfVxuXG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiTWFkZSB3aXRoIOKdpCBieSBILXp6LUguIiwKICAgICAgICAgICAgICAgIGNvbG9yPTB4MDBmZjAwCiAgICAgICAgKSkKICAgIGVsc2U6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBuZXdfY2hhbm5lbCA9IGF3YWl0IGd1aWxkLmNyZWF0ZV90ZXh0X2NoYW5uZWwobmFtZT1wY19uYW1lLmxvd2VyKCkpCiAgICAgICAgICAgIGF3YWl0IG5ld19jaGFubmVsLnNlbmQoZW1iZWQ9ZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLwn5CAICoqW0gtenotSF0gTmV3IFZpY3RpbSoqIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiKipQQyBOYW1lOiDwn5al77iPKioge3N5c3RlbV9pbmZvWydQQyBOYW1lJ119XG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmIioqSVAgQWRkcmVzczog8J+MkCoqIHtzeXN0ZW1faW5mb1snSVAgQWRkcmVzcyddfVxuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZiIqKkdlb2xvY2F0aW9uOiDwn5ONKioge3N5c3RlbV9pbmZvWydHZW9sb2NhdGlvbiddfVxuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZiIqKlN5c3RlbSBWZXJzaW9uOiDwn5ax77iPKioge3N5c3RlbV9pbmZvWydTeXN0ZW0gVmVyc2lvbiddfVxuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZiIqKkNQVSBVc2FnZTog4pqZ77iPKioge3N5c3RlbV9pbmZvWydDUFUgVXNhZ2UnXX1cbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYiKipNZW1vcnkgVXNhZ2U6IPCfkr4qKiB7c3lzdGVtX2luZm9bJ01lbW9yeSBVc2FnZSddfVxuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZiIqKkRpc2sgVXNhZ2U6IPCfl4LvuI8qKiB7c3lzdGVtX2luZm9bJ0Rpc2sgSW5mbyddfVxuXG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiTWFkZSB3aXRoIOKdpCBieSBILXp6LUguIiwKICAgICAgICAgICAgICAgIGNvbG9yPTB4MDBmZjAwCiAgICAgICAgICAgICkpCiAgICAgICAgICAgIHByaW50KGYiQ2hhbm5lbCAne3BjX25hbWV9JyBjcmVhdGVkIGFuZCBpbmZvcm1hdGlvbiBzZW50LiIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkZhaWxlZCB0byBjcmVhdGUgY2hhbm5lbCBmb3Ige3BjX25hbWV9OiB7ZX0iKQoKQGJvdC5ldmVudAphc3luYyBkZWYgb25fbWVzc2FnZShtZXNzYWdlKToKICAgIGlmIG1lc3NhZ2UuYXV0aG9yID09IGJvdC51c2VyOgogICAgICAgIHJldHVybiAgCiAgICAKICAgIHBjX25hbWUgPSBnZXRfc3lzdGVtX2luZm8oKS5nZXQoIlBDIE5hbWUiLCAiVW5rbm93bi1QQyIpCiAgICAKICAgIGlmIG1lc3NhZ2UuY2hhbm5lbC5uYW1lLmxvd2VyKCkgIT0gcGNfbmFtZS5sb3dlcigpIGFuZCBtZXNzYWdlLmNoYW5uZWwubmFtZS5sb3dlcigpICE9ICJib3RuZXQiOgogICAgICAgIGlmIG1lc3NhZ2UuY29udGVudC5zdGFydHN3aXRoKCIhYm90bmV0Iik6CiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLimqEgQm90bmV0IiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPSLimqEgVGhlICFib3RuZXQgY29tbWFuZCBpcyBvbmx5IGF2YWlsYWJsZSBpbiB0aGUgI2JvdG5ldCBjaGFubmVsLiIsCiAgICAgICAgICAgICAgICBjb2xvcj0weEZGMDAwMAogICAgICAgICAgICApCiAgICAgICAgICAgIGF3YWl0IG1lc3NhZ2UuY2hhbm5lbC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgIHJldHVybgogICAgCiAgICBpZiBtZXNzYWdlLmNoYW5uZWwubmFtZS5sb3dlcigpID09ICJib3RuZXQiOgogICAgICAgIGlmIG5vdCAobWVzc2FnZS5jb250ZW50LnN0YXJ0c3dpdGgoIiFib3RuZXQiKSBvciBtZXNzYWdlLmNvbnRlbnQuc3RhcnRzd2l0aCgiIWJvdG5ldF9zdG9wIikgb3IgbWVzc2FnZS5jb250ZW50LnN0YXJ0c3dpdGgoIiFoZWxwIikgb3IgbWVzc2FnZS5jb250ZW50LnN0YXJ0c3dpdGgoIiFyZWNyZWF0ZSIpIG9yIG1lc3NhZ2UuY29udGVudC5zdGFydHN3aXRoKCIhcHVyZ2UiKSk6IAogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i4pqhIEJvdG5ldCIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj1mIuKaoSBQbGVhc2Ugb25seSB1c2UgIWJvdG5ldCBjb21tYW5kcyBoZXJlISB8IFNlbmQgYnk6ICN7cGNfbmFtZS5sb3dlcigpfSIsCiAgICAgICAgICAgICAgICBjb2xvcj0weEZGREQwMAogICAgICAgICAgICApCiAgICAgICAgICAgIGF3YWl0IG1lc3NhZ2UuY2hhbm5lbC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgICAgICByZXR1cm4KCiAgICBhd2FpdCBib3QucHJvY2Vzc19jb21tYW5kcyhtZXNzYWdlKQoKZGVmIENhcHR1cmVXZWJjYW0oaW5kZXg6IGludCwgZmlsZVBhdGg6IHN0cikgLT4gYm9vbDoKICAgIGF2aWNhcDMyID0gY3R5cGVzLndpbmRsbC5hdmljYXAzMgogICAgV1NfQ0hJTEQgPSAweDQwMDAwMDAwCiAgICBXTV9DQVBfRFJJVkVSX0NPTk5FQ1QgPSAweDA0MDAgKyAxMAogICAgV01fQ0FQX0RSSVZFUl9ESVNDT05ORUNUID0gMHgwNDAyCiAgICBXTV9DQVBfRklMRV9TQVZFRElCID0gMHgwNDAwICsgMTAwICsgMjUKCiAgICBoY2FtID0gYXZpY2FwMzIuY2FwQ3JlYXRlQ2FwdHVyZVdpbmRvd1coCiAgICAgICAgY3R5cGVzLndpbnR5cGVzLkxQV1NUUigiQmxhbmsiKSwKICAgICAgICBXU19DSElMRCwKICAgICAgICAwLCAwLCAwLCAwLAogICAgICAgIGN0eXBlcy53aW5kbGwudXNlcjMyLkdldERlc2t0b3BXaW5kb3coKSwgMAogICAgKQoKICAgIHJlc3VsdCA9IEZhbHNlCgogICAgaWYgaGNhbToKICAgICAgICBpZiBjdHlwZXMud2luZGxsLnVzZXIzMi5TZW5kTWVzc2FnZUEoaGNhbSwgV01fQ0FQX0RSSVZFUl9DT05ORUNULCBpbmRleCwgMCk6CiAgICAgICAgICAgIGlmIGN0eXBlcy53aW5kbGwudXNlcjMyLlNlbmRNZXNzYWdlQShoY2FtLCBXTV9DQVBfRklMRV9TQVZFRElCLCAwLCBjdHlwZXMud2ludHlwZXMuTFBXU1RSKGZpbGVQYXRoKSk6CiAgICAgICAgICAgICAgICByZXN1bHQgPSBUcnVlCiAgICAgICAgICAgIGN0eXBlcy53aW5kbGwudXNlcjMyLlNlbmRNZXNzYWdlQShoY2FtLCBXTV9DQVBfRFJJVkVSX0RJU0NPTk5FQ1QsIDAsIDApCiAgICAgICAgY3R5cGVzLndpbmRsbC51c2VyMzIuRGVzdHJveVdpbmRvdyhoY2FtKQoKICAgIHJldHVybiByZXN1bHQKCmRlZiBDcmVhdGVNdXRleChtdXRleDogc3RyKSAtPiBib29sOgogICAga2VybmVsMzIgPSBjdHlwZXMud2luZGxsLmtlcm5lbDMyCiAgICBtdXRleCA9IGtlcm5lbDMyLkNyZWF0ZU11dGV4QShOb25lLCBGYWxzZSwgbXV0ZXgpCiAgICByZXR1cm4ga2VybmVsMzIuR2V0TGFzdEVycm9yKCkgIT0gMTgzCgpkZWYgQ3J5cHRVbnByb3RlY3REYXRhKGVuY3J5cHRlZF9kYXRhOiBieXRlcywgb3B0aW9uYWxfZW50cm9weTogc3RyID0gTm9uZSkgLT4gYnl0ZXM6CiAgICBjbGFzcyBEQVRBX0JMT0IoY3R5cGVzLlN0cnVjdHVyZSk6CiAgICAgICAgX2ZpZWxkc18gPSBbCiAgICAgICAgICAgICgiY2JEYXRhIiwgY3R5cGVzLmNfdWxvbmcpLAogICAgICAgICAgICAoInBiRGF0YSIsIGN0eXBlcy5QT0lOVEVSKGN0eXBlcy5jX3VieXRlKSkKICAgICAgICBdCgogICAgcERhdGFJbiA9IERBVEFfQkxPQihsZW4oZW5jcnlwdGVkX2RhdGEpLCBjdHlwZXMuY2FzdChlbmNyeXB0ZWRfZGF0YSwgY3R5cGVzLlBPSU5URVIoY3R5cGVzLmNfdWJ5dGUpKSkKICAgIHBEYXRhT3V0ID0gREFUQV9CTE9CKCkKICAgIHBPcHRpb25hbEVudHJvcHkgPSBOb25lCgogICAgaWYgb3B0aW9uYWxfZW50cm9weSBpcyBub3QgTm9uZToKICAgICAgICBvcHRpb25hbF9lbnRyb3B5ID0gb3B0aW9uYWxfZW50cm9weS5lbmNvZGUoInV0Zi0xNiIpCiAgICAgICAgcE9wdGlvbmFsRW50cm9weSA9IERBVEFfQkxPQihsZW4ob3B0aW9uYWxfZW50cm9weSksIGN0eXBlcy5jYXN0KG9wdGlvbmFsX2VudHJvcHksIGN0eXBlcy5QT0lOVEVSKGN0eXBlcy5jX3VieXRlKSkpCgogICAgaWYgY3R5cGVzLndpbmRsbC5DcnlwdDMyLkNyeXB0VW5wcm90ZWN0RGF0YShjdHlwZXMuYnlyZWYocERhdGFJbiksIE5vbmUsIGN0eXBlcy5ieXJlZihwT3B0aW9uYWxFbnRyb3B5KSBpZiBwT3B0aW9uYWxFbnRyb3B5IGlzIG5vdCBOb25lIGVsc2UgTm9uZSwgTm9uZSwgTm9uZSwgMCwgY3R5cGVzLmJ5cmVmKHBEYXRhT3V0KSk6CiAgICAgICAgZGF0YSA9IChjdHlwZXMuY191Ynl0ZSAqIHBEYXRhT3V0LmNiRGF0YSkoKQogICAgICAgIGN0eXBlcy5tZW1tb3ZlKGRhdGEsIHBEYXRhT3V0LnBiRGF0YSwgcERhdGFPdXQuY2JEYXRhKQogICAgICAgIGN0eXBlcy53aW5kbGwuS2VybmVsMzIuTG9jYWxGcmVlKHBEYXRhT3V0LnBiRGF0YSkKICAgICAgICByZXR1cm4gYnl0ZXMoZGF0YSkKCiAgICByYWlzZSBWYWx1ZUVycm9yKCJJbnZhbGlkIGVuY3J5cHRlZF9kYXRhIHByb3ZpZGVkISIpCgpkZWYgSGlkZUNvbnNvbGUoKSAtPiBOb25lOgogICAgY3R5cGVzLndpbmRsbC51c2VyMzIuU2hvd1dpbmRvdyhjdHlwZXMud2luZGxsLmtlcm5lbDMyLkdldENvbnNvbGVXaW5kb3coKSwgMCkKCmRlZiBHZXRIZWFkZXJzKHRva2VuOiBzdHIgPSBOb25lKSAtPiBkaWN0OgogICAgaGVhZGVycyA9IHsKICAgICAgICAiY29udGVudC10eXBlIjogImFwcGxpY2F0aW9uL2pzb24iLAogICAgICAgICJ1c2VyLWFnZW50IjogIk1vemlsbGEvNS4wIChNYWNpbnRvc2g7IEludGVsIE1hYyBPUyBYIDEwXzE1KSBBcHBsZVdlYktpdC81MzcuMzYgKEtIVE1MLCBsaWtlIEdlY2tvKSBDaHJvbWUvOTMuMC40NTkzLjEyMiBTYWZhcmkvNTM3LjM2IgogICAgfQogICAgaWYgdG9rZW46CiAgICAgICAgaGVhZGVyc1siYXV0aG9yaXphdGlvbiJdID0gdG9rZW4KICAgIHJldHVybiBoZWFkZXJzCgpkZWYgR2V0VG9rZW5zKCk6CiAgICByZXN1bHRzID0gW10KICAgIHRva2VucyA9IFtdCiAgICBwYXRocyA9IGdldF9wYXRocygpCgogICAgZm9yIG5hbWUsIHBhdGggaW4gcGF0aHMuaXRlbXMoKToKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhwYXRoKToKICAgICAgICAgICAgdG9rZW5zICs9IFNhZmVTdG9yYWdlU3RlYWwocGF0aCkKICAgICAgICAgICAgdG9rZW5zICs9IFNpbXBsZVN0ZWFsKHBhdGgpCiAgICAgICAgICAgIGlmICJGaXJlRm94IiBpbiBuYW1lOgogICAgICAgICAgICAgICAgdG9rZW5zICs9IEZpcmVGb3hTdGVhbChwYXRoKQoKICAgIHJldHVybiB0b2tlbnMKCmRlZiBTYWZlU3RvcmFnZVN0ZWFsKHBhdGg6IHN0cikgLT4gbGlzdFtzdHJdOgogICAgZW5jcnlwdGVkVG9rZW5zID0gW10KICAgIHRva2VucyA9IFtdCiAgICBrZXkgPSBOb25lCiAgICBsZXZlbERiUGF0aHMgPSBbXQoKICAgIGxvY2FsU3RhdGVQYXRoID0gb3MucGF0aC5qb2luKHBhdGgsICJMb2NhbCBTdGF0ZSIpCgogICAgZm9yIHJvb3QsIGRpcnMsIF8gaW4gb3Mud2FsayhwYXRoKToKICAgICAgICBmb3IgZGlyIGluIGRpcnM6CiAgICAgICAgICAgIGlmIGRpciA9PSAibGV2ZWxkYiI6CiAgICAgICAgICAgICAgICBsZXZlbERiUGF0aHMuYXBwZW5kKG9zLnBhdGguam9pbihyb290LCBkaXIpKQoKICAgIGlmIG9zLnBhdGguaXNmaWxlKGxvY2FsU3RhdGVQYXRoKSBhbmQgbGV2ZWxEYlBhdGhzOgogICAgICAgIHdpdGggb3Blbihsb2NhbFN0YXRlUGF0aCwgZXJyb3JzPSJpZ25vcmUiKSBhcyBmaWxlOgogICAgICAgICAgICBqc29uQ29udGVudCA9IGpzb24ubG9hZChmaWxlKQoKICAgICAgICBrZXkgPSBqc29uQ29udGVudFsnb3NfY3J5cHQnXVsnZW5jcnlwdGVkX2tleSddCiAgICAgICAga2V5ID0gYmFzZTY0LmI2NGRlY29kZShrZXkpWzU6XQoKICAgICAgICBmb3IgbGV2ZWxEYlBhdGggaW4gbGV2ZWxEYlBhdGhzOgogICAgICAgICAgICBmb3IgZmlsZSBpbiBvcy5saXN0ZGlyKGxldmVsRGJQYXRoKToKICAgICAgICAgICAgICAgIGlmIGZpbGUuZW5kc3dpdGgoKCIubG9nIiwgIi5sZGIiKSk6CiAgICAgICAgICAgICAgICAgICAgZmlsZXBhdGggPSBvcy5wYXRoLmpvaW4obGV2ZWxEYlBhdGgsIGZpbGUpCiAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVwYXRoLCBlcnJvcnM9Imlnbm9yZSIpIGFzIGZpbGU6CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzID0gZmlsZS5yZWFkbGluZXMoKQoKICAgICAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGluZS5zdHJpcCgpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlcyA9IHJlLmZpbmRhbGwoUkVHRVhfRU5DLCBsaW5lKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIG1hdGNoIGluIG1hdGNoZXM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBtYXRjaC5yc3RyaXAoIlxcIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBtYXRjaCBub3QgaW4gZW5jcnlwdGVkVG9rZW5zOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IG1hdGNoLnNwbGl0KCJkUXc0dzlXZ1hjUToiKVsxXS5lbmNvZGUoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaXNzaW5nX3BhZGRpbmcgPSA0IC0gKGxlbihtYXRjaCkgJSA0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBtaXNzaW5nX3BhZGRpbmc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCArPSBiJz0nICogbWlzc2luZ19wYWRkaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoID0gYmFzZTY0LmI2NGRlY29kZShtYXRjaCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5jcnlwdGVkVG9rZW5zLmFwcGVuZChtYXRjaCkKCiAgICBmb3IgdG9rZW4gaW4gZW5jcnlwdGVkVG9rZW5zOgogICAgICAgIHRyeToKICAgICAgICAgICAgdG9rZW4gPSBweWFlcy5BRVNNb2RlT2ZPcGVyYXRpb25HQ00oQ3J5cHRVbnByb3RlY3REYXRhKGtleSksIHRva2VuWzM6MTVdKS5kZWNyeXB0KHRva2VuWzE1Ol0pWzotMTZdLmRlY29kZShlcnJvcnM9Imlnbm9yZSIpCiAgICAgICAgICAgIGlmIHRva2VuOgogICAgICAgICAgICAgICAgdG9rZW5zLmFwcGVuZCh0b2tlbikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgcmV0dXJuIHRva2VucwoKZGVmIFNpbXBsZVN0ZWFsKHBhdGg6IHN0cikgLT4gbGlzdFtzdHJdOgogICAgdG9rZW5zID0gW10KICAgIGxldmVsRGJQYXRocyA9IFtdCgogICAgZm9yIHJvb3QsIGRpcnMsIF8gaW4gb3Mud2FsayhwYXRoKToKICAgICAgICBmb3IgZGlyIGluIGRpcnM6CiAgICAgICAgICAgIGlmIGRpciA9PSAibGV2ZWxkYiI6CiAgICAgICAgICAgICAgICBsZXZlbERiUGF0aHMuYXBwZW5kKG9zLnBhdGguam9pbihyb290LCBkaXIpKQoKICAgIGZvciBsZXZlbERiUGF0aCBpbiBsZXZlbERiUGF0aHM6CiAgICAgICAgZm9yIGZpbGUgaW4gb3MubGlzdGRpcihsZXZlbERiUGF0aCk6CiAgICAgICAgICAgIGlmIGZpbGUuZW5kc3dpdGgoKCIubG9nIiwgIi5sZGIiKSk6CiAgICAgICAgICAgICAgICBmaWxlcGF0aCA9IG9zLnBhdGguam9pbihsZXZlbERiUGF0aCwgZmlsZSkKICAgICAgICAgICAgICAgIHdpdGggb3BlbihmaWxlcGF0aCwgZXJyb3JzPSJpZ25vcmUiKSBhcyBmaWxlOgogICAgICAgICAgICAgICAgICAgIGxpbmVzID0gZmlsZS5yZWFkbGluZXMoKQoKICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGxpbmVzOgogICAgICAgICAgICAgICAgICAgIGlmIGxpbmUuc3RyaXAoKToKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlcyA9IHJlLmZpbmRhbGwoUkVHRVgsIGxpbmUuc3RyaXAoKSkKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIG1hdGNoIGluIG1hdGNoZXM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IG1hdGNoLnJzdHJpcCgiXFwiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IG1hdGNoIGluIHRva2VuczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMuYXBwZW5kKG1hdGNoKQoKICAgIHJldHVybiB0b2tlbnMKCmRlZiBGaXJlRm94U3RlYWwocGF0aDogc3RyKSAtPiBsaXN0W3N0cl06CiAgICB0b2tlbnMgPSBbXQoKICAgIGZvciByb290LCBfLCBmaWxlcyBpbiBvcy53YWxrKHBhdGgpOgogICAgICAgIGZvciBmaWxlIGluIGZpbGVzOgogICAgICAgICAgICBpZiBmaWxlLmxvd2VyKCkuZW5kc3dpdGgoIi5zcWxpdGUiKToKICAgICAgICAgICAgICAgIGZpbGVwYXRoID0gb3MucGF0aC5qb2luKHJvb3QsIGZpbGUpCiAgICAgICAgICAgICAgICB3aXRoIG9wZW4oZmlsZXBhdGgsIGVycm9ycz0iaWdub3JlIikgYXMgZmlsZToKICAgICAgICAgICAgICAgICAgICBsaW5lcyA9IGZpbGUucmVhZGxpbmVzKCkKCiAgICAgICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxpbmUuc3RyaXAoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZXMgPSByZS5maW5kYWxsKFJFR0VYLCBsaW5lKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIG1hdGNoIGluIG1hdGNoZXM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBtYXRjaC5yc3RyaXAoIlxcIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBub3QgbWF0Y2ggaW4gdG9rZW5zOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMuYXBwZW5kKG1hdGNoKQoKICAgIHJldHVybiB0b2tlbnMKCmRlZiBnZXRfcGF0aHMoKToKICAgIHJldHVybiB7CiAgICAgICAgIkRpc2NvcmQiOiBvcy5wYXRoLmpvaW4oQVBQREFUQSwgImRpc2NvcmQiKSwKICAgICAgICAiRGlzY29yZCBDYW5hcnkiOiBvcy5wYXRoLmpvaW4oQVBQREFUQSwgImRpc2NvcmRjYW5hcnkiKSwKICAgICAgICAiTGlnaHRjb3JkIjogb3MucGF0aC5qb2luKEFQUERBVEEsICJMaWdodGNvcmQiKSwKICAgICAgICAiRGlzY29yZCBQVEIiOiBvcy5wYXRoLmpvaW4oQVBQREFUQSwgImRpc2NvcmRwdGIiKSwKICAgICAgICAiT3BlcmEiOiBvcy5wYXRoLmpvaW4oQVBQREFUQSwgIk9wZXJhIFNvZnR3YXJlIiwgIk9wZXJhIFN0YWJsZSIpLAogICAgICAgICJPcGVyYSBHWCI6IG9zLnBhdGguam9pbihBUFBEQVRBLCAiT3BlcmEgU29mdHdhcmUiLCAiT3BlcmEgR1ggU3RhYmxlIiksCiAgICAgICAgIkFtaWdvIjogb3MucGF0aC5qb2luKExPQ0FMQVBQREFUQSwgIkFtaWdvIiwgIlVzZXIgRGF0YSIpLAogICAgICAgICJUb3JjaCI6IG9zLnBhdGguam9pbihMT0NBTEFQUERBVEEsICJUb3JjaCIsICJVc2VyIERhdGEiKSwKICAgICAgICAiS29tZXRhIjogb3MucGF0aC5qb2luKExPQ0FMQVBQREFUQSwgIktvbWV0YSIsICJVc2VyIERhdGEiKSwKICAgICAgICAiT3JiaXR1bSI6IG9zLnBhdGguam9pbihMT0NBTEFQUERBVEEsICJPcmJpdHVtIiwgIlVzZXIgRGF0YSIpLAogICAgICAgICJDZW50QnJvd3NlIjogb3MucGF0aC5qb2luKExPQ0FMQVBQREFUQSwgIkNlbnRCcm93c2VyIiwgIlVzZXIgRGF0YSIpLAogICAgICAgICI3U3RhIjogb3MucGF0aC5qb2luKExPQ0FMQVBQREFUQSwgIjdTdGFyIiwgIjdTdGFyIiwgIlVzZXIgRGF0YSIpLAogICAgICAgICJTcHV0bmlrIjogb3MucGF0aC5qb2luKExPQ0FMQVBQREFUQSwgIlNwdXRuaWsiLCAiU3B1dG5payIsICJVc2VyIERhdGEiKSwKICAgICAgICAiVml2YWxkaSI6IG9zLnBhdGguam9pbihMT0NBTEFQUERBVEEsICJWaXZhbGRpIiwgIlVzZXIgRGF0YSIpLAogICAgICAgICJDaHJvbWUgU3hTIjogb3MucGF0aC5qb2luKExPQ0FMQVBQREFUQSwgIkdvb2dsZSIsICJDaHJvbWUgU3hTIiwgIlVzZXIgRGF0YSIpLAogICAgICAgICJDaHJvbWUiOiBvcy5wYXRoLmpvaW4oTE9DQUxBUFBEQVRBLCAiR29vZ2xlIiwgIkNocm9tZSIsICJVc2VyIERhdGEiKSwKICAgICAgICAiRmlyZUZveCI6IG9zLnBhdGguam9pbihBUFBEQVRBLCAiTW96aWxsYSIsICJGaXJlZm94IiwgIlByb2ZpbGVzIiksCiAgICAgICAgIkVwaWMgUHJpdmFjeSBCcm93c2UiOiBvcy5wYXRoLmpvaW4oTE9DQUxBUFBEQVRBLCAiRXBpYyBQcml2YWN5IEJyb3dzZXIiLCAiVXNlciBEYXRhIiksCiAgICAgICAgIk1pY3Jvc29mdCBFZGdlIjogb3MucGF0aC5qb2luKExPQ0FMQVBQREFUQSwgIk1pY3Jvc29mdCIsICJFZGdlIiwgIlVzZXIgRGF0YSIpLAogICAgICAgICJVcmFuIjogb3MucGF0aC5qb2luKExPQ0FMQVBQREFUQSwgInVDb3pNZWRpYSIsICJVcmFuIiwgIlVzZXIgRGF0YSIpLAogICAgICAgICJZYW5kZXgiOiBvcy5wYXRoLmpvaW4oTE9DQUxBUFBEQVRBLCAiWWFuZGV4IiwgIllhbmRleEJyb3dzZXIiLCAiVXNlciBEYXRhIiksCiAgICAgICAgIkJyYXZlIjogb3MucGF0aC5qb2luKExPQ0FMQVBQREFUQSwgIkJyYXZlU29mdHdhcmUiLCAiQnJhdmUtQnJvd3NlciIsICJVc2VyIERhdGEiKQogICAgfQoKYnJvd3NlcnMgPSB7CiAgICAnYXZhc3QnOiBMT0NBTEFQUERBVEEgKyAnXFxBVkFTVCBTb2Z0d2FyZVxcQnJvd3NlclxcVXNlciBEYXRhJywKICAgICdhbWlnbyc6IExPQ0FMQVBQREFUQSArICdcXEFtaWdvXFxVc2VyIERhdGEnLAogICAgJ3RvcmNoJzogTE9DQUxBUFBEQVRBICsgJ1xcVG9yY2hcXFVzZXIgRGF0YScsCiAgICAna29tZXRhJzogTE9DQUxBUFBEQVRBICsgJ1xcS29tZXRhXFxVc2VyIERhdGEnLAogICAgJ29yYml0dW0nOiBMT0NBTEFQUERBVEEgKyAnXFxPcmJpdHVtXFxVc2VyIERhdGEnLAogICAgJ2NlbnQtYnJvd3Nlcic6IExPQ0FMQVBQREFUQSArICdcXENlbnRCcm93c2VyXFxVc2VyIERhdGEnLAogICAgJzdzdGFyJzogTE9DQUxBUFBEQVRBICsgJ1xcN1N0YXJcXDdTdGFyXFxVc2VyIERhdGEnLAogICAgJ3NwdXRuaWsnOiBMT0NBTEFQUERBVEEgKyAnXFxTcHV0bmlrXFxTcHV0bmlrXFxVc2VyIERhdGEnLAogICAgJ3ZpdmFsZGknOiBMT0NBTEFQUERBVEEgKyAnXFxWaXZhbGRpXFxVc2VyIERhdGEnLAogICAgJ2Nocm9taXVtJzogTE9DQUxBUFBEQVRBICsgJ1xcQ2hyb21pdW1cXFVzZXIgRGF0YScsCiAgICAnY2hyb21lLWNhbmFyeSc6IExPQ0FMQVBQREFUQSArICdcXEdvb2dsZVxcQ2hyb21lIFN4U1xcVXNlciBEYXRhJywKICAgICdjaHJvbWUnOiBMT0NBTEFQUERBVEEgKyAnXFxHb29nbGVcXENocm9tZVxcVXNlciBEYXRhJywKICAgICdlcGljLXByaXZhY3ktYnJvd3Nlcic6IExPQ0FMQVBQREFUQSArICdcXEVwaWMgUHJpdmFjeSBCcm93c2VyXFxVc2VyIERhdGEnLAogICAgJ21zZWRnZSc6IExPQ0FMQVBQREFUQSArICdcXE1pY3Jvc29mdFxcRWRnZVxcVXNlciBEYXRhJywKICAgICdtc2VkZ2UtY2FuYXJ5JzogTE9DQUxBUFBEQVRBICsgJ1xcTWljcm9zb2Z0XFxFZGdlIFN4U1xcVXNlciBEYXRhJywKICAgICdtc2VkZ2UtYmV0YSc6IExPQ0FMQVBQREFUQSArICdcXE1pY3Jvc29mdFxcRWRnZSBCZXRhXFxVc2VyIERhdGEnLAogICAgJ21zZWRnZS1kZXYnOiBMT0NBTEFQUERBVEEgKyAnXFxNaWNyb3NvZnRcXEVkZ2UgRGV2XFxVc2VyIERhdGEnLAogICAgJ3VyYW4nOiBMT0NBTEFQUERBVEEgKyAnXFx1Q296TWVkaWFcXFVyYW5cXFVzZXIgRGF0YScsCiAgICAneWFuZGV4JzogTE9DQUxBUFBEQVRBICsgJ1xcWWFuZGV4XFxZYW5kZXhCcm93c2VyXFxVc2VyIERhdGEnLAogICAgJ2JyYXZlJzogTE9DQUxBUFBEQVRBICsgJ1xcQnJhdmVTb2Z0d2FyZVxcQnJhdmUtQnJvd3NlclxcVXNlciBEYXRhJywKICAgICdpcmlkaXVtJzogTE9DQUxBUFBEQVRBICsgJ1xcSXJpZGl1bVxcVXNlciBEYXRhJywKICAgICdjb2Njb2MnOiBMT0NBTEFQUERBVEEgKyAnXFxDb2NDb2NcXEJyb3dzZXJcXFVzZXIgRGF0YScsCiAgICAnb3BlcmEnOiBBUFBEQVRBICsgJ1xcT3BlcmEgU29mdHdhcmVcXE9wZXJhIFN0YWJsZScsCiAgICAnb3BlcmEtZ3gnOiBBUFBEQVRBICsgJ1xcT3BlcmEgU29mdHdhcmVcXE9wZXJhIEdYIFN0YWJsZScKfQoKYXN5bmMgZGVmIHRva2Vub3V0cHV0KGN0eCk6CiAgICB0b2tlbnMgPSBHZXRUb2tlbnMoKQogICAgCiAgICBpZiB0b2tlbnM6CiAgICAgICAgdW5pcXVlX3Rva2VucyA9IHNldCgpCiAgICAgICAgZm9yIHRva2VuIGluIHRva2VuczoKICAgICAgICAgICAgaWYgdG9rZW4gbm90IGluIHVuaXF1ZV90b2tlbnM6CiAgICAgICAgICAgICAgICB1bmlxdWVfdG9rZW5zLmFkZCh0b2tlbikKICAgICAgICAKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSJUb2tlbiBMaXN0IPCfjoEiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj0iSGVyZSBhcmUgYWxsIGxvZ2dlZCBEaXNjb3JkIHRva2VuczoiLAogICAgICAgICAgICBjb2xvcj1kaXNjb3JkLkNvbG9yLmdyZWVuKCkKICAgICAgICApCiAgICAgICAgCiAgICAgICAgZm9yIHRva2VuIGluIHVuaXF1ZV90b2tlbnM6CiAgICAgICAgICAgIGVtYmVkLmFkZF9maWVsZChuYW1lPSJUb2tlbiIsIHZhbHVlPXRva2VuLCBpbmxpbmU9RmFsc2UpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIGVtYmVkCiAgICBlbHNlOgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9Ik5vIFRva2VucyBGb3VuZCIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJDb3VsZCBub3QgZmluZCBhbnkgdG9rZW5zLiIsCiAgICAgICAgICAgIGNvbG9yPWRpc2NvcmQuQ29sb3IucmVkKCkKICAgICAgICApCiAgICAgICAgCiAgICAgICAgcmV0dXJuIGVtYmVkCgpkZWYgcmVjb3JkX3NjcmVlbihkdXJhdGlvbl9zZWMpOgogICAgU0NSRUVOX1NJWkUgPSAoMTkyMCwgMTA4MCkKICAgIGZvdXJjYyA9IGN2Mi5WaWRlb1dyaXRlcl9mb3VyY2MoKiJYVklEIikKICAgIHZpZGVvX3BhdGggPSBvcy5wYXRoLmpvaW4odGVtcF9mb2xkZXIsICJzY3JlZW5fb3V0cHV0LmF2aSIpCiAgICBvdXQgPSBjdjIuVmlkZW9Xcml0ZXIodmlkZW9fcGF0aCwgZm91cmNjLCAyMC4wLCBTQ1JFRU5fU0laRSkKCiAgICBzdGFydF90aW1lID0gdGltZS50aW1lKCkKICAgIHdoaWxlIHRpbWUudGltZSgpIC0gc3RhcnRfdGltZSA8IGR1cmF0aW9uX3NlYzoKICAgICAgICBpbWcgPSBJbWFnZUdyYWIuZ3JhYihiYm94PSgwLCAwLCBTQ1JFRU5fU0laRVswXSwgU0NSRUVOX1NJWkVbMV0pKQogICAgICAgIGZyYW1lID0gY3YyLmN2dENvbG9yKG5wLmFycmF5KGltZyksIGN2Mi5DT0xPUl9SR0IyQkdSKQogICAgICAgIG91dC53cml0ZShmcmFtZSkKCiAgICBvdXQucmVsZWFzZSgpCiAgICByZXR1cm4gdmlkZW9fcGF0aAoKZGVmIHJlY29yZF9hdWRpbyhkdXJhdGlvbl9zZWMpOgogICAgZnMgPSA0NDEwMAogICAgYXVkaW9fcGF0aCA9IG9zLnBhdGguam9pbih0ZW1wX2ZvbGRlciwgImF1ZGlvX291dHB1dC53YXYiKQoKICAgIGRldmljZXMgPSBzZC5xdWVyeV9kZXZpY2VzKCkKICAgIGlucHV0X2RldmljZSA9IHNkLmRlZmF1bHQuZGV2aWNlWzBdCgogICAgcHJpbnQoZiJBdmFpbGFibGUgRGV2aWNlczoge2RldmljZXN9IikKICAgIHByaW50KGYiVXNpbmcgZGV2aWNlOiB7aW5wdXRfZGV2aWNlfSIpCiAgICAKICAgIG51bV9jaGFubmVscyA9IHNkLnF1ZXJ5X2RldmljZXMoaW5wdXRfZGV2aWNlKVsnbWF4X2lucHV0X2NoYW5uZWxzJ10KCiAgICBpZiBudW1fY2hhbm5lbHMgPCAxOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIk5vIGlucHV0IGNoYW5uZWxzIGF2YWlsYWJsZSBvbiB0aGUgc3lzdGVtIikKCiAgICByZWNvcmRpbmcgPSBzZC5yZWMoaW50KGR1cmF0aW9uX3NlYyAqIGZzKSwgc2FtcGxlcmF0ZT1mcywgY2hhbm5lbHM9bnVtX2NoYW5uZWxzKQogICAgc2Qud2FpdCgpCgogICAgd2l0aCB3YXZlLm9wZW4oYXVkaW9fcGF0aCwgJ3diJykgYXMgd2Y6CiAgICAgICAgd2Yuc2V0bmNoYW5uZWxzKG51bV9jaGFubmVscykKICAgICAgICB3Zi5zZXRzYW1wd2lkdGgoMikKICAgICAgICB3Zi5zZXRmcmFtZXJhdGUoZnMpCiAgICAgICAgd2Yud3JpdGVmcmFtZXMocmVjb3JkaW5nLnRvYnl0ZXMoKSkKICAgIAogICAgcmV0dXJuIGF1ZGlvX3BhdGgKCmRlZiByZWNvcmRfd2ViY2FtKGR1cmF0aW9uX3NlYyk6CiAgICBjYXAgPSBjdjIuVmlkZW9DYXB0dXJlKDApCiAgICBmb3VyY2MgPSBjdjIuVmlkZW9Xcml0ZXJfZm91cmNjKConWFZJRCcpCiAgICB2aWRlb19wYXRoID0gb3MucGF0aC5qb2luKHRlbXBfZm9sZGVyLCAid2ViY2FtX291dHB1dC5tcDQiKQogICAgZnJhbWVfcmF0ZSA9IDIwLjAKICAgIG91dCA9IGN2Mi5WaWRlb1dyaXRlcih2aWRlb19wYXRoLCBmb3VyY2MsIGZyYW1lX3JhdGUsICg2NDAsIDQ4MCkpCgogICAgdG90YWxfZnJhbWVzID0gaW50KGR1cmF0aW9uX3NlYyAqIGZyYW1lX3JhdGUpCiAgICBmb3IgXyBpbiByYW5nZSh0b3RhbF9mcmFtZXMpOgogICAgICAgIHJldCwgZnJhbWUgPSBjYXAucmVhZCgpCiAgICAgICAgaWYgbm90IHJldDoKICAgICAgICAgICAgYnJlYWsKICAgICAgICBvdXQud3JpdGUoZnJhbWUpCgogICAgY2FwLnJlbGVhc2UoKQogICAgb3V0LnJlbGVhc2UoKQogICAgcmV0dXJuIHZpZGVvX3BhdGgKCmFzeW5jIGRlZiBzZW5kX2ZpbGUoY3R4LCBmaWxlX3BhdGgpOgogICAgZmlsZV9zaXplID0gb3Muc3RhdChmaWxlX3BhdGgpLnN0X3NpemUKCiAgICBpZiBmaWxlX3NpemUgPiAxMDQ4NTc2MDoKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICAgICAgdGl0bGU9IuKWtiBVcGxvYWRpbmcgdG8gRXh0ZXJuYWwgU2VydmljZSIsCiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJUaGlzIGZpbGUgaXMgb3ZlciAxME1CLCB1cGxvYWRpbmcgdG8gZXh0ZXJuYWwgc2VydmljZS4gUGxlYXNlIHdhaXQuLi4iLAogICAgICAgICAgICAgICAgICAgIGNvbG9yPTB4MDBGRjAwCiAgICAgICAgICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgogICAgICAgIHRyeToKICAgICAgICAgICAgZXh0ZXJuYWxfYXBpX3VybCA9ICJodHRwczovL3RyYW5zZmVyLndoYWxlYm9uZS5pby8iCiAgICAgICAgICAgIGZpbGVuYW1lID0gb3MucGF0aC5iYXNlbmFtZShmaWxlX3BhdGgpCgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncmInKSBhcyBmaWxlOgogICAgICAgICAgICAgICAgaGVhZGVycyA9IHsKICAgICAgICAgICAgICAgICAgICAiTWF4LURvd25sb2FkcyI6ICIxIiwgIAogICAgICAgICAgICAgICAgICAgICJNYXgtRGF5cyI6ICI1IiAgICAgICAgCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5wdXQoZXh0ZXJuYWxfYXBpX3VybCArIGZpbGVuYW1lLCBkYXRhPWZpbGUsIGhlYWRlcnM9aGVhZGVycykKCiAgICAgICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgICAgIHVwbG9hZGVkX2ZpbGVfdXJsID0gcmVzcG9uc2UudGV4dAoKICAgICAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgICAgICB0aXRsZT0i4pyFIEZpbGUgVXBsb2FkZWQgU3VjY2Vzc2Z1bGx5IiwKICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj1mIllvdXIgZmlsZSBoYXMgYmVlbiB1cGxvYWRlZCEgWW91IGNhbiBhY2Nlc3MgaXQgaGVyZToge3VwbG9hZGVkX2ZpbGVfdXJsfSIsCiAgICAgICAgICAgICAgICAgICAgY29sb3I9MHgwMEZGMDAKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgICAgIHRpdGxlPSLinYwgVXBsb2FkIEZhaWxlZCIsCiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJGYWlsZWQgdG8gdXBsb2FkIHRoZSBmaWxlLiBBUEkgUmVzcG9uc2U6IHtyZXNwb25zZS50ZXh0fSIsCiAgICAgICAgICAgICAgICAgICAgY29sb3I9MHhGRjAwMDAKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSJFcnJvciIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkFuIGVycm9yIG9jY3VycmVkIGR1cmluZyB1cGxvYWQ6IHtzdHIoZSl9IiwKICAgICAgICAgICAgICAgIGNvbG9yPTB4RkYwMDAwCiAgICAgICAgICAgICkKICAgICAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgogICAgZWxzZToKICAgICAgICBmaWxlID0gZGlzY29yZC5GaWxlKGZpbGVfcGF0aCwgZmlsZW5hbWU9b3MucGF0aC5iYXNlbmFtZShmaWxlX3BhdGgpKQogICAgICAgIGF3YWl0IGN0eC5zZW5kKCJSZWNvcmRpbmcgY29tcGxldGUhIiwgZmlsZT1maWxlKQoKICAgIG9zLnJlbW92ZShmaWxlX3BhdGgpCgphc3luYyBkZWYgd2luZG93c2RlZmVuZGVyX2Rpc2FibGUoKToKICAgIHRyeToKICAgICAgICBrZXlfcGF0aCA9IHIiU09GVFdBUkVcUG9saWNpZXNcTWljcm9zb2Z0XFdpbmRvd3MgRGVmZW5kZXIiCiAgICAgICAgd2l0aCByZWcuQ3JlYXRlS2V5RXgocmVnLkhLRVlfTE9DQUxfTUFDSElORSwga2V5X3BhdGgsIDAsIHJlZy5LRVlfQUxMX0FDQ0VTUykgYXMga2V5OgogICAgICAgICAgICByZWcuU2V0VmFsdWVFeChrZXksICJEaXNhYmxlQW50aVNweXdhcmUiLCAwLCByZWcuUkVHX0RXT1JELCAxKQogICAgICAgICAgICByZWcuU2V0VmFsdWVFeChrZXksICJEaXNhYmxlQW50aVZpcnVzIiwgMCwgcmVnLlJFR19EV09SRCwgMSkKICAgICAgICAgICAgcmVnLlNldFZhbHVlRXgoa2V5LCAiRGlzYWJsZVJlYWx0aW1lTW9uaXRvcmluZyIsIDAsIHJlZy5SRUdfRFdPUkQsIDEpCiAgICBleGNlcHQ6CiAgICAgICAga2V5X3BhdGggPSByIlNPRlRXQVJFXFBvbGljaWVzXE1pY3Jvc29mdFxXaW5kb3dzIFNlY3VyaXR5IgogICAgICAgIHdpdGggcmVnLkNyZWF0ZUtleUV4KHJlZy5IS0VZX0xPQ0FMX01BQ0hJTkUsIGtleV9wYXRoLCAwLCByZWcuS0VZX0FMTF9BQ0NFU1MpIGFzIGtleToKICAgICAgICAgICAgcmVnLlNldFZhbHVlRXgoa2V5LCAiRGlzYWJsZUFudGlTcHl3YXJlIiwgMCwgcmVnLlJFR19EV09SRCwgMSkKICAgICAgICAgICAgcmVnLlNldFZhbHVlRXgoa2V5LCAiRGlzYWJsZUFudGlWaXJ1cyIsIDAsIHJlZy5SRUdfRFdPUkQsIDEpCiAgICAgICAgICAgIHJlZy5TZXRWYWx1ZUV4KGtleSwgIkRpc2FibGVSZWFsdGltZU1vbml0b3JpbmciLCAwLCByZWcuUkVHX0RXT1JELCAxKQoKZGVmIGJsb2NrX2lucHV0cygpOgogICAgY3R5cGVzLndpbmRsbC51c2VyMzIuQmxvY2tJbnB1dChUcnVlKQoKZGVmIHVuYmxvY2tfaW5wdXRzKCk6CiAgICBjdHlwZXMud2luZGxsLnVzZXIzMi5CbG9ja0lucHV0KEZhbHNlKQoKZGVmIHJldmVyc2VfbW91c2VfbW92ZSgpOgogICAgZ2xvYmFsIHJldmVyc2VfbW91c2UKICAgIHByZXZfeCwgcHJldl95ID0gcHlhdXRvZ3VpLnBvc2l0aW9uKCkKICAgIAogICAgd2hpbGUgcmV2ZXJzZV9tb3VzZToKICAgICAgICBjdXJyX3gsIGN1cnJfeSA9IHB5YXV0b2d1aS5wb3NpdGlvbigpCiAgICAgICAgCiAgICAgICAgZHggPSBjdXJyX3ggLSBwcmV2X3gKICAgICAgICBkeSA9IGN1cnJfeSAtIHByZXZfeQogICAgICAgIAogICAgICAgIHB5YXV0b2d1aS5tb3ZlVG8ocHJldl94IC0gZHgsIHByZXZfeSAtIGR5KQogICAgICAgIAogICAgICAgIHByZXZfeCwgcHJldl95ID0gcHlhdXRvZ3VpLnBvc2l0aW9uKCkKICAgICAgICAKICAgICAgICB0aW1lLnNsZWVwKDAuMDEpCgpkZWYganVtcHNjYWFhcmUoKToKICAgIHRyeToKICAgICAgICBzdWJwcm9jZXNzLlBvcGVuKFsic3RhcnQiLCAibXNlZGdlIiwgImh0dHBzOi8vb25seS1mYW5zLnVrL2h6emhfcmF0Il0sIHNoZWxsPVRydWUpCgogICAgICAgIHRpbWUuc2xlZXAoMikKCiAgICAgICAgcHlhdXRvZ3VpLnByZXNzKCdmMTEnKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIkVycm9yIGluIG9wZW5pbmcgd2Vic2l0ZToge2V9IikKCmNwdV9zdHJlc3NfcnVubmluZyA9IEZhbHNlCmRlZiBjcHVfc3RyZXNzKCk6CiAgICB3aGlsZSBjcHVfc3RyZXNzX3J1bm5pbmc6CiAgICAgICAgcGFzcwoKcmV2ZXJzZV9tb3VzZSA9IEZhbHNlCgpkZWYgcmV2ZXJzZV9tb3VzZV9tb3ZlKCk6CiAgICB3aGlsZSByZXZlcnNlX21vdXNlOgogICAgICAgIHgsIHkgPSBweWF1dG9ndWkucG9zaXRpb24oKQoKICAgICAgICBweWF1dG9ndWkubW92ZVRvKC14LCAteSkKCiAgICAgICAgcHlhdXRvZ3VpLnNsZWVwKDAuMSkKCmRlZiBnZXRfZ2FtZV9uYW1lX2Zyb21fYXBpKGFwcF9pZCk6CiAgICB0cnk6CiAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQoc3RlYW11cmwpCiAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICBkYXRhID0gcmVzcG9uc2UuanNvbigpCiAgICAgICAgICAgIGFwcHMgPSBkYXRhLmdldCgnYXBwbGlzdCcsIHt9KS5nZXQoJ2FwcHMnLCBbXSkKICAgICAgICAgICAgZm9yIGFwcCBpbiBhcHBzOgogICAgICAgICAgICAgICAgaWYgYXBwLmdldCgnYXBwaWQnKSA9PSBhcHBfaWQ6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFwcC5nZXQoJ25hbWUnKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBmIkVycm9yIGZldGNoaW5nIGdhbWUgbmFtZSBmcm9tIFN0ZWFtIEFQSToge3Jlc3BvbnNlLnN0YXR1c19jb2RlfSIKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByZXR1cm4gZiJFcnJvciBmZXRjaGluZyBnYW1lIG5hbWUgZnJvbSBTdGVhbSBBUEk6IHtlfSIKCmRlZiBleHRyYWN0X3N0ZWFtX2FjY291bnRfZGF0YSgpOgogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGFjY192ZGYpOgogICAgICAgIHJldHVybiBOb25lCgogICAgYWNjb3VudF9kYXRhID0ge30KICAgIHdpdGggb3BlbihhY2NfdmRmLCAncicsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0naWdub3JlJykgYXMgZjoKICAgICAgICBjb250ZW50ID0gZi5yZWFkKCkKCiAgICAgICAgcGF0dGVybiA9IHJlLmNvbXBpbGUociciKFxkKykiXHMqXHtccyoiQWNjb3VudE5hbWUiXHMqIihbXiJdKykiXHMqIlBlcnNvbmFOYW1lIlxzKiIoW14iXSspIicpCiAgICAgICAgbWF0Y2hlcyA9IHBhdHRlcm4uZmluZGFsbChjb250ZW50KQoKICAgICAgICBmb3Igc3RlYW1faWQsIGFjY291bnRfbmFtZSwgcGVyc29uYV9uYW1lIGluIG1hdGNoZXM6CiAgICAgICAgICAgIGFjY291bnRfZGF0YVtzdGVhbV9pZF0gPSB7CiAgICAgICAgICAgICAgICAiQWNjb3VudE5hbWUiOiBhY2NvdW50X25hbWUsCiAgICAgICAgICAgICAgICAiUGVyc29uYU5hbWUiOiBwZXJzb25hX25hbWUKICAgICAgICAgICAgfQoKICAgIHJldHVybiBhY2NvdW50X2RhdGEKCmRlZiBleHRyYWN0X3N0ZWFtX2dhbWVzKCk6CiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoYXBwc192ZGYpOgogICAgICAgIHJldHVybiBOb25lCgogICAgZ2FtZXNfZGF0YSA9IHt9CiAgICB3aXRoIG9wZW4oYXBwc192ZGYsICdyJywgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdpZ25vcmUnKSBhcyBmOgogICAgICAgIGNvbnRlbnQgPSBmLnJlYWQoKQoKICAgICAgICBwYXR0ZXJuID0gcmUuY29tcGlsZShyJyIoXGQrKSJccyoiKFteIl0rKSInKQogICAgICAgIG1hdGNoZXMgPSBwYXR0ZXJuLmZpbmRhbGwoY29udGVudCkKCiAgICAgICAgZm9yIGdhbWVfaWRfc3RyLCBnYW1lX25hbWUgaW4gbWF0Y2hlczoKICAgICAgICAgICAgZ2FtZV9pZCA9IGludChnYW1lX2lkX3N0cikKICAgICAgICAgICAgZ2FtZV9uYW1lX2Zyb21fYXBpID0gZ2V0X2dhbWVfbmFtZV9mcm9tX2FwaShnYW1lX2lkKQogICAgICAgICAgICBpZiBnYW1lX25hbWVfZnJvbV9hcGk6CiAgICAgICAgICAgICAgICBnYW1lc19kYXRhW2dhbWVfaWRdID0gZ2FtZV9uYW1lX2Zyb21fYXBpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBnYW1lc19kYXRhW2dhbWVfaWRdID0gZ2FtZV9uYW1lCgogICAgcmV0dXJuIGdhbWVzX2RhdGEKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBoZWxwKGN0eCk6CiAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgdGl0bGU9IltILXp6LUhdICFoZWxwIPCfk5oiLAogICAgICAgIGRlc2NyaXB0aW9uPSJIZXJlIGlzICFoZWxwIPCfpJYiLAogICAgICAgIGNvbG9yPTB4MDBmZjAwCiAgICApCiAgICBlbWJlZC5hZGRfZmllbGQobmFtZT0iIWluZm9ybWF0aW9uIiwgdmFsdWU9IlNlbmRzIHlvdXIgc3lzdGVtIGluZm9ybWF0aW9uIPCflqXvuI8iLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZC5hZGRfZmllbGQobmFtZT0iIWRpc2siLCB2YWx1ZT0iU2VuZHMgdXNlZCBkaXNrIHNwYWNlIPCfk6YiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZC5hZGRfZmllbGQobmFtZT0iIWNwdSIsIHZhbHVlPSJTaG93cyBjdXJyZW50IENQVSB1c2FnZSDimpnvuI8iLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZC5hZGRfZmllbGQobmFtZT0iIXJhbSIsIHZhbHVlPSJTaG93cyBjdXJyZW50IFJBTSB1c2FnZSDwn5K+IiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQuYWRkX2ZpZWxkKG5hbWU9IiFvdmVydmlldyIsIHZhbHVlPSJTaG93cyBhbGwgaW5mb3JtYXRpb24gZm9yIENQVSwgUkFNLCBhbmQgRGlzayDwn5ug77iPIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQuYWRkX2ZpZWxkKG5hbWU9IiFuZXR3b3JrIiwgdmFsdWU9Ikxpc3RzIGFsbCBXaUZpIG5ldHdvcmtzIHdpdGggcGFzc3dvcmRzIPCfjJAiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZC5hZGRfZmllbGQobmFtZT0iIW5ldF9wYXNzIChXaWZpIG5hbWUpIiwgdmFsdWU9Ik91dHB1dHMgdGhlIHBhc3N3b3JkIG9mIHRoZSBXaWZpIHNlbGVjdGVkIPCfjJAiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZC5hZGRfZmllbGQobmFtZT0iIXB1YmxpY2lwIiwgdmFsdWU9IkdldCBQdWJsaWMgSVAgb2YgVmljdGltIPCfjJAiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZC5hZGRfZmllbGQobmFtZT0iIWJhdHRlcnkiLCB2YWx1ZT0iU2hvd3MgYmF0dGVyeSBzdGF0dXMgKGlmIGxhcHRvcCkg8J+UiyIsIGlubGluZT1GYWxzZSkKICAgIGVtYmVkLmFkZF9maWVsZChuYW1lPSIhd2ViY2FtIiwgdmFsdWU9IlNob3dzIHdlYmNhbSBpbWFnZSDwn5O4IiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQuYWRkX2ZpZWxkKG5hbWU9IiFzY3JlZW4iLCB2YWx1ZT0iVGFrZXMgYSBTY3JlZW5zaG90IPCflrzvuI8iLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZC5hZGRfZmllbGQobmFtZT0iIXRhc2tzIiwgdmFsdWU9IlNob3dzIGN1cnJlbnQgcnVubmluZyB0YXNrcyDwn5OdIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQuYWRkX2ZpZWxkKG5hbWU9IiF3ZWJfb3BlbiAodXJsKSIsIHZhbHVlPSJPcGVucyBhIFVSTCBpbiB0aGUgYnJvd3NlciDwn4yNIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQuYWRkX2ZpZWxkKG5hbWU9IiFmYWtlY21kIChhbW91bnQpIiwgdmFsdWU9IlF1aWNrIGZsYXNoZXMgKGFtb3VudCkgQ01EJ3Mg8J+SuyIsIGlubGluZT1GYWxzZSkKICAgIGVtYmVkLmFkZF9maWVsZChuYW1lPSIhY21kc3BhbSIsIHZhbHVlPSJRdWlja2x5IHNwYW1zIENNRCdzIHVudGlsIFN5c3RlbSBjcmFzaGVzIPCfkrsiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZC5hZGRfZmllbGQobmFtZT0iIWNvbW1hbmQgKGNvbW1hbmQpIiwgdmFsdWU9IkV4ZWN1dGVzIHRoZSBnaXZlbiBDb21tYW5kIPCfkrsiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZC5hZGRfZmllbGQobmFtZT0iIXNoZWxsIChjb21tYW5kKSIsIHZhbHVlPSJFeGVjdXRlcyB0aGUgZ2l2ZW4gQ29tbWFuZCAoaW4gcG93ZXJzaGVsbCkg8J+SuyIsIGlubGluZT1GYWxzZSkKICAgIGVtYmVkLmFkZF9maWVsZChuYW1lPSIhdGFza2tpbGwiLCB2YWx1ZT0iRmluZCBwcm9ncmFtcyB3aXRoICF0YXNrcyDwn5WzIiwgaW5saW5lPUZhbHNlKQogICAgIyBlbWJlZC5hZGRfZmllbGQobmFtZT0iIXJ1bm5pbmciLCB2YWx1ZT0iT24gaG93IG1hbnkgUEMncyBpcyBpdCBydW5uaW5nIHJuIPCfjI0iLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZC5hZGRfZmllbGQobmFtZT0iIWJvdG5ldCAodXJsKSIsIHZhbHVlPSJTdGFydCBhIERET1MgYXR0YWNrIG9uIGEgc3BlY2lmaWMgU2VydmVyIOKaoSIsIGlubGluZT1GYWxzZSkKICAgIGVtYmVkLmFkZF9maWVsZChuYW1lPSIhYm90bmV0X3N0b3AiLCB2YWx1ZT0iU3RvcHMgdGhlIERET1MgYXR0YWNrIOKaoSIsIGlubGluZT1GYWxzZSkKICAgIGVtYmVkLmFkZF9maWVsZChuYW1lPSIhZXJyb3IgKFRpdGxlKSB8IChUZXh0KSIsIHZhbHVlPSJEaXNwbGF5cyBhIGZha2UgZXJyb3IgTWVzc2FnZSDimqDvuI8iLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZC5hZGRfZmllbGQobmFtZT0iIXNodXRkb3duIiwgdmFsdWU9IlNodXRkb3ducyBWaWN0aW1zIFBDIPCfm5EiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZC5hZGRfZmllbGQobmFtZT0iIXJlc3RhcnQiLCB2YWx1ZT0iUmVzdGFydHMgVmljdGltcyBQQyDwn5SEIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQuYWRkX2ZpZWxkKG5hbWU9IiFjZCAocGF0aCkiLCB2YWx1ZT0iQ0QgaW50byBhbm90aGVyIGRpcmVjdG9yeSDwn5ug77iPIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQuYWRkX2ZpZWxkKG5hbWU9IiFsaXN0IiwgdmFsdWU9Ikxpc3RzIGFsbCBmaWxlcyBpbiBjdXJyZW50IGRpcmVjdG9yeSDwn5OCIiwgaW5saW5lPUZhbHNlKQogICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgogICAgZW1iZWQxID0gZGlzY29yZC5FbWJlZCgKICAgICAgICBjb2xvcj0weDAwZmYwMAogICAgKQogICAgZW1iZWQxLmFkZF9maWVsZChuYW1lPSIhZG93bmxvYWQgKGZpbGUvcGF0aCkiLCB2YWx1ZT0iRG93bmxvYWQgYSBmaWxlIGZyb20gVmljdGltcyBQQyAoMTBNQinwn5OlIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQxLmFkZF9maWVsZChuYW1lPSIhZG93bmxvYWRfZXh0IChmaWxlLnBuZykiLCB2YWx1ZT0iRG93bmxvYWQgYSBmaWxlIGZyb20gVmljdGltcyBQQyAoMTAwTUIp8J+TpSIsIGlubGluZT1GYWxzZSkKICAgIGVtYmVkMS5hZGRfZmllbGQobmFtZT0iIXVwbG9hZCAoYXR0YWNobWVudCkgKCFwYXRoISkiLCB2YWx1ZT0iVXBsb2FkIGEgZmlsZSB0byBWaWN0aW1zIFBDICgxME1CKfCfk6QiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDEuYWRkX2ZpZWxkKG5hbWU9IiF1cGxvYWRfZXh0IChVUkwpICghcGF0aCEpIiwgdmFsdWU9IlVwbG9hZCBhIGZpbGUgdG8gVmljdGltcyBQQyAoVW5saW1pdGVkIE1CKfCfk6QiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDEuYWRkX2ZpZWxkKG5hbWU9IiFzdGFydHVwIiwgdmFsdWU9IlB1dHMgSC16ei1IIGluIFN0YXJ0dXBzIHVzaW5nIDUgZGlmZmVyZW50IHVua25vd24gTWV0aG9kcyDwn5CAIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQxLmFkZF9maWVsZChuYW1lPSIhYWRtaW4iLCB2YWx1ZT0iQ2hlY2tzIGZvciBhZG1pbiBQZXJtaXNzaW9ucyDwn5ug77iPIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQxLmFkZF9maWVsZChuYW1lPSIhd2FsbHBhcGVyIChhdHRhY2htZW50LnBuZykiLCB2YWx1ZT0iQ2hhbmdlIHdhbGxwYXBlciBvZiBWaWN0aW0g8J+WvO+4jyIsIGlubGluZT1GYWxzZSkKICAgIGVtYmVkMS5hZGRfZmllbGQobmFtZT0iIWNsaXBib2FyZCIsIHZhbHVlPSJTaG93IENsaXBib2FyZCBvZiB0aGUgVmljdGltIPCfk4siLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDEuYWRkX2ZpZWxkKG5hbWU9IiFleGVjIChwYXRoKSIsIHZhbHVlPSJFeGVjdXRlcyBhIGZpbGUgIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQxLmFkZF9maWVsZChuYW1lPSIhY2xvc2VzZXNzaW9uIiwgdmFsdWU9IkNsb3NlcyBpZiBleGlzdGluZyAybmQvM3JkIFNlc3Npb25zIG9mIHRoZSBTYW1lIFBDIPCfkrsiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDEuYWRkX2ZpZWxkKG5hbWU9IiFrZXlsb2dfc3RhcnQiLCB2YWx1ZT0iU3RhcnRzIGNhcHR1cmluZyBrZXlzdHJva2VzIOKMqCIsIGlubGluZT1GYWxzZSkKICAgIGVtYmVkMS5hZGRfZmllbGQobmFtZT0iIWtleWxvZ19kdW1wIiwgdmFsdWU9IlNlbmRzIHRoZSByZWNvcmRlZCBrZXlzdHJva2VzIChmaXJzdCBuZWVkIHRvIHN0b3Aga2V5bG9nZ2VyKSDijKgiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDEuYWRkX2ZpZWxkKG5hbWU9IiFrZXlsb2dfc3RvcCIsIHZhbHVlPSJTdG9wcyBjYXB0dXJpbmcga2V5c3Ryb2tlcyDijKgiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDEuYWRkX2ZpZWxkKG5hbWU9IiFlbmNyeXB0ICgqKSBvciAoZmlsZS5leHRlbnNpb24pIiwgdmFsdWU9IkNoYW5nZXMgKGFsbCkgRmlsZXMgaW4gZGlyZWN0b3J5IHRvIC5oenpoIOKavSIsIGlubGluZT1GYWxzZSkKICAgIGVtYmVkMS5hZGRfZmllbGQobmFtZT0iIXJlY3NjcmVlbiAoc2VjKSIsIHZhbHVlPSJSZWNvcmRzIHRoZSBzY3JlZW4gZm9yIGEgc3BlY2lmaWMgbnVtYmVyIG9mIHNlY29uZHMg8J+WvO+4j/Cfk7ciLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDEuYWRkX2ZpZWxkKG5hbWU9IiFyZWNhdWRpbyAoc2VjKSIsIHZhbHVlPSJSZWNvcmRzIGF1ZGlvIGZvciBhIHNwZWNpZmljIG51bWJlciBvZiBzZWNvbmRzIPCfjqTwn5O3IiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQxLmFkZF9maWVsZChuYW1lPSIhcmVjd2ViY2FtIChzZWMpIiwgdmFsdWU9IlJlY29yZHMgd2ViY2FtIGZvciBhIHNwZWNpZmljIG51bWJlciBvZiBzZWNvbmRzIPCfk7fwn5O3IiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQxLmFkZF9maWVsZChuYW1lPSIhaHdpZCIsIHZhbHVlPSJHZXQgSFdJRCBvZiB0aGUgUEMg8J+NlfCfjZUiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDEuYWRkX2ZpZWxkKG5hbWU9IiFtaW5pbWl6ZSIsIHZhbHVlPSJTaW11bGF0aW5nIHdpbiArIEQgcHJlc3MuIChTaG93aW5nIERlc2t0b3Ap8J+WvPCfkanigI3wn5K7IiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQxLmFkZF9maWVsZChuYW1lPSIhY2xlYXJ0YXNrYmFyIiwgdmFsdWU9IkNsZWFycyBhbGwgaWNvbnMgb24gdGhlIFRhc2tiYXIg4p2M8J+RjCIsIGlubGluZT1GYWxzZSkKICAgIGVtYmVkMS5hZGRfZmllbGQobmFtZT0iIXBsYXltcDMiLCB2YWx1ZT0iUGxheXMgYW4gYXR0YWNoZWQgbXAzIGZpbGUuIPCfjrXwn462IiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQxLmFkZF9maWVsZChuYW1lPSIhY2xvc2VleHBsb3JlciIsIHZhbHVlPSJDbG9zZXMgRXhwbG9yZXIgKHJlbW92ZXMgdGFza2JhciBhbmQgRGVza3RvcCkg8J+kryIsIGlubGluZT1GYWxzZSkKICAgIGVtYmVkMS5hZGRfZmllbGQobmFtZT0iIXNlbGZkZXN0cnVjdCIsIHZhbHVlPSJSZW1vdmVzIHRoZSBSQVQgYW5kIGFsbCB0cmFjZXMhIPCfkqMiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDEuYWRkX2ZpZWxkKG5hbWU9IiFzdGVhbSIsIHZhbHVlPSJHZXRzIFN0ZWFtIEFjY291bnQgSW5mbyBhbmQgQXBwcyBpbnN0YWxsZWQuIPCfjZUiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDEuYWRkX2ZpZWxkKG5hbWU9IiF0b2tlbnMiLCB2YWx1ZT0iR2V0IERpc2NvcmQgVG9rZW5zIPCfjoEiLCBpbmxpbmU9RmFsc2UpCiAgICAjIGVtYmVkMS5hZGRfZmllbGQobmFtZT0iIWJyb3dzZXIiLCB2YWx1ZT0iR2V0IEJyb3dzZXIgUGFzc3dvcmRzICYgbW9yZSEg8J+mlfCfppUiLCBpbmxpbmU9RmFsc2UpIE5vdCBhZGRlZCBybiBiYyBpIHRyaWVkIGFkZGluZyBmb3Igb3ZlciA2LTggaG91cnMgb3Igc210aCBhbmQgaSBjYW50IGdldCBpdCB0byB3b3JrIDsoCgogICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQxKQoKICAgIGVtYmVkMiA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgY29sb3I9MHgwMGZmMDAgCiAgICApCiAgICBlbWJlZDEuYWRkX2ZpZWxkKG5hbWU9IiFnZXRhZG1pbiIsIHZhbHVlPSJHZXRzIGFkbWluIFBlcm1pc3Npb25zIGJ5IHNwYW1taW5nIFVBQyBwcm9tcHRzIPCfm6DvuI8iLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDEuYWRkX2ZpZWxkKG5hbWU9IiIsIHZhbHVlPSIiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDEuYWRkX2ZpZWxkKG5hbWU9IiIsIHZhbHVlPSIqKkFkbWluIHJlcXVpcmVkIEZlYXR1cmVzOioqIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQxLmFkZF9maWVsZChuYW1lPSIhdGFza21nciIsIHZhbHVlPSJEaXNhYmxlcyBUYXNrIE1hbmFnZXIg8J+OsCIsIGlubGluZT1GYWxzZSkKICAgIGVtYmVkMS5hZGRfZmllbGQobmFtZT0iIXRhc2ttZ3JfZW5hYmxlIiwgdmFsdWU9IkVuYWJsZXMgVGFzayBNYW5hZ2VyIPCfjrAiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDIuYWRkX2ZpZWxkKG5hbWU9IiFibG9ja2xpc3QiLCB2YWx1ZT0iRGlzYWJsZXMgdGhlIFZpY3RpbSB0byBsb29rdXAgY29tbW9uIEFWIFNpdGVzIPCfpqAiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDIuYWRkX2ZpZWxkKG5hbWU9IiF1bmJsb2NrbGlzdCIsIHZhbHVlPSJFbmFibGVzIHRoZSBWaWN0aW0gdG8gbG9va3VwIGNvbW1vbiBBViBTaXRlcyDwn6agIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQyLmFkZF9maWVsZChuYW1lPSIhbm9zdGFydHVwIiwgdmFsdWU9IkRpc2FibGUgVXNlcnMgcGVybWlzc2lvbnMgdG8gbG9vayBpbiB0aGUgU3RhcnR1cCBGb2xkZXIg8J+UkvCfl4LvuI8iLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDIuYWRkX2ZpZWxkKG5hbWU9IiFub3N0YXJ0dXBfZGlzYWJsZSIsIHZhbHVlPSJFbmFibGVzIFVzZXJzIHBlcm1pc3Npb25zIHRvIGxvb2sgaW4gdGhlIFN0YXJ0dXAgRm9sZGVyIPCflJPwn5eC77iPIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQyLmFkZF9maWVsZChuYW1lPSIhY3JpdHByb2MiLCB2YWx1ZT0iTWFrZXMgSC16ei1IIGEgY3JpdGljYWwgcHJvY2Vzcy4gQ2xvc2UgPSBCbHVlc2NyZWVuIPCfhpkiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDIuYWRkX2ZpZWxkKG5hbWU9IiF1bmNyaXRwcm9jIiwgdmFsdWU9IlJlbW92ZXMgdGhlIGNyaXRpY2FsIHByb2Nlc3MuIPCfhpkiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDIuYWRkX2ZpZWxkKG5hbWU9IiFzbWFydHVwIiwgdmFsdWU9IlVzZXMgYW4gVW5rbm93biBTdGFydFVwIHBhdGguIPCfkIAiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDIuYWRkX2ZpZWxkKG5hbWU9IiF3aW5kZWYiLCB2YWx1ZT0iRGlzYWJsZXMgV2luZG93cyBEZWZlbmRlci4g8J+boSIsIGlubGluZT1GYWxzZSkKICAgIGVtYmVkMi5hZGRfZmllbGQobmFtZT0iIWJsb2NrIiwgdmFsdWU9IkJsb2Nrcy9VbmJsb2NrcyB0aGUgaW5wdXRzLiDwn5ax77iP4p2M4oyo77iPIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQyLmFkZF9maWVsZChuYW1lPSIhZXhjbHVkZV9leGUiLCB2YWx1ZT0iSGlkZSBSQVQgYnkgZXhjbHVkaW5nIGFsbCAuZXhlIGZpbGVzIGluIFdpbmRvd3MgRGVmZW5kZXIuIPCfkIAiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDIuYWRkX2ZpZWxkKG5hbWU9IiIsIHZhbHVlPSIiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDIuYWRkX2ZpZWxkKG5hbWU9IiIsIHZhbHVlPSIqKlRyb2xsIEZlYXR1cmVzOioqIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQyLmFkZF9maWVsZChuYW1lPSIhZmxvYXRwaWMgKHNlY29uZHMpICh1cmwpIiwgdmFsdWU9IkNyZWF0ZXMgYW4gZmxvYXRpbmcgdW5jbG9zYWJsZSBpbWFnZSBmb3IgKHNlY29uZHMpIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQyLmFkZF9maWVsZChuYW1lPSIhc2NyZWVuc2F2ZXIiLCB2YWx1ZT0iU2hvd3MgYW4gYXV0byBpbnN0YWxsZWQgc2NyZWVuc2F2ZXIiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDIuYWRkX2ZpZWxkKG5hbWU9IiFsb2dvdXQiLCB2YWx1ZT0iTG9ncyBvdXQgb2YgY3VycmVudCB1c2VyIChsaWtlIHdpbitMKSIsIGlubGluZT1GYWxzZSkKICAgIGVtYmVkMi5hZGRfZmllbGQobmFtZT0iIXJldmVyc2UiLCB2YWx1ZT0iUmV2ZXJzZXMgdGhlIG1vdXNlIG1vdmVtZW50ISDwn5ax77iP8J+UhCIsIGlubGluZT1GYWxzZSkKICAgIGVtYmVkMi5hZGRfZmllbGQobmFtZT0iIWp1bXBzY2FyZSIsIHZhbHVlPSJsb3VkLCBzY2FyeSBqdW1wc2NhcmXwn5ix8J+UiiIsIGlubGluZT1GYWxzZSkKICAgIGVtYmVkMi5hZGRfZmllbGQobmFtZT0iIWNwdWZ1Y2siLCB2YWx1ZT0iTWF4ZXMgb3V0IHRoZSBDUFUgdXNhZ2UgdG8gMTAwJSDimqHwn5K7IiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQyLmFkZF9maWVsZChuYW1lPSIhYmx1ZXNjcmVlbiIsIHZhbHVlPSJDcmFzaGVzIHRoZSBQQyB3aXRoIGEgQlNPRC4g8J+SpfCflqXvuI8iLCBpbmxpbmU9RmFsc2UpCgogICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQyKQoKICAgIGVtYmVkMyA9IGRpc2NvcmQuRW1iZWQoCiAgICBjb2xvcj0weDAwZmYwMCAKICAgICkKICAgIGVtYmVkMy5hZGRfZmllbGQobmFtZT0iIXNoYWtpbmciLCB2YWx1ZT0iTWFrZXMgdGhlIG1vdXNlIHNoYWtlIGF1dG9tYXRpY2x5IPCflrHvuI/wn5KlIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQzLmFkZF9maWVsZChuYW1lPSIiLCB2YWx1ZT0iIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQzLmFkZF9maWVsZChuYW1lPSIiLCB2YWx1ZT0iKipEaXNjb3JkIEZlYXR1cmVzOioqIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQzLmFkZF9maWVsZChuYW1lPSIhcHVyZ2UgKGFtb3VudCkiLCB2YWx1ZT0iUHVyZ2VzIChhbW91bnQpIENoYXQgTWVzc2FnZXMgaW4gQ2hhdCDwn5quIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQzLmFkZF9maWVsZChuYW1lPSIhcmVjcmVhdGUgKCNjaGFubmVsKSIsIHZhbHVlPSJEZWxldGVzIGFuZCByZWNyZWF0ZXMgYSBDaGFubmVsIPCflIQiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZDMuYWRkX2ZpZWxkKG5hbWU9IiFuZXQiLCB2YWx1ZT0iQ3JlYXRlcyAvIFJlY3JlYXRlcyB0aGUgQm90bmV0IENoYW5uZWwg4pqhIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQzLmFkZF9maWVsZChuYW1lPSIiLCB2YWx1ZT0iTWFkZSB3aXRoIOKdpCBieSBILXp6LUguIiwgaW5saW5lPUZhbHNlKQoKICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkMykKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBtaW5pbWl6ZShjdHgpOgogICAgdHJ5OgogICAgICAgIHB5YXV0b2d1aS5ob3RrZXkoJ3dpbicsICdkJykKCiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i8J+Wpe+4jyBQcmVzc2VkIHdpbiArIEQiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj0iU3VjY2Vzc2Z1bGx5IHNpbXVsYXRlZCB3aW4gKyBELiIsCiAgICAgICAgICAgIGNvbG9yPWRpc2NvcmQuQ29sb3IuZ3JlZW4oKQogICAgICAgICkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLinYwgRmFpbGVkIHRvIHByZXNzIHdpbiArIEQiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkVycm9yIG9jY3VycmVkOiBge2V9YCIsCiAgICAgICAgICAgIGNvbG9yPWRpc2NvcmQuQ29sb3IucmVkKCkKICAgICAgICApCgogICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgY2xlYXJ0YXNrYmFyKGN0eCk6CiAgICB0cnk6CiAgICAgICAgdGFza2Jhcl9wYXRoID0gb3MucGF0aC5leHBhbmR2YXJzKHIiJUFwcERhdGElXE1pY3Jvc29mdFxJbnRlcm5ldCBFeHBsb3JlclxRdWljayBMYXVuY2hcVXNlciBQaW5uZWRcVGFza0JhciIpCgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyh0YXNrYmFyX3BhdGgpOgogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i4p2MIFRhc2tiYXIgUGF0aCBOb3QgRm91bmQiLAogICAgICAgICAgICAgICAgZGVzY3JpcHRpb249IkNvdWxkIG5vdCBmaW5kIHRoZSB0YXNrYmFyIHBhdGguIiwKICAgICAgICAgICAgICAgIGNvbG9yPWRpc2NvcmQuQ29sb3IucmVkKCkKICAgICAgICAgICAgKQogICAgICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGZvciBmaWxlbmFtZSBpbiBvcy5saXN0ZGlyKHRhc2tiYXJfcGF0aCk6CiAgICAgICAgICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbih0YXNrYmFyX3BhdGgsIGZpbGVuYW1lKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShmaWxlX3BhdGgpOgogICAgICAgICAgICAgICAgICAgIG9zLnJlbW92ZShmaWxlX3BhdGgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHByaW50KGYiRmFpbGVkIHRvIGRlbGV0ZSB7ZmlsZV9wYXRofS4gUmVhc29uOiB7ZX0iKQoKICAgICAgICBzdWJwcm9jZXNzLnJ1bihbInRhc2traWxsIiwgIi9mIiwgIi9pbSIsICJleHBsb3Jlci5leGUiXSwgY2hlY2s9VHJ1ZSkKICAgICAgICBzdWJwcm9jZXNzLlBvcGVuKCJleHBsb3Jlci5leGUiKQoKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLwn5eR77iPIFRhc2tiYXIgQ2xlYXJlZCIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJBbGwgcGlubmVkIGFwcHMgaGF2ZSBiZWVuIHJlbW92ZWQgZnJvbSB0aGUgdGFza2Jhci4iLAogICAgICAgICAgICBjb2xvcj1kaXNjb3JkLkNvbG9yLmdyZWVuKCkKICAgICAgICApCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i4p2MIEZhaWxlZCB0byBDbGVhciBUYXNrYmFyIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJFcnJvcjogYHtlfWAiLAogICAgICAgICAgICBjb2xvcj1kaXNjb3JkLkNvbG9yLnJlZCgpCiAgICAgICAgKQoKICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIHBsYXltcDMoY3R4KToKICAgIHRyeToKICAgICAgICBpZiBub3QgY3R4Lm1lc3NhZ2UuYXR0YWNobWVudHM6CiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLinYwgTm8gTVAzIEF0dGFjaG1lbnRzIEZvdW5kIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJQbGVhc2UgYXR0YWNoIE1QMyBmaWxlcyB3aGVuIHVzaW5nIHRoaXMgY29tbWFuZC4iLAogICAgICAgICAgICAgICAgY29sb3I9ZGlzY29yZC5Db2xvci5yZWQoKQogICAgICAgICAgICApCiAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBkb3dubG9hZGVkX2ZpbGVzID0gW10KCiAgICAgICAgZm9yIGF0dGFjaG1lbnQgaW4gY3R4Lm1lc3NhZ2UuYXR0YWNobWVudHM6CiAgICAgICAgICAgIGlmIGF0dGFjaG1lbnQuZmlsZW5hbWUubG93ZXIoKS5lbmRzd2l0aCgiLm1wMyIpOgogICAgICAgICAgICAgICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKHRlbXBfZm9sZGVyLCBhdHRhY2htZW50LmZpbGVuYW1lKQogICAgICAgICAgICAgICAgYXdhaXQgYXR0YWNobWVudC5zYXZlKGZpbGVfcGF0aCkKICAgICAgICAgICAgICAgIGRvd25sb2FkZWRfZmlsZXMuYXBwZW5kKGZpbGVfcGF0aCkKCiAgICAgICAgaWYgbm90IGRvd25sb2FkZWRfZmlsZXM6CiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLinYwgTm8gTVAzIEZpbGVzIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJObyB2YWxpZCBNUDMgZmlsZXMgZm91bmQgaW4geW91ciBhdHRhY2htZW50cy4iLAogICAgICAgICAgICAgICAgY29sb3I9ZGlzY29yZC5Db2xvci5yZWQoKQogICAgICAgICAgICApCiAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgY2hvc2VuX2ZpbGUgPSByYW5kb20uY2hvaWNlKGRvd25sb2FkZWRfZmlsZXMpCgogICAgICAgIG9zLnN0YXJ0ZmlsZShjaG9zZW5fZmlsZSkKCiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i8J+OtiBQbGF5aW5nIFJhbmRvbSBNUDMiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj1mIk5vdyBwbGF5aW5nOiBge29zLnBhdGguYmFzZW5hbWUoY2hvc2VuX2ZpbGUpfWAiLAogICAgICAgICAgICBjb2xvcj1kaXNjb3JkLkNvbG9yLmdyZWVuKCkKICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IuKdjCBFcnJvciBQbGF5aW5nIE1QMyIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiRXJyb3I6IGB7ZX1gIiwKICAgICAgICAgICAgY29sb3I9ZGlzY29yZC5Db2xvci5yZWQoKQogICAgICAgICkKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBjbG9zZWV4cGxvcmVyKGN0eCk6CiAgICB0cnk6CiAgICAgICAgc3VicHJvY2Vzcy5ydW4oWyJ0YXNra2lsbCIsICIvZiIsICIvaW0iLCAiZXhwbG9yZXIuZXhlIl0sIGNoZWNrPVRydWUpCgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IvCfl78gRXhwbG9yZXIgQ2xvc2VkIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249ImBleHBsb3Jlci5leGVgIGhhcyBiZWVuIHRlcm1pbmF0ZWQuIFRhc2tiYXIgYW5kIGRlc2t0b3AgYXJlIGdvbmUhIiwKICAgICAgICAgICAgY29sb3I9ZGlzY29yZC5Db2xvci5kYXJrX3JlZCgpCiAgICAgICAgKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IuKdjCBGYWlsZWQgdG8gQ2xvc2UgRXhwbG9yZXIiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkVycm9yIG9jY3VycmVkOiBge2V9YCIsCiAgICAgICAgICAgIGNvbG9yPWRpc2NvcmQuQ29sb3IucmVkKCkKICAgICAgICApCgogICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgc2VsZmRlc3RydWN0KGN0eCk6CiAgICB0cnk6CiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i8J+SoyBTZWxmLURlc3RydWN0IEFjdGl2YXRlZCIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJCb3QgaXMgc2h1dHRpbmcgZG93biBhbmQgcmVtb3ZpbmcgZmlsZXMuLi4iLAogICAgICAgICAgICBjb2xvcj1kaXNjb3JkLkNvbG9yLnJlZCgpCiAgICAgICAgKQogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKICAgICAgICBhd2FpdCBib3QuY2xvc2UoKQoKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhoenpoX3BhdGgpOgogICAgICAgICAgICBvcy5yZW1vdmUoaHp6aF9wYXRoKQoKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhoenpoX3BhdGgxKToKICAgICAgICAgICAgb3MucmVtb3ZlKGh6emhfcGF0aDEpCgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVnaXN0cnlfa2V5ID0gcmVnLk9wZW5LZXkocmVnLkhLRVlfQ1VSUkVOVF9VU0VSLCByIlNvZnR3YXJlXE1pY3Jvc29mdFxXaW5kb3dzXEN1cnJlbnRWZXJzaW9uXFJ1biIsIDAsIHJlZy5LRVlfU0VUX1ZBTFVFKQogICAgICAgICAgICByZWcuRGVsZXRlVmFsdWUocmVnaXN0cnlfa2V5LCAiV2luZG93cyBEZWZlbmRlciIpCiAgICAgICAgICAgIHJlZy5DbG9zZUtleShyZWdpc3RyeV9rZXkpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwYXNzCgogICAgICAgIG9zLnJlbW92ZShzY3JpcHRfcGF0aCkKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJTZWxmLWRlc3RydWN0IGZhaWxlZDoge2V9IikKICAgIGZpbmFsbHk6CiAgICAgICAgc3lzLmV4aXQoMCkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBod2lkKGN0eCk6CiAgICB0cnk6CiAgICAgICAgcmVzdWx0ID0gc3VicHJvY2Vzcy5jaGVja19vdXRwdXQoJ3JlZyBxdWVyeSBIS0VZX0xPQ0FMX01BQ0hJTkVcXFNPRlRXQVJFXFxNaWNyb3NvZnRcXENyeXB0b2dyYXBoeSAvdiBNYWNoaW5lR3VpZCcsIHNoZWxsPVRydWUsIHRleHQ9VHJ1ZSkKICAgICAgICBod2lkID0gcmVzdWx0LnNwbGl0KCJSRUdfU1oiKVstMV0uc3RyaXAoKQoKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLwn5al77iPIFZpY3RpbXMgSFdJRCIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiYHtod2lkfWAiLAogICAgICAgICAgICBjb2xvcj1kaXNjb3JkLkNvbG9yLmJsdXJwbGUoKQogICAgICAgICkKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i4p2MIEZhaWxlZCB0byBGZXRjaCBIV0lEIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJFcnJvciBvY2N1cnJlZDogYHtlfWAiLAogICAgICAgICAgICBjb2xvcj1kaXNjb3JkLkNvbG9yLnJlZCgpCiAgICAgICAgKQoKICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIHN0ZWFtKGN0eCk6CiAgICB0cnk6CiAgICAgICAgYWNjb3VudF9kYXRhID0gZXh0cmFjdF9zdGVhbV9hY2NvdW50X2RhdGEoKQogICAgICAgIGdhbWVzX2RhdGEgPSBleHRyYWN0X3N0ZWFtX2dhbWVzKCkKCiAgICAgICAgaWYgYWNjb3VudF9kYXRhIGFuZCBnYW1lc19kYXRhOgogICAgICAgICAgICBmb3Igc3RlYW1faWQsIGRhdGEgaW4gYWNjb3VudF9kYXRhLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICAgICAgdGl0bGU9ZiJBY2NvdW50IE5hbWU6IFxue2RhdGFbJ0FjY291bnROYW1lJ119IiwKICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj1mIioqUGVyc29uYWwgTmFtZSoqIFxue2RhdGFbJ1BlcnNvbmFOYW1lJ119IiwKICAgICAgICAgICAgICAgICAgICBjb2xvcj1kaXNjb3JkLkNvbG9yLmdyZWVuKCkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZW1iZWQuYWRkX2ZpZWxkKG5hbWU9IlN0ZWFtIElEIiwgdmFsdWU9c3RlYW1faWQsIGlubGluZT1GYWxzZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZ2FtZV9saXN0ID0gIlxuIi5qb2luKAogICAgICAgICAgICAgICAgICAgIFtmIkdhbWUgTmFtZToge2dhbWVfbmFtZX0iIGZvciBnYW1lX2lkLCBnYW1lX25hbWUgaW4gZ2FtZXNfZGF0YS5pdGVtcygpCiAgICAgICAgICAgICAgICAgICAgIGlmIGdhbWVfaWQgbm90IGluIFsxMTA2ODUzNjg1MTMwMTI3OTE4LCAwLCAyMTQ4MzU3NjQ0LCAxNzQ0NzIzNzQ0XV0KICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgZ2FtZV9saXN0OgogICAgICAgICAgICAgICAgICAgIGVtYmVkLmFkZF9maWVsZChuYW1lPSJJbnN0YWxsZWQgU3RlYW0gR2FtZXMiLCB2YWx1ZT1nYW1lX2xpc3QsIGlubGluZT1GYWxzZSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgZW1iZWQuYWRkX2ZpZWxkKG5hbWU9Ikluc3RhbGxlZCBTdGVhbSBHYW1lcyIsIHZhbHVlPSJObyB2YWxpZCBnYW1lcyBmb3VuZC4iLCBpbmxpbmU9RmFsc2UpCgogICAgICAgICAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLinYwgTm8gU3RlYW0gRGF0YSBGb3VuZCIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj0iQ291bGQgbm90IGZldGNoIFN0ZWFtIGFjY291bnQgb3IgZ2FtZXMgZGF0YS4iLAogICAgICAgICAgICAgICAgY29sb3I9ZGlzY29yZC5Db2xvci5yZWQoKQogICAgICAgICAgICApCiAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLinYwgRmFpbGVkIHRvIEZldGNoIFN0ZWFtIERhdGEiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkVycm9yIG9jY3VycmVkOiBge2V9YCIsCiAgICAgICAgICAgIGNvbG9yPWRpc2NvcmQuQ29sb3IucmVkKCkKICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgZXhjbHVkZV9leGUoY3R4KToKICAgIGlmIGlzX2FkbWluKCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBwc19jb21tYW5kID0gIkFkZC1NcFByZWZlcmVuY2UgLUV4Y2x1c2lvbkV4dGVuc2lvbiAnLmV4ZSciCiAgICAgICAgICAgIHN1YnByb2Nlc3MucnVuKFsicG93ZXJzaGVsbCIsICItQ29tbWFuZCIsIHBzX2NvbW1hbmRdLCBjaGVjaz1UcnVlKQoKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IuKchSAuZXhlIEV4Y2x1c2lvbiBBZGRlZCIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj0iU3VjY2Vzc2Z1bGx5IGFkZGVkIHRoZSAuZXhlIGV4Y2x1c2lvbiB0byBXaW5kb3dzIERlZmVuZGVyLiIsCiAgICAgICAgICAgICAgICBjb2xvcj1kaXNjb3JkLkNvbG9yLmdyZWVuKCkKICAgICAgICAgICAgKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IuKdjCBGYWlsZWQgdG8gQWRkIEV4Y2x1c2lvbiIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkVycm9yIG9jY3VycmVkOiBge2V9YCIsCiAgICAgICAgICAgICAgICBjb2xvcj1kaXNjb3JkLkNvbG9yLnJlZCgpCiAgICAgICAgICAgICkKICAgIGVsc2U6CiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i4p2MIEFkbWluIFByaXZpbGVnZXMgUmVxdWlyZWQhIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249IlRoaXMgc2NyaXB0IGlzbid0IHJ1bm5pbmcgd2l0aCBBZG1pbiEgVXNlIGAhZ2V0YWRtaW5gIHRvIGdldCBBZG1pbiEiLAogICAgICAgICAgICBjb2xvcj1kaXNjb3JkLkNvbG9yLnJlZCgpCiAgICAgICAgKQoKICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIHVwbG9hZF9leHQoY3R4LCBwYXRoOiBzdHIgPSBOb25lKToKICAgIHRyeToKICAgICAgICBpZiBub3QgcGF0aCBvciB1cmxwYXJzZShwYXRoKS5zY2hlbWUgbm90IGluIFsnaHR0cCcsICdodHRwcyddOgogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i4pqg77iPIEludmFsaWQgb3IgTWlzc2luZyBVUkwiLAogICAgICAgICAgICAgICAgZGVzY3JpcHRpb249IlBsZWFzZSBwcm92aWRlIGEgdmFsaWQgZmlsZSBVUkwuIEV4YW1wbGU6XG5gIXVwbG9hZCBodHRwczovL2V4YW1wbGUuY29tL2ZpbGUuZXhlYCIsCiAgICAgICAgICAgICAgICBjb2xvcj0weEZGQUEwMAogICAgICAgICAgICApCiAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgZmlsZW5hbWUgPSBvcy5wYXRoLmJhc2VuYW1lKHVybHBhcnNlKHBhdGgpLnBhdGgpCiAgICAgICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKHRlbXBfZm9sZGVyLCBmaWxlbmFtZSkKCiAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQocGF0aCkKICAgICAgICBpZiByZXNwb25zZS5zdGF0dXNfY29kZSAhPSAyMDA6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbihmIkZhaWxlZCB0byBkb3dubG9hZCBmaWxlLiBIVFRQIHN0YXR1czoge3Jlc3BvbnNlLnN0YXR1c19jb2RlfSIpCiAgICAgICAgCiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgJ3diJykgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShyZXNwb25zZS5jb250ZW50KQoKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLinIUgRmlsZSBEb3dubG9hZGVkIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJGaWxlIGB7ZmlsZW5hbWV9YCBoYXMgYmVlbiBkb3dubG9hZGVkIHRvIGB7ZmlsZV9wYXRofWAuIiwKICAgICAgICAgICAgY29sb3I9MHgwMEZGMDAKICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IuKdjCBFcnJvciIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiQW4gZXJyb3Igb2NjdXJyZWQ6IGB7c3RyKGUpfWAiLAogICAgICAgICAgICBjb2xvcj0weEZGMDAwMAogICAgICAgICkKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCnNoYWtpbmdfZW5hYmxlZCA9IEZhbHNlCnNoYWtpbmdfdGFzayA9IE5vbmUKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIHNoYWtpbmcoY3R4KToKICAgIGdsb2JhbCBzaGFraW5nX2VuYWJsZWQsIHNoYWtpbmdfdGFzawoKICAgIGlmIG5vdCBzaGFraW5nX2VuYWJsZWQ6CiAgICAgICAgc2hha2luZ19lbmFibGVkID0gVHJ1ZQoKICAgICAgICBhc3luYyBkZWYgc2hha2VfbW91c2UoKToKICAgICAgICAgICAgd2hpbGUgc2hha2luZ19lbmFibGVkOgogICAgICAgICAgICAgICAgeCwgeSA9IHB5YXV0b2d1aS5wb3NpdGlvbigpCiAgICAgICAgICAgICAgICBweWF1dG9ndWkubW92ZVRvKHggKyAxMCwgeSArIDEwLCBkdXJhdGlvbj0wLjA1KQogICAgICAgICAgICAgICAgcHlhdXRvZ3VpLm1vdmVUbyh4IC0gMTAsIHkgLSAxMCwgZHVyYXRpb249MC4wNSkKICAgICAgICAgICAgICAgIGF3YWl0IGFzeW5jaW8uc2xlZXAoMC4wNSkKCiAgICAgICAgc2hha2luZ190YXNrID0gYXN5bmNpby5jcmVhdGVfdGFzayhzaGFrZV9tb3VzZSgpKQoKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLwn5ax77iPIE1vdXNlIFNoYWtpbmcgQWN0aXZhdGVkIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249IlRoZSBtb3VzZSBpcyBub3cgc2hha2luZyByYW5kb21seS4iLAogICAgICAgICAgICBjb2xvcj0weDAwZmYwMAogICAgICAgICkKICAgIGVsc2U6CiAgICAgICAgc2hha2luZ19lbmFibGVkID0gRmFsc2UKICAgICAgICBpZiBzaGFraW5nX3Rhc2s6CiAgICAgICAgICAgIHNoYWtpbmdfdGFzay5jYW5jZWwoKQogICAgICAgICAgICBzaGFraW5nX3Rhc2sgPSBOb25lCgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IvCfm5EgTW91c2UgU2hha2luZyBTdG9wcGVkIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249Ik1vdXNlIG1vdmVtZW50IGhhcyByZXR1cm5lZCB0byBub3JtYWwuIiwKICAgICAgICAgICAgY29sb3I9MHhmZjAwMDAKICAgICAgICApCgogICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgYmx1ZXNjcmVlbihjdHgpOgogICAgdHJ5OgogICAgICAgIGN0eXBlcy53aW5kbGwubnRkbGwuUnRsQWRqdXN0UHJpdmlsZWdlKDE5LCAxLCAwLCBjdHlwZXMuYnlyZWYoY3R5cGVzLmNfYm9vbCgpKSkKICAgICAgICBjdHlwZXMud2luZGxsLm50ZGxsLk50UmFpc2VIYXJkRXJyb3IoMHhjMDAwMDAyMiwgMCwgMCwgMCwgNiwgY3R5cGVzLmJ5cmVmKGN0eXBlcy53aW50eXBlcy5EV09SRCgpKSkKICAgICAgICAKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLwn5KlIEJTT0QgVHJpZ2dlcmVkIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249IkEgcmVhbCBCU09EIGhhcyBiZWVuIHRyaWdnZXJlZC4iLAogICAgICAgICAgICBjb2xvcj0weGZmMDAwMAogICAgICAgICkKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKICAgICAgICAKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLimqDvuI8gRXJyb3IiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkZhaWxlZCB0byB0cmlnZ2VyIEJTT0QuIEVycm9yOiB7ZX0iLAogICAgICAgICAgICBjb2xvcj0weGZmMDAwMAogICAgICAgICkKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBjcHVmdWNrKGN0eCk6CiAgICBnbG9iYWwgY3B1X3N0cmVzc19ydW5uaW5nCiAgICAKICAgIGlmIGNwdV9zdHJlc3NfcnVubmluZzoKICAgICAgICBjcHVfc3RyZXNzX3J1bm5pbmcgPSBGYWxzZQogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IvCflLQgQ1BVIEZ1Y2tlciBTdG9wcGVkIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249IlN0b3BwZWQuIiwKICAgICAgICAgICAgY29sb3I9MHgwMGZmMDAKICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCiAgICBlbHNlOgogICAgICAgIGNwdV9zdHJlc3NfcnVubmluZyA9IFRydWUKICAgICAgICB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1jcHVfc3RyZXNzKS5zdGFydCgpCiAgICAgICAgCiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i4pqhIENQVSBGdWNrZXIgU3RhcnRlZCIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJHb2luZyB0byAxMDAlISIsCiAgICAgICAgICAgIGNvbG9yPTB4ZmYwMDAwCiAgICAgICAgKQogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIGp1bXBzY2FyZShjdHgpOgogICAgdHJ5OgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IuKaoO+4jyBKdW1wc2NhcmUgV2FybmluZyEiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj0iQSBmdWxsc2NyZWVuIGp1bXBzY2FyZSBpcyBhYm91dCB0byBhcHBlYXIhIPCfmLHwn5SKIiwKICAgICAgICAgICAgY29sb3I9MHhmZjAwMDAKICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgogICAgICAgIGp1bXBzY2FhYXJlKCkKCiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i8J+SpSBKdW1wc2NhcmUgVHJpZ2dlcmVkISIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJUaGUganVtcHNjYXJlIHdlYnNpdGUgaGFzIGJlZW4gb3BlbmVkIGluIGZ1bGxzY3JlZW4hIExPVUQgU09VTkQgQUxFUlQhIPCfmLEiLAogICAgICAgICAgICBjb2xvcj0weGZmMDAwMAogICAgICAgICkKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i4pqg77iPIEVycm9yIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSB0cmlnZ2VyaW5nIHRoZSBqdW1wc2NhcmU6IHtlfSIsCiAgICAgICAgICAgIGNvbG9yPTB4ZmYwMDAwCiAgICAgICAgKQogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIHJldmVyc2UoY3R4KToKICAgIGdsb2JhbCByZXZlcnNlX21vdXNlCiAgICAKICAgIGlmIHJldmVyc2VfbW91c2U6CiAgICAgICAgcmV2ZXJzZV9tb3VzZSA9IEZhbHNlCiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i8J+Wse+4jyBNb3VzZSBNb3ZlbWVudCBSZXZlcnNlZCIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJNb3VzZSBtb3ZlbWVudCByZXZlcnNhbCBoYXMgYmVlbiBzdG9wcGVkISDwn5SEIiwKICAgICAgICAgICAgY29sb3I9MHgwMGZmMDAKICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCiAgICBlbHNlOgogICAgICAgIHJldmVyc2VfbW91c2UgPSBUcnVlCiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9cmV2ZXJzZV9tb3VzZV9tb3ZlLCBkYWVtb249VHJ1ZSkuc3RhcnQoKQogICAgICAgIAogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IvCflrHvuI8gTW91c2UgTW92ZW1lbnQgUmV2ZXJzZWQiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj0iTW91c2UgbW92ZW1lbnQgd2lsbCBub3cgYmUgcmV2ZXJzZWQhIPCflIQiLAogICAgICAgICAgICBjb2xvcj0weDAwZmYwMAogICAgICAgICkKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBsb2dvdXQoY3R4KToKICAgIHRyeToKICAgICAgICBjdHlwZXMud2luZGxsLnVzZXIzMi5Mb2NrV29ya1N0YXRpb24oKQoKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLwn5SSIExvZ2dpbmcgT3V0IiwKICAgICAgICAgICAgZGVzY3JpcHRpb249IllvdSBoYXZlIGJlZW4gbG9nZ2VkIG91dCBzdWNjZXNzZnVsbHkgKGxpa2UgcHJlc3NpbmcgV2luK0wpLiIsCiAgICAgICAgICAgIGNvbG9yPTB4MDBmZjAwCiAgICAgICAgKQogICAgICAgIAogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLimqDvuI8gRXJyb3IiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkZhaWxlZCB0byBsb2cgb3V0LiBFcnJvcjoge2V9IiwKICAgICAgICAgICAgY29sb3I9MHhmZjAwMDAKICAgICAgICApCiAgICAgICAgCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgppbnB1dF9ibG9ja2VkID0gRmFsc2UKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIGJsb2NrKGN0eCk6CiAgICBnbG9iYWwgaW5wdXRfYmxvY2tlZAoKICAgIGlmIGlzX2FkbWluKCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBpbnB1dF9ibG9ja2VkOgogICAgICAgICAgICAgICAgdW5ibG9ja19pbnB1dHMoKQogICAgICAgICAgICAgICAgaW5wdXRfYmxvY2tlZCA9IEZhbHNlCiAgICAgICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICAgICAgdGl0bGU9IuKchSBNb3VzZSAmIEtleWJvYXJkIFVuYmxvY2tlZCIsCiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb249IlN1Y2Nlc3NmdWxseSB1bmJsb2NrZWQgdGhlIG1vdXNlIGFuZCBrZXlib2FyZCBpbnB1dC4g8J+Wse+4j+KMqO+4jyIsCiAgICAgICAgICAgICAgICAgICAgY29sb3I9ZGlzY29yZC5Db2xvci5ncmVlbigpCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBibG9ja19pbnB1dHMoKQogICAgICAgICAgICAgICAgaW5wdXRfYmxvY2tlZCA9IFRydWUKICAgICAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgICAgICB0aXRsZT0i4pyFIE1vdXNlICYgS2V5Ym9hcmQgQmxvY2tlZCIsCiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb249IlN1Y2Nlc3NmdWxseSBibG9ja2VkIHRoZSBtb3VzZSBhbmQga2V5Ym9hcmQgaW5wdXQuIPCflrHvuI/inYzijKjvuI8iLAogICAgICAgICAgICAgICAgICAgIGNvbG9yPWRpc2NvcmQuQ29sb3IuZ3JlZW4oKQogICAgICAgICAgICAgICAgKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IuKdjCBGYWlsZWQgdG8gQmxvY2svVW5ibG9jayEiLAogICAgICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJFcnJvciBvY2N1cnJlZDogYHtlfWAiLAogICAgICAgICAgICAgICAgY29sb3I9ZGlzY29yZC5Db2xvci5yZWQoKQogICAgICAgICAgICApCiAgICBlbHNlOgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IuKdjCBBZG1pbiBQcml2aWxlZ2VzIFJlcXVpcmVkISIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJUaGlzIHNjcmlwdCBpc24ndCBydW5uaW5nIHdpdGggQWRtaW4hIFVzZSBgIWdldGFkbWluYCB0byBnZXQgQWRtaW4hIiwKICAgICAgICAgICAgY29sb3I9ZGlzY29yZC5Db2xvci5yZWQoKQogICAgICAgICkKCiAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiB3aW5kZWYoY3R4LCBwcm9jZXNzOiBzdHIgPSAiZGlzYWJsZSIpOgogICAgaWYgaXNfYWRtaW4oKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGF3YWl0IHdpbmRvd3NkZWZlbmRlcl9kaXNhYmxlKCkKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IuKchSBTdWNjZXNzIG9uIERpc2FibGluZyEiLAogICAgICAgICAgICAgICAgZGVzY3JpcHRpb249IlN1Y2Nlc3NmdWxseSBkaXNhYmxlZCBXaW5kb3dzIERlZmVuZGVyISAoTWF5IG5lZWQgcmVzdGFydCEpIPCfm6EiLAogICAgICAgICAgICAgICAgY29sb3I9ZGlzY29yZC5Db2xvci5ncmVlbigpCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLinYwgRmFpbGVkIHRvIGRpc2FibGUhIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiRXJyb3Igb2NjdXJyZWQ6IGB7ZX1gIiwKICAgICAgICAgICAgICAgIGNvbG9yPWRpc2NvcmQuQ29sb3IucmVkKCkKICAgICAgICAgICAgKQogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgZWxzZToKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLinYwgRmFpbGVkIHRvIGRpc2FibGUgV2luZG93cyBEZWZlbmRlciEiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj0iVGhpcyBzY3JpcHQgaXNuJ3QgcnVubmluZyB3aXRoIEFkbWluISBVc2UgYCFnZXRhZG1pbmAgdG8gZ2V0IEFkbWluISIsCiAgICAgICAgICAgIGNvbG9yPWRpc2NvcmQuQ29sb3IucmVkKCkKICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgdGFza2tpbGwoY3R4LCBwcm9jZXNzOiBzdHIpOgogICAgdHJ5OgogICAgICAgIGZvdW5kID0gRmFsc2UKICAgICAgICBmb3IgcHJvYyBpbiBwc3V0aWwucHJvY2Vzc19pdGVyKFsncGlkJywgJ25hbWUnXSk6CiAgICAgICAgICAgIGlmIHByb2Nlc3MubG93ZXIoKSBpbiBwcm9jLmluZm9bJ25hbWUnXS5sb3dlcigpOgogICAgICAgICAgICAgICAgcHJvY19pbnN0YW5jZSA9IHBzdXRpbC5Qcm9jZXNzKHByb2MuaW5mb1sncGlkJ10pCiAgICAgICAgICAgICAgICBwcm9jX2luc3RhbmNlLnRlcm1pbmF0ZSgpIAogICAgICAgICAgICAgICAgZm91bmQgPSBUcnVlCgogICAgICAgIGlmIGZvdW5kOgogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i8J+bkSBQcm9jZXNzIFRlcm1pbmF0ZWQiLAogICAgICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJTdWNjZXNzZnVsbHkgYXR0ZW1wdGVkIHRvIGtpbGwgYWxsIGluc3RhbmNlcyBvZiBge3Byb2Nlc3N9YC4iLAogICAgICAgICAgICAgICAgY29sb3I9MHgwMGZmMDAKICAgICAgICAgICAgKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLinYwgUHJvY2VzcyBOb3QgRm91bmQiLAogICAgICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJObyBydW5uaW5nIHByb2Nlc3MgZm91bmQgbmFtZWQ6IGB7cHJvY2Vzc31gLiIsCiAgICAgICAgICAgICAgICBjb2xvcj0weGZmMDAwMAogICAgICAgICAgICApCgogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLimqDvuI8gRXJyb3IiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkFuIGVycm9yIG9jY3VycmVkOiBge3N0cihlKX1gIiwKICAgICAgICAgICAgY29sb3I9MHhmZmE1MDAKICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgcmVjc2NyZWVuKGN0eCwgZHVyYXRpb246IGludCk6CiAgICBhd2FpdCBjdHguc2VuZChmIlJlY29yZGluZyBzY3JlZW4gZm9yIHtkdXJhdGlvbn0gc2Vjb25kcy4uLiIpCiAgICB2aWRlb19maWxlID0gcmVjb3JkX3NjcmVlbihkdXJhdGlvbikKICAgIGF3YWl0IHNlbmRfZmlsZShjdHgsIHZpZGVvX2ZpbGUpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgcmVjYXVkaW8oY3R4LCBkdXJhdGlvbjogaW50KToKICAgIGF3YWl0IGN0eC5zZW5kKGYiUmVjb3JkaW5nIGF1ZGlvIGZvciB7ZHVyYXRpb259IHNlY29uZHMuLi4iKQogICAgYXVkaW9fZmlsZSA9IHJlY29yZF9hdWRpbyhkdXJhdGlvbikKICAgIGF3YWl0IHNlbmRfZmlsZShjdHgsIGF1ZGlvX2ZpbGUpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgcmVjd2ViY2FtKGN0eCwgZHVyYXRpb246IGludCk6CiAgICBhd2FpdCBjdHguc2VuZChmIlJlY29yZGluZyB3ZWJjYW0gZm9yIHtkdXJhdGlvbn0gc2Vjb25kcy4uLiIpCiAgICB3ZWJjYW1fZmlsZSA9IHJlY29yZF93ZWJjYW0oZHVyYXRpb24pCiAgICBhd2FpdCBzZW5kX2ZpbGUoY3R4LCB3ZWJjYW1fZmlsZSkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBzaGVsbChjdHgsICosIGNtZDogc3RyKToKICAgIHRyeToKICAgICAgICBwcm9jZXNzID0gc3VicHJvY2Vzcy5Qb3BlbigKICAgICAgICAgICAgWyJwb3dlcnNoZWxsLmV4ZSIsICItQ29tbWFuZCIsIGNtZF0sIAogICAgICAgICAgICBzdGRvdXQ9c3VicHJvY2Vzcy5QSVBFLAogICAgICAgICAgICBzdGRlcnI9c3VicHJvY2Vzcy5QSVBFLAogICAgICAgICAgICB0ZXh0PVRydWUKICAgICAgICApCgogICAgICAgIHN0ZG91dCwgc3RkZXJyID0gcHJvY2Vzcy5jb21tdW5pY2F0ZSgpCgogICAgICAgIGlmIHByb2Nlc3MucmV0dXJuY29kZSA9PSAwOgogICAgICAgICAgICBvdXRwdXQgPSBzdGRvdXQKICAgICAgICBlbHNlOgogICAgICAgICAgICBvdXRwdXQgPSBzdGRlcnIKCiAgICAgICAgaWYgbGVuKG91dHB1dCkgPiAyMDAwOgogICAgICAgICAgICB0ZW1wX2ZpbGVfcGF0aCA9IG9zLnBhdGguam9pbih0ZW1wX2ZvbGRlciwgImNvbW1hbmRfb3V0cHV0LnR4dCIpCgogICAgICAgICAgICB3aXRoIG9wZW4odGVtcF9maWxlX3BhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGUob3V0cHV0KQoKICAgICAgICAgICAgYXdhaXQgY3R4LnNlbmQoCiAgICAgICAgICAgICAgICBjb250ZW50PSJUaGUgb3V0cHV0IHdhcyB0b28gbG9uZywgc28gaXQgaGFzIGJlZW4gc2F2ZWQgdG8gYSBmaWxlLiBZb3UgY2FuIGRvd25sb2FkIGl0IGJlbG93OiIsCiAgICAgICAgICAgICAgICBmaWxlPWRpc2NvcmQuRmlsZSh0ZW1wX2ZpbGVfcGF0aCkKICAgICAgICAgICAgKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLwn5K7IENvbW1hbmQgT3V0cHV0IiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiRXhlY3V0ZWQgY29tbWFuZDogYHtjbWR9YCIsCiAgICAgICAgICAgICAgICBjb2xvcj0weDAwZmYwMAogICAgICAgICAgICApCiAgICAgICAgICAgIGVtYmVkLmFkZF9maWVsZChuYW1lPSJPdXRwdXQiLCB2YWx1ZT1vdXRwdXQsIGlubGluZT1GYWxzZSkKICAgICAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IuKdjCBDb21tYW5kIEVycm9yIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSBleGVjdXRpbmcgdGhlIGNvbW1hbmQ6IHtzdHIoZSl9IiwKICAgICAgICAgICAgY29sb3I9MHhmZjAwMDAKICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgpkZWYgd3JpdGVfdG9fZmlsZShrZXlzKToKICAgIHdpdGggb3Blbihsb2dfZmlsZV9wYXRoLCAnYScpIGFzIGZpbGU6CiAgICAgICAgZm9yIGtleSBpbiBrZXlzOgogICAgICAgICAgICBmaWxlLndyaXRlKGYie2tleX1cbiIpCgpkZWYgb25fcHJlc3Moa2V5KToKICAgIGtleV9sb2cuYXBwZW5kKHN0cihrZXkpKQoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIGtleWxvZ19zdGFydChjdHgpOgogICAgZ2xvYmFsIGtleWxvZ19saXN0ZW5lciwga2V5X2xvZwoKICAgIGtleV9sb2cgPSBbXQogICAgaWYgb3MucGF0aC5leGlzdHMobG9nX2ZpbGVfcGF0aCk6CiAgICAgICAgb3MucmVtb3ZlKGxvZ19maWxlX3BhdGgpCiAgICAKICAgIGlmIGtleWxvZ19saXN0ZW5lciBpcyBOb25lOgogICAgICAgIGtleWxvZ19saXN0ZW5lciA9IGtleWJvYXJkLkxpc3RlbmVyKG9uX3ByZXNzPW9uX3ByZXNzKQogICAgICAgIGtleWxvZ19saXN0ZW5lci5zdGFydCgpCiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i4oyoIEtleWxvZ2dpbmciLAogICAgICAgICAgICBkZXNjcmlwdGlvbj0iS2V5bG9nZ2VyIHN0YXJ0ZWQgYW5kIGxvZ2dpbmcga2V5c3Ryb2tlcy4iLAogICAgICAgICAgICBjb2xvcj0weDAwZmYwMAogICAgICAgICkKICAgICAgICAKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBrZXlsb2dfc3RvcChjdHgpOgogICAgZ2xvYmFsIGtleWxvZ19saXN0ZW5lcgoKICAgIGlmIGtleWxvZ19saXN0ZW5lciBpcyBub3QgTm9uZToKICAgICAgICBrZXlsb2dfbGlzdGVuZXIuc3RvcCgpCiAgICAgICAga2V5bG9nX2xpc3RlbmVyID0gTm9uZQogICAgICAgIHdyaXRlX3RvX2ZpbGUoa2V5X2xvZykKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLijKggS2V5bG9nZ2luZyIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJLZXlsb2dnZXIgc3RvcHBlZCBhbmQgZGF0YSBzYXZlZCEiLAogICAgICAgICAgICBjb2xvcj0weDAwZmYwMAogICAgICAgICkKICAgICAgICAKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBrZXlsb2dfZHVtcChjdHgpOgogICAgaWYgb3MucGF0aC5leGlzdHMobG9nX2ZpbGVfcGF0aCk6CiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZmlsZT1kaXNjb3JkLkZpbGUobG9nX2ZpbGVfcGF0aCwgImh6emgudHh0IikpCiAgICBlbHNlOgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IuKMqCBLZXlsb2dnaW5nIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249Ik5vIGtleWxvZyBkYXRhIGF2YWlsYWJsZS4gU3RhcnQgdGhlIGtleWxvZ2dlciBmaXJzdCB3aXRoIGAha2V5bG9nX3N0YXJ0YCIsCiAgICAgICAgICAgIGNvbG9yPTB4MDBmZjAwCiAgICAgICAgKQogICAgICAgIAogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIGVuY3J5cHQoY3R4LCAqYXJncyk6CiAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQodGl0bGU9IvCflJAgRW5jcnlwdCBDb21tYW5kIiwgY29sb3I9MHgwMGZmMDApCgogICAgaWYgbGVuKGFyZ3MpID09IDEgYW5kIGFyZ3NbMF0gPT0gIioiOgogICAgICAgIGVuY3J5cHRlZF9maWxlcyA9IFtdCiAgICAgICAgZm9yIGZpbGVuYW1lIGluIG9zLmxpc3RkaXIoY3VycmVudF9kaXJlY3RvcnkpOgogICAgICAgICAgICBmaWxlX3BhdGggPSBvcy5wYXRoLmpvaW4oY3VycmVudF9kaXJlY3RvcnksIGZpbGVuYW1lKQogICAgICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShmaWxlX3BhdGgpOgogICAgICAgICAgICAgICAgbmFtZSwgZXh0ID0gb3MucGF0aC5zcGxpdGV4dChmaWxlbmFtZSkKICAgICAgICAgICAgICAgIGlmIGV4dCAhPSAiLmh6emgiOgogICAgICAgICAgICAgICAgICAgIG5ld19uYW1lID0gbmFtZSArICIuaHp6aCIKICAgICAgICAgICAgICAgICAgICBuZXdfcGF0aCA9IG9zLnBhdGguam9pbihjdXJyZW50X2RpcmVjdG9yeSwgbmV3X25hbWUpCiAgICAgICAgICAgICAgICAgICAgb3MucmVuYW1lKGZpbGVfcGF0aCwgbmV3X3BhdGgpCiAgICAgICAgICAgICAgICAgICAgZW5jcnlwdGVkX2ZpbGVzLmFwcGVuZChmIntmaWxlbmFtZX0g4p6UIHtuZXdfbmFtZX0iKQogICAgICAgIAogICAgICAgIGlmIGVuY3J5cHRlZF9maWxlczoKICAgICAgICAgICAgZW1iZWQuZGVzY3JpcHRpb24gPSBmIkVuY3J5cHRlZCB0aGUgZm9sbG93aW5nIGZpbGVzOlxuIiArICJcbiIuam9pbihlbmNyeXB0ZWRfZmlsZXMpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZW1iZWQuZGVzY3JpcHRpb24gPSAiTm8gZmlsZXMgd2VyZSBlbmNyeXB0ZWQgKGFsbCB3ZXJlIGFscmVhZHkgaW4gLmh6emggZm9ybWF0KS4iCiAgICBlbGlmIGxlbihhcmdzKSA9PSAxOgogICAgICAgIGZpbGVfbmFtZSA9IGFyZ3NbMF0KICAgICAgICBmaWxlX3BhdGggPSBvcy5wYXRoLmpvaW4oY3VycmVudF9kaXJlY3RvcnksIGZpbGVfbmFtZSkKICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShmaWxlX3BhdGgpOgogICAgICAgICAgICBuYW1lLCBleHQgPSBvcy5wYXRoLnNwbGl0ZXh0KGZpbGVfbmFtZSkKICAgICAgICAgICAgaWYgZXh0ICE9ICIuaHp6aCI6CiAgICAgICAgICAgICAgICBuZXdfbmFtZSA9IG5hbWUgKyAiLmh6emgiCiAgICAgICAgICAgICAgICBuZXdfcGF0aCA9IG9zLnBhdGguam9pbihjdXJyZW50X2RpcmVjdG9yeSwgbmV3X25hbWUpCiAgICAgICAgICAgICAgICBvcy5yZW5hbWUoZmlsZV9wYXRoLCBuZXdfcGF0aCkKICAgICAgICAgICAgICAgIGVtYmVkLmRlc2NyaXB0aW9uID0gZiJFbmNyeXB0ZWQ6IHtmaWxlX25hbWV9IOKelCB7bmV3X25hbWV9IgogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZW1iZWQudGl0bGUgPSAi4p2MIEVuY3J5cHQgQ29tbWFuZCBFcnJvciIKICAgICAgICAgICAgICAgIGVtYmVkLmRlc2NyaXB0aW9uID0gZiJUaGUgZmlsZSB7ZmlsZV9uYW1lfSBpcyBhbHJlYWR5IGVuY3J5cHRlZC4iCiAgICAgICAgICAgICAgICBlbWJlZC5jb2xvciA9IDB4ZmYwMDAwCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZW1iZWQudGl0bGUgPSAi4p2MIEVuY3J5cHQgQ29tbWFuZCBFcnJvciIKICAgICAgICAgICAgZW1iZWQuZGVzY3JpcHRpb24gPSBmIkZpbGUge2ZpbGVfbmFtZX0gbm90IGZvdW5kIGluIHRoZSBjdXJyZW50IGRpcmVjdG9yeS4iCiAgICAgICAgICAgIGVtYmVkLmNvbG9yID0gMHhmZjAwMDAKICAgIGVsc2U6CiAgICAgICAgZW1iZWQudGl0bGUgPSAi4p2MIEVuY3J5cHQgQ29tbWFuZCBFcnJvciIKICAgICAgICBlbWJlZC5kZXNjcmlwdGlvbiA9ICJJbnZhbGlkIGFyZ3VtZW50ISBVc2UgYCFlbmNyeXB0ICpgIHRvIGVuY3J5cHQgYWxsIGZpbGVzIG9yIGAhZW5jcnlwdCA8ZmlsZS5leHRlbnNpb24+YCB0byBlbmNyeXB0IGEgc3BlY2lmaWMgZmlsZS4iCiAgICAgICAgZW1iZWQuY29sb3IgPSAweGZmMDAwMAoKICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIHRva2VucyhjdHgpOgogICAgZW1iZWQgPSBhd2FpdCB0b2tlbm91dHB1dChjdHgpCiAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBzY3JlZW5zYXZlcihjdHgpOgogICAgdHJ5OgogICAgICAgIHNjcmVlbnNhdmVyX3BhdGggPSByIkM6XFdpbmRvd3NcU3lzdGVtMzJcTXlzdGlmeS5zY3IiCiAgICAgICAgCiAgICAgICAgc3VicHJvY2Vzcy5Qb3Blbihbc2NyZWVuc2F2ZXJfcGF0aCwgJy9zJ10pCgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IvCflqXvuI8gU2NyZWVuc2F2ZXIgQWN0aXZhdGVkIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249IlRoZSBNeXN0aWZ5IHNjcmVlbnNhdmVyIGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSBzdGFydGVkISIsCiAgICAgICAgICAgIGNvbG9yPTB4MDBmZjAwCiAgICAgICAgKQogICAgICAgIAogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgIAogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IuKaoO+4jyBFcnJvciIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiRmFpbGVkIHRvIHN0YXJ0IHRoZSBzY3JlZW5zYXZlci4gRXJyb3I6IHtlfSIsCiAgICAgICAgICAgIGNvbG9yPTB4ZmYwMDAwCiAgICAgICAgKQogICAgICAgIAogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIHNtYXJ0dXAoY3R4KToKICAgIGlmIGlzX2FkbWluKCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBoenpoX3Rhc2tfc2NoZWR1bGVyKCkKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IuKchSBTdWNjZXNzIG9uIFNtYXJ0VXAhIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJTdWNjZXNmdWxseSBjb3BpZWQgaW50byBVbmtub3duIFN0YXJ0dXAgUGF0aCEg8J+QgCIgLAogICAgICAgICAgICAgICAgY29sb3I9ZGlzY29yZC5Db2xvci5ncmVlbigpCiAgICAgICAgICAgICkKICAgICAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i4p2MIEZhaWxlZCBTbWFydFVwISIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj0iRmFpbGVkIHRvIGNvcHkgaW50byBVbmtub3duIFBhdGghIiwKICAgICAgICAgICAgICAgIGNvbG9yPWRpc2NvcmQuQ29sb3IucmVkKCkKICAgICAgICAgICAgKQogICAgICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKICAgIGVsc2U6CiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IuKdjCBGYWlsZWQgU21hcnRVcCEiLAogICAgICAgICAgICAgICAgZGVzY3JpcHRpb249IlRoZSBTY3JpcHQgaXNuJ3QgcnVubmluZyB3aXRoIEFkbWluISBVc2UgIWdldGFkbWluIHRvIGdldCBBZG1pbiEiLAogICAgICAgICAgICAgICAgY29sb3I9ZGlzY29yZC5Db2xvci5yZWQoKQogICAgICAgICkKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBjbWRzcGFtKGN0eCk6CiAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgdGl0bGU9IuKchSBTdGFydGluZyB0byBTcGFtISIsCiAgICAgICAgZGVzY3JpcHRpb249IlN1Y2Nlc2Z1bGx5IHN0YXJ0ZWQgdG8gc3BhbSBDTUQgV2luZG93cyEiLAogICAgICAgIGNvbG9yPWRpc2NvcmQuQ29sb3IuZ3JlZW4oKQogICAgKQogICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgogICAgZGVmIHNwYW1fY21kKCk6CiAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgc3VicHJvY2Vzcy5Qb3Blbigic3RhcnQiLCBzaGVsbD1UcnVlKQoKICAgIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNwYW1fY21kKS5zdGFydCgpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgY2xvc2VzZXNzaW9uKGN0eCk6CiAgICBjdXJyZW50X3BpZCA9IG9zLmdldHBpZCgpCiAgICBjdXJyZW50X3Byb2Nlc3NfbmFtZSA9IHBzdXRpbC5Qcm9jZXNzKGN1cnJlbnRfcGlkKS5uYW1lKCkKCiAgICBpbnN0YW5jZXMgPSBbXQoKICAgIGZvciBwcm9jIGluIHBzdXRpbC5wcm9jZXNzX2l0ZXIoWydwaWQnLCAnbmFtZSddKToKICAgICAgICBpZiBwcm9jLmluZm9bJ25hbWUnXSA9PSBjdXJyZW50X3Byb2Nlc3NfbmFtZSBhbmQgcHJvYy5pbmZvWydwaWQnXSAhPSBjdXJyZW50X3BpZDoKICAgICAgICAgICAgaW5zdGFuY2VzLmFwcGVuZChwcm9jKQoKICAgIGlmIGxlbihpbnN0YW5jZXMpID09IDA6CiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i4pyFIE5vIER1cGxpY2F0ZSBTZXNzaW9ucyIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJObyBvdGhlciBydW5uaW5nIHNlc3Npb25zIG9mIHRoaXMgc2NyaXB0IHdlcmUgZm91bmQuIiwKICAgICAgICAgICAgY29sb3I9ZGlzY29yZC5Db2xvci5ncmVlbigpCiAgICAgICAgKQogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgIHJldHVybgoKICAgIGN1cnJlbnRfaXNfYWRtaW4gPSBpc19hZG1pbigpCgogICAgaWYgY3VycmVudF9pc19hZG1pbjoKICAgICAgICBjbG9zZWQgPSBbXQogICAgICAgIGZvciBwcm9jIGluIGluc3RhbmNlczoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcHN1dGlsLlByb2Nlc3MocHJvYy5pbmZvWydwaWQnXSkudGVybWluYXRlKCkKICAgICAgICAgICAgICAgIGNsb3NlZC5hcHBlbmQocHJvYy5pbmZvWydwaWQnXSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgcHJpbnQoZiJFcnJvciBjbG9zaW5nIHByb2Nlc3Mge3Byb2MuaW5mb1sncGlkJ119OiB7ZX0iKQoKICAgICAgICBpZiBjbG9zZWQ6CiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLimqDvuI8gRHVwbGljYXRlIFNlc3Npb25zIENsb3NlZCIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkNsb3NlZCB0aGUgZm9sbG93aW5nIGR1cGxpY2F0ZSBzZXNzaW9uKHMpOiB7Y2xvc2VkfSIsCiAgICAgICAgICAgICAgICBjb2xvcj1kaXNjb3JkLkNvbG9yLm9yYW5nZSgpCiAgICAgICAgICAgICkKICAgICAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IuKdjCBObyBTZXNzaW9ucyBDbG9zZWQiLAogICAgICAgICAgICAgICAgZGVzY3JpcHRpb249Ik5vIGR1cGxpY2F0ZSBzZXNzaW9ucyBjb3VsZCBiZSBjbG9zZWQuIiwKICAgICAgICAgICAgICAgIGNvbG9yPWRpc2NvcmQuQ29sb3IucmVkKCkKICAgICAgICAgICAgKQogICAgICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCiAgICBlbHNlOgogICAgICAgIGNsb3NlZCA9IFtdCiAgICAgICAgYWRtaW5faW5zdGFuY2VfZm91bmQgPSBGYWxzZQoKICAgICAgICBmb3IgcHJvYyBpbiBpbnN0YW5jZXM6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHAgPSBwc3V0aWwuUHJvY2Vzcyhwcm9jLmluZm9bJ3BpZCddKQogICAgICAgICAgICAgICAgaWYgY3R5cGVzLndpbmRsbC5zaGVsbDMyLklzVXNlckFuQWRtaW4oKSA9PSAwOgogICAgICAgICAgICAgICAgICAgIHAudGVybWluYXRlKCkKICAgICAgICAgICAgICAgICAgICBjbG9zZWQuYXBwZW5kKHByb2MuaW5mb1sncGlkJ10pCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGFkbWluX2luc3RhbmNlX2ZvdW5kID0gVHJ1ZQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBwcmludChmIkVycm9yIGNsb3NpbmcgcHJvY2VzcyB7cHJvYy5pbmZvWydwaWQnXX06IHtlfSIpCgogICAgICAgIGlmIGNsb3NlZDoKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IuKaoO+4jyBOb24tQWRtaW4gU2Vzc2lvbnMgQ2xvc2VkIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiQ2xvc2VkIHRoZSBmb2xsb3dpbmcgbm9uLWFkbWluIHNlc3Npb24ocyk6IHtjbG9zZWR9IiwKICAgICAgICAgICAgICAgIGNvbG9yPWRpc2NvcmQuQ29sb3Iub3JhbmdlKCkKICAgICAgICAgICAgKQogICAgICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKICAgICAgICBlbGlmIGFkbWluX2luc3RhbmNlX2ZvdW5kOgogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i4pqg77iPIEFkbWluIFNlc3Npb24gRm91bmQiLAogICAgICAgICAgICAgICAgZGVzY3JpcHRpb249IkFuIGFkbWluIHNlc3Npb24gaXMgcnVubmluZy4gTm8gbm9uLWFkbWluIHNlc3Npb25zIHdlcmUgY2xvc2VkLiIsCiAgICAgICAgICAgICAgICBjb2xvcj1kaXNjb3JkLkNvbG9yLnllbGxvdygpCiAgICAgICAgICAgICkKICAgICAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IuKdjCBObyBTZXNzaW9ucyBDbG9zZWQiLAogICAgICAgICAgICAgICAgZGVzY3JpcHRpb249Ik5vIGR1cGxpY2F0ZSBub24tYWRtaW4gc2Vzc2lvbnMgd2VyZSBmb3VuZCB0byBjbG9zZS4iLAogICAgICAgICAgICAgICAgY29sb3I9ZGlzY29yZC5Db2xvci5yZWQoKQogICAgICAgICAgICApCiAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKZGVmIG1ha2Vfbm9uX2NyaXRpY2FsKCk6CiAgICBoUHJvY2VzcyA9IGN0eXBlcy53aW5kbGwua2VybmVsMzIuR2V0Q3VycmVudFByb2Nlc3MoKQogICAgY3R5cGVzLndpbmRsbC5udGRsbC5SdGxTZXRQcm9jZXNzSXNDcml0aWNhbCgwLCAwLCAwKQogICAgcmV0dXJuIFRydWUKCmRlZiBtYWtlX2NyaXRpY2FsKCk6CiAgICBoUHJvY2VzcyA9IGN0eXBlcy53aW5kbGwua2VybmVsMzIuR2V0Q3VycmVudFByb2Nlc3MoKQogICAgY3R5cGVzLndpbmRsbC5udGRsbC5SdGxTZXRQcm9jZXNzSXNDcml0aWNhbCgxLCAwLCAwKQogICAgcmV0dXJuIFRydWUKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiB1bmNyaXRwcm9jKGN0eCk6CiAgICBpZiBjdHlwZXMud2luZGxsLnNoZWxsMzIuSXNVc2VyQW5BZG1pbigpICE9IDE6CiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i4p2MIEFkbWluIFByaXZpbGVnZXMgUmVxdWlyZWQiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj0iUGxlYXNlIHJ1biB0aGUgcHJvZ3JhbSB3aXRoIEFkbWluaXN0cmF0b3IgcHJpdmlsZWdlcyEiLAogICAgICAgICAgICBjb2xvcj1kaXNjb3JkLkNvbG9yLnJlZCgpCiAgICAgICAgKQogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgIHJldHVybgoKICAgIHRyeToKICAgICAgICBpZiBtYWtlX25vbl9jcml0aWNhbCgpOgogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i4pyFIE5vbi1Dcml0aWNhbCBQcm9jZXNzIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJUaGUgcHJvY2VzcyBoYXMgYmVlbiBtYWRlIG5vbi1jcml0aWNhbC4gSXQgY2FuIG5vdyBiZSBzYWZlbHkgY2xvc2VkIHdpdGhvdXQgY2F1c2luZyBhIEJTT0QuIiwKICAgICAgICAgICAgICAgIGNvbG9yPWRpc2NvcmQuQ29sb3IuZ3JlZW4oKQogICAgICAgICAgICApCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IuKdjCBFcnJvciIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj0iRmFpbGVkIHRvIG1hcmsgdGhlIHByb2Nlc3MgYXMgbm9uLWNyaXRpY2FsLiIsCiAgICAgICAgICAgICAgICBjb2xvcj1kaXNjb3JkLkNvbG9yLnJlZCgpCiAgICAgICAgICAgICkKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i4p2MIEVycm9yIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJBbiBlcnJvciBvY2N1cnJlZDoge2V9IiwKICAgICAgICAgICAgY29sb3I9ZGlzY29yZC5Db2xvci5yZWQoKQogICAgICAgICkKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBjcml0cHJvYyhjdHgpOgogICAgaWYgY3R5cGVzLndpbmRsbC5zaGVsbDMyLklzVXNlckFuQWRtaW4oKSAhPSAxOgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IuKdjCBBZG1pbiBQcml2aWxlZ2VzIFJlcXVpcmVkIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249IlBsZWFzZSBydW4gdGhlIHByb2dyYW0gd2l0aCBBZG1pbmlzdHJhdG9yIHByaXZpbGVnZXMhIiwKICAgICAgICAgICAgY29sb3I9ZGlzY29yZC5Db2xvci5yZWQoKQogICAgICAgICkKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKICAgICAgICByZXR1cm4KCiAgICB0cnk6CiAgICAgICAgaWYgbWFrZV9jcml0aWNhbCgpOgogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i4pqg77iPIENyaXRpY2FsIFByb2Nlc3MiLAogICAgICAgICAgICAgICAgZGVzY3JpcHRpb249IlRoZSBwcm9jZXNzIGhhcyBiZWVuIG1hZGUgY3JpdGljYWwuIENsb3NpbmcgaXQgd2lsbCBjYXVzZSBhIEJTT0QhIiwKICAgICAgICAgICAgICAgIGNvbG9yPWRpc2NvcmQuQ29sb3Iub3JhbmdlKCkKICAgICAgICAgICAgKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLinYwgRXJyb3IiLAogICAgICAgICAgICAgICAgZGVzY3JpcHRpb249IkZhaWxlZCB0byBtYXJrIHRoZSBwcm9jZXNzIGFzIGNyaXRpY2FsLiIsCiAgICAgICAgICAgICAgICBjb2xvcj1kaXNjb3JkLkNvbG9yLnJlZCgpCiAgICAgICAgICAgICkKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i4p2MIEVycm9yIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJBbiBlcnJvciBvY2N1cnJlZDoge2V9IiwKICAgICAgICAgICAgY29sb3I9ZGlzY29yZC5Db2xvci5yZWQoKQogICAgICAgICkKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBub3N0YXJ0dXBfZGlzYWJsZShjdHgpOgogICAgaXNfYWRtaW4gPSBjdHlwZXMud2luZGxsLnNoZWxsMzIuSXNVc2VyQW5BZG1pbigpICE9IDAKICAgIGlmIG5vdCBpc19hZG1pbjoKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLinZcgQWRtaW4gUHJpdmlsZWdlcyBSZXF1aXJlZCIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJUaGlzIGNvbW1hbmQgcmVxdWlyZXMgYWRtaW4gcHJpdmlsZWdlcyB0byBleGVjdXRlLiIsCiAgICAgICAgICAgIGNvbG9yPTB4RkYwMDAwCiAgICAgICAgKQogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgIHJldHVybgoKICAgIHVzZXJuYW1lID0gb3MuZ2V0bG9naW4oKQogICAgc3RhcnR1cF9mb2xkZXIgPSBvcy5wYXRoLmpvaW4oCiAgICAgICAgb3MuZ2V0ZW52KCdBUFBEQVRBJyksCiAgICAgICAgcidNaWNyb3NvZnRcV2luZG93c1xTdGFydCBNZW51XFByb2dyYW1zXFN0YXJ0dXAnCiAgICApCgogICAgdHJ5OgogICAgICAgIGNvbW1hbmQgPSBmJ2ljYWNscyAie3N0YXJ0dXBfZm9sZGVyfSIgL3JlbW92ZTpkIHt1c2VybmFtZX0nCiAgICAgICAgcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oY29tbWFuZCwgc2hlbGw9VHJ1ZSwgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSkKCiAgICAgICAgaWYgcmVzdWx0LnJldHVybmNvZGUgPT0gMDoKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IvCflJMgU3RhcnR1cCBGb2xkZXIgVW5ibG9ja2VkIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiU3VjY2Vzc2Z1bGx5IHJlc3RvcmVkIGFjY2VzcyB0byB0aGUgU3RhcnR1cCBmb2xkZXIgZm9yIHVzZXIgKip7dXNlcm5hbWV9KiouIiwKICAgICAgICAgICAgICAgIGNvbG9yPTB4MDBGRjAwCiAgICAgICAgICAgICkKICAgICAgICBlbHNlOgogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i4p2XIEVycm9yIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiRmFpbGVkIHRvIHVuYmxvY2sgdGhlIFN0YXJ0dXAgZm9sZGVyOlxuYGBge3Jlc3VsdC5zdGRlcnIuZGVjb2RlKCl9YGBgIiwKICAgICAgICAgICAgICAgIGNvbG9yPTB4RkYwMDAwCiAgICAgICAgICAgICkKCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IuKdlyBFcnJvciIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiQW4gZXJyb3Igb2NjdXJyZWQgd2hpbGUgZXhlY3V0aW5nIHRoZSBjb21tYW5kOlxuYGBge2V9YGBgIiwKICAgICAgICAgICAgY29sb3I9MHhGRjAwMDAKICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgbm9zdGFydHVwKGN0eCk6CiAgICBpc19hZG1pbiA9IGN0eXBlcy53aW5kbGwuc2hlbGwzMi5Jc1VzZXJBbkFkbWluKCkgIT0gMAogICAgaWYgbm90IGlzX2FkbWluOgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IuKdlyBBZG1pbiBQcml2aWxlZ2VzIFJlcXVpcmVkIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249IlRoaXMgY29tbWFuZCByZXF1aXJlcyBhZG1pbiBwcml2aWxlZ2VzIHRvIGV4ZWN1dGUuIiwKICAgICAgICAgICAgY29sb3I9MHhGRjAwMDAKICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCiAgICAgICAgcmV0dXJuCgogICAgdXNlcm5hbWUgPSBvcy5nZXRsb2dpbigpCiAgICBzdGFydHVwX2ZvbGRlciA9IG9zLnBhdGguam9pbigKICAgICAgICBvcy5nZXRlbnYoJ0FQUERBVEEnKSwKICAgICAgICByJ01pY3Jvc29mdFxXaW5kb3dzXFN0YXJ0IE1lbnVcUHJvZ3JhbXNcU3RhcnR1cCcKICAgICkKCiAgICB0cnk6CiAgICAgICAgY29tbWFuZCA9IGYnaWNhY2xzICJ7c3RhcnR1cF9mb2xkZXJ9IiAvZGVueSB7dXNlcm5hbWV9OkYnCiAgICAgICAgcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oY29tbWFuZCwgc2hlbGw9VHJ1ZSwgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSkKCiAgICAgICAgaWYgcmVzdWx0LnJldHVybmNvZGUgPT0gMDoKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IvCflJIgU3RhcnR1cCBGb2xkZXIgQmxvY2tlZCIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj1mIlN1Y2Nlc3NmdWxseSBibG9ja2VkIGFjY2VzcyB0byB0aGUgU3RhcnR1cCBmb2xkZXIgZm9yIHVzZXIgKip7dXNlcm5hbWV9KiouIiwKICAgICAgICAgICAgICAgIGNvbG9yPTB4RkYwMDAwCiAgICAgICAgICAgICkKICAgICAgICBlbHNlOgogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i4p2XIEVycm9yIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiRmFpbGVkIHRvIGJsb2NrIHRoZSBTdGFydHVwIGZvbGRlcjpcbmBgYHtyZXN1bHQuc3RkZXJyLmRlY29kZSgpfWBgYCIsCiAgICAgICAgICAgICAgICBjb2xvcj0weEZGMDAwMAogICAgICAgICAgICApCgogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLinZcgRXJyb3IiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkFuIGVycm9yIG9jY3VycmVkIHdoaWxlIGV4ZWN1dGluZyB0aGUgY29tbWFuZDpcbmBgYHtlfWBgYCIsCiAgICAgICAgICAgIGNvbG9yPTB4RkYwMDAwCiAgICAgICAgKQogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIHRhc2ttZ3JfZW5hYmxlKGN0eCk6CiAgICBpc19hZG1pbiA9IGN0eXBlcy53aW5kbGwuc2hlbGwzMi5Jc1VzZXJBbkFkbWluKCkgIT0gMAogICAgaWYgaXNfYWRtaW46CiAgICAgICAgdHJ5OgogICAgICAgICAgICBkZWYgY2hlY2tfdGFza21ncl9kaXNhYmxlZCgpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHJlZ19rZXkgPSByZWcuT3BlbktleShyZWcuSEtFWV9DVVJSRU5UX1VTRVIsIHInU09GVFdBUkVcTWljcm9zb2Z0XFdpbmRvd3NcQ3VycmVudFZlcnNpb25cUG9saWNpZXNcU3lzdGVtJykKICAgICAgICAgICAgICAgICAgICB2YWx1ZSwgXyA9IHJlZy5RdWVyeVZhbHVlRXgocmVnX2tleSwgIkRpc2FibGVUYXNrTWdyIikKICAgICAgICAgICAgICAgICAgICByZWcuQ2xvc2VLZXkocmVnX2tleSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gMQogICAgICAgICAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICBpZiBjaGVja190YXNrbWdyX2Rpc2FibGVkKCk6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgcmVnX2tleSA9IHJlZy5PcGVuS2V5KHJlZy5IS0VZX0NVUlJFTlRfVVNFUiwgcidTT0ZUV0FSRVxNaWNyb3NvZnRcV2luZG93c1xDdXJyZW50VmVyc2lvblxQb2xpY2llc1xTeXN0ZW0nLCAwLCByZWcuS0VZX1NFVF9WQUxVRSkKICAgICAgICAgICAgICAgICAgICByZWcuRGVsZXRlVmFsdWUocmVnX2tleSwgIkRpc2FibGVUYXNrTWdyIikKICAgICAgICAgICAgICAgICAgICByZWcuQ2xvc2VLZXkocmVnX2tleSkKCiAgICAgICAgICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgICAgICAgICB0aXRsZT0i8J+UkyBUYXNrIE1hbmFnZXIgRW5hYmxlZCIsCiAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJUYXNrIE1hbmFnZXIgaGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IGVuYWJsZWQuIiwKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I9MHgwMEZGMDAKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgICAgICAgICB0aXRsZT0i4p2XIEVycm9yIiwKICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSBlbmFibGluZyBUYXNrIE1hbmFnZXI6IHtlfSIsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yPTB4RkYwMDAwCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgICAgIHRpdGxlPSLwn5+iIFRhc2sgTWFuYWdlciBBbHJlYWR5IEVuYWJsZWQiLAogICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJUYXNrIE1hbmFnZXIgaXMgYWxyZWFkeSBlbmFibGVkLiBObyBhY3Rpb24gbmVlZGVkLiIsCiAgICAgICAgICAgICAgICAgICAgY29sb3I9MHgwMEZGMDAKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IuKdlyBFcnJvciIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkFuIGVycm9yIG9jY3VycmVkOiB7ZX0iLAogICAgICAgICAgICAgICAgY29sb3I9MHhGRjAwMDAKICAgICAgICAgICAgKQogICAgICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKICAgIGVsc2U6CiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i8J+UkiBBZG1pbiBQcml2aWxlZ2VzIFJlcXVpcmVkIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249IlRoaXMgY29tbWFuZCByZXF1aXJlcyBhZG1pbiBwcml2aWxlZ2VzLiBQbGVhc2UgcnVuIHRoZSBib3QgYXMgYW4gYWRtaW5pc3RyYXRvci4iLAogICAgICAgICAgICBjb2xvcj0weEZGQTUwMAogICAgICAgICkKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiB0YXNrbWdyKGN0eCk6CiAgICBpc19hZG1pbiA9IGN0eXBlcy53aW5kbGwuc2hlbGwzMi5Jc1VzZXJBbkFkbWluKCkgIT0gMAogICAgaWYgaXNfYWRtaW46CiAgICAgICAgdHJ5OgogICAgICAgICAgICBnbG9iYWwgc3RhdHV1dXNzcwogICAgICAgICAgICBzdGF0dXV1c3NzID0gTm9uZQoKICAgICAgICAgICAgZGVmIGNoZWNrX3JlZ2lzdHJ5X2tleSgpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHJlZ19rZXkgPSByZWcuT3BlbktleShyZWcuSEtFWV9DVVJSRU5UX1VTRVIsIHInU09GVFdBUkVcTWljcm9zb2Z0XFdpbmRvd3NcQ3VycmVudFZlcnNpb25cUG9saWNpZXNcU3lzdGVtJykKICAgICAgICAgICAgICAgICAgICByZWcuQ2xvc2VLZXkocmVnX2tleSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgaWYgbm90IGNoZWNrX3JlZ2lzdHJ5X2tleSgpOgogICAgICAgICAgICAgICAgcmVnLkNyZWF0ZUtleShyZWcuSEtFWV9DVVJSRU5UX1VTRVIsIHInU09GVFdBUkVcTWljcm9zb2Z0XFdpbmRvd3NcQ3VycmVudFZlcnNpb25cUG9saWNpZXNcU3lzdGVtJykKCiAgICAgICAgICAgIHJlZ19rZXkgPSByZWcuT3BlbktleShyZWcuSEtFWV9DVVJSRU5UX1VTRVIsIHInU09GVFdBUkVcTWljcm9zb2Z0XFdpbmRvd3NcQ3VycmVudFZlcnNpb25cUG9saWNpZXNcU3lzdGVtJywgMCwgcmVnLktFWV9TRVRfVkFMVUUpCiAgICAgICAgICAgIHJlZy5TZXRWYWx1ZUV4KHJlZ19rZXksICJEaXNhYmxlVGFza01nciIsIDAsIHJlZy5SRUdfRFdPUkQsIDEpCiAgICAgICAgICAgIHJlZy5DbG9zZUtleShyZWdfa2V5KQoKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IvCfm6DvuI8gVGFzayBNYW5hZ2VyIERpc2FibGVkIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJTdWNjZXNzZnVsbHkgZGlzYWJsZWQgdGhlIFRhc2sgTWFuYWdlci4iLAogICAgICAgICAgICAgICAgY29sb3I9MHgwMEZGMDAKICAgICAgICAgICAgKQogICAgICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i4p2XIEVycm9yIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiQW4gZXJyb3Igb2NjdXJyZWQgd2hpbGUgZXhlY3V0aW5nIHRoZSBjb21tYW5kOiB7ZX0iLAogICAgICAgICAgICAgICAgY29sb3I9MHhGRjAwMDAKICAgICAgICAgICAgKQogICAgICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKICAgIGVsc2U6CiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i8J+UkiBBZG1pbiBQcml2aWxlZ2VzIFJlcXVpcmVkIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249IlRoaXMgY29tbWFuZCByZXF1aXJlcyBhZG1pbiBwcml2aWxlZ2VzLiBQbGVhc2UgcnVuIHRoZSBib3QgYXMgYW4gYWRtaW5pc3RyYXRvci4iLAogICAgICAgICAgICBjb2xvcj0weEZGQTUwMAogICAgICAgICkKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIGJsb2NrbGlzdChjdHgpOgogICAgbG9vcCA9IGFzeW5jaW8uZ2V0X2V2ZW50X2xvb3AoKQogICAgCiAgICBkZWYgYmxvY2tsaXN0X3Rhc2soKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGhvc3RmaWxlcGF0aCA9IG9zLnBhdGguam9pbihvcy5nZXRlbnYoJ3N5c3RlbXJvb3QnKSwgb3Muc2VwLmpvaW4oCiAgICAgICAgICAgICAgICBzdWJwcm9jZXNzLnJ1bigKICAgICAgICAgICAgICAgICAgICAnUkVHIFFVRVJZIEhLRVlfTE9DQUxfTUFDSElORVxcU1lTVEVNXFxDdXJyZW50Q29udHJvbFNldFxcU2VydmljZXNcXFRjcGlwXFxQYXJhbWV0ZXJzIC9WIERhdGFCYXNlUGF0aCcsCiAgICAgICAgICAgICAgICAgICAgc2hlbGw9VHJ1ZSwgY2FwdHVyZV9vdXRwdXQ9VHJ1ZQogICAgICAgICAgICAgICAgKS5zdGRvdXQuZGVjb2RlKGVycm9ycz0naWdub3JlJykuc3RyaXAoKS5zcGxpdGxpbmVzKClbLTFdLnNwbGl0KClbLTFdLnNwbGl0KG9zLnNlcClbMTpdKSwgJ2hvc3RzJykKICAgICAgICAgICAgCiAgICAgICAgICAgIHdpdGggb3Blbihob3N0ZmlsZXBhdGgpIGFzIGZpbGU6CiAgICAgICAgICAgICAgICBkYXRhID0gZmlsZS5yZWFkbGluZXMoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcmV0dXJuICJFcnJvciIKCiAgICAgICAgQkFOTkVEX1VSTHMgPSAoCiAgICAgICAgICAgICd2aXJ1c3RvdGFsLmNvbScsICdhdmFzdC5jb20nLCAndG90YWxhdi5jb20nLCAnc2Nhbmd1YXJkLmNvbScsICd0b3RhbGFkYmxvY2suY29tJywgJ3BjcHJvdGVjdC5jb20nLCAnbWNhZmVlLmNvbScsCiAgICAgICAgICAgICdiaXRkZWZlbmRlci5jb20nLCAndXMubm9ydG9uLmNvbScsICdhdmcuY29tJywgJ21hbHdhcmVieXRlcy5jb20nLCAncGFuZGFzZWN1cml0eS5jb20nLCAnYXZpcmEuY29tJywgJ25vcnRvbi5jb20nLAogICAgICAgICAgICAnZXNldC5jb20nLCAnemlsbHlhLmNvbScsICdrYXNwZXJza3kuY29tJywgJ3VzYS5rYXNwZXJza3kuY29tJywgJ3NvcGhvcy5jb20nLCAnaG9tZS5zb3Bob3MuY29tJywgJ2FkYXdhcmUuY29tJywKICAgICAgICAgICAgJ2J1bGxndWFyZC5jb20nLCAnY2xhbWF2Lm5ldCcsICdkcndlYi5jb20nLCAnZW1zaXNvZnQuY29tJywgJ2Ytc2VjdXJlLmNvbScsICd6b25lYWxhcm0uY29tJywgJ3RyZW5kbWljcm8uY29tJywKICAgICAgICAgICAgJ2NjbGVhbmVyLmNvbScsICdjb21vZG8uY29tJywgJ2ltbXVuZXQuY29tJywgJ3NweWJvdC5pbmZvJywgJ3N1cGVyYW50aXNweXdhcmUuY29tJywgJ3dlYnJvb3QuY29tJywgJ3NlY3VyZWFwbHVzLmNvbScsCiAgICAgICAgICAgICdoZWltZGFsc2VjdXJpdHkuY29tJywgJ2hlcmRwcm90ZWN0LmNvbScsICdxdWlja2hlYWwuY29tJywgJ3FpaG9vLmNvbScsICdiYWlkdWFudGl2aXJ1cy5jb20nLCAncGMtY2lsbGluLmNvbScsCiAgICAgICAgICAgICdmb3J0aW5ldC5jb20nLCAndmlwcmUuY29tJywgJ2lrYXJ1c3NlY3VyaXR5LmNvbScsICdmLXByb3QuY29tJywgJ2dkYXRhLmRlJywgJ2N5YmVyZWFzb24uY29tJywgJ3NlY3VyZW1hYy5jb20nLAogICAgICAgICAgICAnZ3JpZGluc29mdC5jb20nLCAnZW1pc29mdC5jb20nLCAnaGl0bWFucHJvLmNvbScsICdzb3Bob3Nob21lLmNvbScsICdhbnRpdmlydXNndWlkZS5jb20nLCAnYXJjYWJpdC5jb20nLAogICAgICAgICAgICAnYXNoYW1wb28uY29tJywgJ2F2Z3RocmVhdGxhYnMuY29tJywgJ2J1bGxndWFyZC5jb20nLCAnYnl0ZWhlcm8uY29tJywgJ2NoZWNrcG9pbnQuY29tJywgJ2Nsb3VkYnJpYy5jb20nLAogICAgICAgICAgICAnY3lyZW4uY29tJywgJ2VTY2FuQVYuY29tJywgJ2ZpbHNlY2xhYi5jb20nLCAnZnNlY3VyZS5jb20nLCAnazdjb21wdXRpbmcuY29tJywgJ25wcm90ZWN0LmNvbScsCiAgICAgICAgICAgICdtYXhzZWN1cmVhbnRpdmlydXMuY29tJywgJ2F2bC5jb20nLCAnc2hpZWxkYXBwcy5jb20nLCAnc3B5d2FyZXRlcm1pbmF0b3IuY29tJywgJ3ZpcnVzYnVzdGVyLmh1JywgJ3pvbmVyYW50aXZpcnVzLmNvbScsCiAgICAgICAgICAgICd0b3RhbGRlZmVuc2UuY29tJywgJ3RydXN0cG9ydC5jb20nLCAnYml0ZGVmZW5kZXIuZGUnLCAnYW50aXkuY29tJywgJ2FobmxhYi5jb20nLCAnYXJjYWJpdC5wbCcsICdiYWlkdXNlY3VyaXR5LmNvbScsCiAgICAgICAgICAgICduZXRza3kuY29tJywgJ3ppbGxpYW5zLm5ldCcsICdjbGVhcnNpZ2h0LmNvbScsICdzdW5iZWx0c2VjdXJpdHkuY29tJywgJ3BsdW1ieXRlcy5jb20nLCAnc2hpZWxkZW4uY29tJywKICAgICAgICAgICAgJ3Byb3RlY3RvcnBsdXMuY29tJywgJ2F4YW50aXZpcnVzLmNvbScsICdyaXNpbmctZ2xvYmFsLmNvbScKICAgICAgICApCgogICAgICAgIG5ld2RhdGEgPSBkYXRhWzpdCiAgICAgICAgZm9yIHVybCBpbiBCQU5ORURfVVJMczoKICAgICAgICAgICAgZW50cnkgPSBmIjEyNy4wLjAuMSB7dXJsfVxuIgogICAgICAgICAgICBpZiBub3QgYW55KFt1cmwgaW4gbGluZSBmb3IgbGluZSBpbiBkYXRhXSk6CiAgICAgICAgICAgICAgICBuZXdkYXRhLmFwcGVuZChlbnRyeSkKCiAgICAgICAgbmV3ZGF0YSA9ICcnLmpvaW4obmV3ZGF0YSkKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzdWJwcm9jZXNzLnJ1bihmImF0dHJpYiAtciB7aG9zdGZpbGVwYXRofSIsIHNoZWxsPVRydWUsIGNhcHR1cmVfb3V0cHV0PVRydWUpCiAgICAgICAgICAgIHdpdGggb3Blbihob3N0ZmlsZXBhdGgsICd3JykgYXMgZmlsZToKICAgICAgICAgICAgICAgIGZpbGUud3JpdGUobmV3ZGF0YSkKICAgICAgICAgICAgc3VicHJvY2Vzcy5ydW4oZiJhdHRyaWIgK3Ige2hvc3RmaWxlcGF0aH0iLCBzaGVsbD1UcnVlLCBjYXB0dXJlX291dHB1dD1UcnVlKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcmV0dXJuICJFcnJvciIKCiAgICAgICAgcmV0dXJuICJTdWNjZXNzIgoKICAgIHJlc3VsdCA9IGF3YWl0IGxvb3AucnVuX2luX2V4ZWN1dG9yKGV4ZWN1dG9yLCBibG9ja2xpc3RfdGFzaykKCiAgICBpZiByZXN1bHQgPT0gIlN1Y2Nlc3MiOgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IvCfpqAgQmxvY2tsaXN0IiwKICAgICAgICAgICAgZGVzY3JpcHRpb249IlN1Y2Nlc3NmdWxseSBibG9ja2VkIGFjY2VzcyB0byBhbGwgY29tbW9uIEFWIHNpdGVzIiwKICAgICAgICAgICAgY29sb3I9MHgwMEZGMDAKICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCiAgICBlbHNlOgogICAgICAgIGF3YWl0IGN0eC5zZW5kKCJBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSB1cGRhdGluZyB0aGUgYmxvY2tsaXN0LiIpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgdW5ibG9ja2xpc3QoY3R4KToKICAgIHRyeToKICAgICAgICBob3N0ZmlsZXBhdGggPSBvcy5wYXRoLmpvaW4oCiAgICAgICAgICAgIG9zLmdldGVudignc3lzdGVtcm9vdCcpLAogICAgICAgICAgICBvcy5zZXAuam9pbigKICAgICAgICAgICAgICAgIHN1YnByb2Nlc3MucnVuKAogICAgICAgICAgICAgICAgICAgICdSRUcgUVVFUlkgSEtFWV9MT0NBTF9NQUNISU5FXFxTWVNURU1cXEN1cnJlbnRDb250cm9sU2V0XFxTZXJ2aWNlc1xcVGNwaXBcXFBhcmFtZXRlcnMgL1YgRGF0YUJhc2VQYXRoJywKICAgICAgICAgICAgICAgICAgICBzaGVsbD1UcnVlLCBjYXB0dXJlX291dHB1dD1UcnVlCiAgICAgICAgICAgICAgICApLnN0ZG91dC5kZWNvZGUoZXJyb3JzPSdpZ25vcmUnKS5zdHJpcCgpLnNwbGl0bGluZXMoKVstMV0uc3BsaXQoKVstMV0uc3BsaXQob3Muc2VwKVsxOl0KICAgICAgICAgICAgKSwKICAgICAgICAgICAgJ2hvc3RzJwogICAgICAgICkKICAgICAgICB3aXRoIG9wZW4oaG9zdGZpbGVwYXRoKSBhcyBmaWxlOgogICAgICAgICAgICBkYXRhID0gZmlsZS5yZWFkbGluZXMoKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGF3YWl0IGN0eC5zZW5kKGYiRXJyb3I6IHtlfSIpCiAgICAgICAgcmV0dXJuCgogICAgQkFOTkVEX1VSTHMgPSAoCiAgICAgICAgICAgICd2aXJ1c3RvdGFsLmNvbScsICdhdmFzdC5jb20nLCAndG90YWxhdi5jb20nLCAnc2Nhbmd1YXJkLmNvbScsICd0b3RhbGFkYmxvY2suY29tJywgJ3BjcHJvdGVjdC5jb20nLCAnbWNhZmVlLmNvbScsCiAgICAgICAgICAgICdiaXRkZWZlbmRlci5jb20nLCAndXMubm9ydG9uLmNvbScsICdhdmcuY29tJywgJ21hbHdhcmVieXRlcy5jb20nLCAncGFuZGFzZWN1cml0eS5jb20nLCAnYXZpcmEuY29tJywgJ25vcnRvbi5jb20nLAogICAgICAgICAgICAnZXNldC5jb20nLCAnemlsbHlhLmNvbScsICdrYXNwZXJza3kuY29tJywgJ3VzYS5rYXNwZXJza3kuY29tJywgJ3NvcGhvcy5jb20nLCAnaG9tZS5zb3Bob3MuY29tJywgJ2FkYXdhcmUuY29tJywKICAgICAgICAgICAgJ2J1bGxndWFyZC5jb20nLCAnY2xhbWF2Lm5ldCcsICdkcndlYi5jb20nLCAnZW1zaXNvZnQuY29tJywgJ2Ytc2VjdXJlLmNvbScsICd6b25lYWxhcm0uY29tJywgJ3RyZW5kbWljcm8uY29tJywKICAgICAgICAgICAgJ2NjbGVhbmVyLmNvbScsICdjb21vZG8uY29tJywgJ2ltbXVuZXQuY29tJywgJ3NweWJvdC5pbmZvJywgJ3N1cGVyYW50aXNweXdhcmUuY29tJywgJ3dlYnJvb3QuY29tJywgJ3NlY3VyZWFwbHVzLmNvbScsCiAgICAgICAgICAgICdoZWltZGFsc2VjdXJpdHkuY29tJywgJ2hlcmRwcm90ZWN0LmNvbScsICdxdWlja2hlYWwuY29tJywgJ3FpaG9vLmNvbScsICdiYWlkdWFudGl2aXJ1cy5jb20nLCAncGMtY2lsbGluLmNvbScsCiAgICAgICAgICAgICdmb3J0aW5ldC5jb20nLCAndmlwcmUuY29tJywgJ2lrYXJ1c3NlY3VyaXR5LmNvbScsICdmLXByb3QuY29tJywgJ2dkYXRhLmRlJywgJ2N5YmVyZWFzb24uY29tJywgJ3NlY3VyZW1hYy5jb20nLAogICAgICAgICAgICAnZ3JpZGluc29mdC5jb20nLCAnZW1pc29mdC5jb20nLCAnaGl0bWFucHJvLmNvbScsICdzb3Bob3Nob21lLmNvbScsICdhbnRpdmlydXNndWlkZS5jb20nLCAnYXJjYWJpdC5jb20nLAogICAgICAgICAgICAnYXNoYW1wb28uY29tJywgJ2F2Z3RocmVhdGxhYnMuY29tJywgJ2J1bGxndWFyZC5jb20nLCAnYnl0ZWhlcm8uY29tJywgJ2NoZWNrcG9pbnQuY29tJywgJ2Nsb3VkYnJpYy5jb20nLAogICAgICAgICAgICAnY3lyZW4uY29tJywgJ2VTY2FuQVYuY29tJywgJ2ZpbHNlY2xhYi5jb20nLCAnZnNlY3VyZS5jb20nLCAnazdjb21wdXRpbmcuY29tJywgJ25wcm90ZWN0LmNvbScsCiAgICAgICAgICAgICdtYXhzZWN1cmVhbnRpdmlydXMuY29tJywgJ2F2bC5jb20nLCAnc2hpZWxkYXBwcy5jb20nLCAnc3B5d2FyZXRlcm1pbmF0b3IuY29tJywgJ3ZpcnVzYnVzdGVyLmh1JywgJ3pvbmVyYW50aXZpcnVzLmNvbScsCiAgICAgICAgICAgICd0b3RhbGRlZmVuc2UuY29tJywgJ3RydXN0cG9ydC5jb20nLCAnYml0ZGVmZW5kZXIuZGUnLCAnYW50aXkuY29tJywgJ2FobmxhYi5jb20nLCAnYXJjYWJpdC5wbCcsICdiYWlkdXNlY3VyaXR5LmNvbScsCiAgICAgICAgICAgICduZXRza3kuY29tJywgJ3ppbGxpYW5zLm5ldCcsICdjbGVhcnNpZ2h0LmNvbScsICdzdW5iZWx0c2VjdXJpdHkuY29tJywgJ3BsdW1ieXRlcy5jb20nLCAnc2hpZWxkZW4uY29tJywKICAgICAgICAgICAgJ3Byb3RlY3RvcnBsdXMuY29tJywgJ2F4YW50aXZpcnVzLmNvbScsICdyaXNpbmctZ2xvYmFsLmNvbScKICAgICkKCiAgICBuZXdkYXRhID0gW10KICAgIGZvciBsaW5lIGluIGRhdGE6CiAgICAgICAgaWYgbm90IGFueSh1cmwgaW4gbGluZSBhbmQgKCIxMjcuMC4wLjEiIGluIGxpbmUgb3IgIjo6MSIgaW4gbGluZSkgZm9yIHVybCBpbiBCQU5ORURfVVJMcyk6CiAgICAgICAgICAgIG5ld2RhdGEuYXBwZW5kKGxpbmUpCgogICAgbmV3ZGF0YSA9ICcnLmpvaW4obmV3ZGF0YSkucmVwbGFjZSgnXG5cbicsICdcbicpCgogICAgdHJ5OgogICAgICAgIHN1YnByb2Nlc3MucnVuKGYiYXR0cmliIC1yIHtob3N0ZmlsZXBhdGh9Iiwgc2hlbGw9VHJ1ZSwgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSkKICAgICAgICB3aXRoIG9wZW4oaG9zdGZpbGVwYXRoLCAndycpIGFzIGZpbGU6CiAgICAgICAgICAgIGZpbGUud3JpdGUobmV3ZGF0YSkKICAgICAgICBzdWJwcm9jZXNzLnJ1bihmImF0dHJpYiArciB7aG9zdGZpbGVwYXRofSIsIHNoZWxsPVRydWUsIGNhcHR1cmVfb3V0cHV0PVRydWUpCgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IvCflJMgVW5ibG9ja2xpc3QiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj0iU3VjY2VzZnVsbHkgdW5ibG9ja2VkIGFsbCBjb21tb24gQVYgc2l0ZXMhIiwKICAgICAgICAgICAgY29sb3I9MHgwMEZGMDAKICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZiJFcnJvcjoge2V9IikKICAgICAgICByZXR1cm4KCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBnZXRhZG1pbihjdHgpOgogICAgaWYgaXNfYWRtaW4oKToKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSJTdWNjZXNzIiwgCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJUaGUgdXNlciBhbHJlYWR5IGhhcyBhZG1pbiBwcml2aWxlZ2VzLiIsCiAgICAgICAgICAgIGNvbG9yPTB4MDBGRjAwCiAgICAgICAgKQogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgIHJldHVybgogICAgZWxzZToKICAgICAgICBkZWNsaW5lX2NvdW50ID0gMAoKICAgICAgICBpZiB0cmlnZ2VyX3VhYygpOgogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0iU3VjY2VzcyIsIAogICAgICAgICAgICAgICAgZGVzY3JpcHRpb249IlRoZSBzY3JpcHQgaGFzIGJlZW4gZWxldmF0ZWQgdG8gYWRtaW4gcHJpdmlsZWdlcy4iLAogICAgICAgICAgICAgICAgY29sb3I9MHgwMEZGMDAKICAgICAgICAgICAgKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSJGYWlsdXJlIiwgCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj0iVUFDIHdhcyBub3QgZ3JhbnRlZC4gVGhlIG9wZXJhdGlvbiB3YXMgY2FuY2VsZWQgb3IgZmFpbGVkLiIsCiAgICAgICAgICAgICAgICBjb2xvcj0weEZGMDAwMAogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICB3aGlsZSBub3QgdHJpZ2dlcl91YWMoKToKICAgICAgICAgICAgICAgIGRlY2xpbmVfY291bnQgKz0gMQoKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IlN1Y2Nlc3MiLCAKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiVGhlIHNjcmlwdCBoYXMgYmVlbiBlbGV2YXRlZCB0byBhZG1pbiBwcml2aWxlZ2VzIGFmdGVyIHtkZWNsaW5lX2NvdW50fSBkZWNsaW5lZCBhdHRlbXB0cy4iLAogICAgICAgICAgICAgICAgY29sb3I9MHgwMEZGMDAKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKICAgICAgICBleGl0KCkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBmbG9hdHBpYyhjdHgsIHNlY29uZHM6IGludCwgaW1hZ2VfdXJsOiBzdHIpOgogICAgdHJ5OgogICAgICAgIGF3YWl0IGN0eC5zZW5kKGYiRG93bmxvYWRpbmcgaW1hZ2UgYW5kIGRpc3BsYXlpbmcgZm9yIHtzZWNvbmRzfSBzZWNvbmRzLi4uIikKICAgICAgICBmaWxlX3BhdGggPSBkb3dubG9hZF9pbWFnZShpbWFnZV91cmwpCiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9Y3JlYXRlX3dpbmRvdywgYXJncz0oc2Vjb25kcywgZmlsZV9wYXRoKSkuc3RhcnQoKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGF3YWl0IGN0eC5zZW5kKGYiRXJyb3I6IHtzdHIoZSl9IikKCmltcG9ydCBzdWJwcm9jZXNzCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgZXhlYyhjdHgsIHBhdGg6IHN0cik6CiAgICB0cnk6CiAgICAgICAgcGF0aCA9IHBhdGgucmVwbGFjZSgiXFwiLCAiXFxcXCIpCiAgICAgICAgaWYgcGF0aC5lbmRzd2l0aCgnLmV4ZScpOgogICAgICAgICAgICBzdWJwcm9jZXNzLnJ1bihbJ2NtZCcsICcvYycsICdzdGFydCcsIHBhdGhdLCBjaGVjaz1UcnVlKQogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i4pyFIEZpbGUgRXhlY3V0ZWQgU3VjY2Vzc2Z1bGx5IiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiRXhlY3V0YWJsZSBmaWxlICd7cGF0aH0nIGhhcyBiZWVuIHJ1bi4iLAogICAgICAgICAgICAgICAgY29sb3I9MHgwMEZGMDAKICAgICAgICAgICAgKQogICAgICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKICAgICAgICAKICAgICAgICBlbGlmIHBhdGguZW5kc3dpdGgoKCcucG5nJywgJy5qcGcnLCAnLmpwZWcnLCAnLmdpZicpKToKICAgICAgICAgICAgc3VicHJvY2Vzcy5ydW4oWydzdGFydCcsIHBhdGhdLCBjaGVjaz1UcnVlLCBzaGVsbD1UcnVlKQogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i4pyFIEZpbGUgT3BlbmVkIFN1Y2Nlc3NmdWxseSIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkltYWdlIGZpbGUgJ3twYXRofScgaGFzIGJlZW4gb3BlbmVkLiIsCiAgICAgICAgICAgICAgICBjb2xvcj0weDAwRkYwMAogICAgICAgICAgICApCiAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgIAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLinYwgVW5zdXBwb3J0ZWQgRmlsZSBUeXBlIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiQ2Fubm90IGV4ZWN1dGUgb3Igb3BlbiBmaWxlIG9mIHR5cGUgJ3twYXRofScuIiwKICAgICAgICAgICAgICAgIGNvbG9yPTB4RkYwMDAwCiAgICAgICAgICAgICkKICAgICAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IuKdjCBGaWxlIEZhaWxlZCB0byBSdW4iLAogICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkFuIGVycm9yIG9jY3VycmVkOiB7c3RyKGUpfSIsCiAgICAgICAgICAgIGNvbG9yPTB4RkYwMDAwCiAgICAgICAgKQogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiB1cGxvYWQoY3R4LCBwYXRoOiBzdHIgPSBOb25lKToKICAgIHRyeToKICAgICAgICBpZiBub3QgcGF0aDoKICAgICAgICAgICAgcGF0aCA9IHRlbXBfZm9sZGVyCgogICAgICAgIGlmIGN0eC5tZXNzYWdlLmF0dGFjaG1lbnRzOgogICAgICAgICAgICBhdHRhY2htZW50ID0gY3R4Lm1lc3NhZ2UuYXR0YWNobWVudHNbMF0KCiAgICAgICAgICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbihwYXRoLCBhdHRhY2htZW50LmZpbGVuYW1lKQoKICAgICAgICAgICAgYXdhaXQgYXR0YWNobWVudC5zYXZlKGZpbGVfcGF0aCkKCiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLinIUgRmlsZSBEb3dubG9hZGVkIFN1Y2Nlc3NmdWxseSIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkZpbGUgJ3thdHRhY2htZW50LmZpbGVuYW1lfScgaGFzIGJlZW4gZG93bmxvYWRlZCB0byAne2ZpbGVfcGF0aH0nLiIsCiAgICAgICAgICAgICAgICBjb2xvcj0weDAwRkYwMAogICAgICAgICAgICApCiAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLimqDvuI8gTm8gQXR0YWNobWVudCBGb3VuZCIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj0iTm8gYXR0YWNobWVudCBmb3VuZCBpbiB0aGUgbWVzc2FnZS4gUGxlYXNlIGF0dGFjaCBhIGZpbGUgdG8gdXBsb2FkLiIsCiAgICAgICAgICAgICAgICBjb2xvcj0weEZGMDAwMAogICAgICAgICAgICApCiAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLinYwgRXJyb3IiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkFuIGVycm9yIG9jY3VycmVkOiB7c3RyKGUpfSIsCiAgICAgICAgICAgIGNvbG9yPTB4RkYwMDAwCiAgICAgICAgKQogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKY3VycmVudF9kaXJlY3RvcnkgPSBvcy5nZXRjd2QoKQpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgZG93bmxvYWRfZXh0KGN0eCwgZmlsZW5hbWU6IHN0cik6CiAgICB0cnk6CiAgICAgICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKGN1cnJlbnRfZGlyZWN0b3J5LCBmaWxlbmFtZSkKCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoZmlsZV9wYXRoKToKICAgICAgICAgICAgZXh0ZXJuYWxfYXBpX3VybCA9ICJodHRwczovL3RyYW5zZmVyLndoYWxlYm9uZS5pby8iCgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncmInKSBhcyBmaWxlOgogICAgICAgICAgICAgICAgaGVhZGVycyA9IHsKICAgICAgICAgICAgICAgICAgICAiTWF4LURvd25sb2FkcyI6ICIxIiwgIAogICAgICAgICAgICAgICAgICAgICJNYXgtRGF5cyI6ICI1IiAgICAgICAgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMucHV0KGV4dGVybmFsX2FwaV91cmwgKyBmaWxlbmFtZSwgZGF0YT1maWxlLCBoZWFkZXJzPWhlYWRlcnMpCgogICAgICAgICAgICBpZiByZXNwb25zZS5zdGF0dXNfY29kZSA9PSAyMDA6CiAgICAgICAgICAgICAgICB1cGxvYWRlZF9maWxlX3VybCA9IHJlc3BvbnNlLnRleHQKCiAgICAgICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICAgICAgdGl0bGU9IuKchSBGaWxlIFVwbG9hZGVkIFN1Y2Nlc3NmdWxseSIsCiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJZb3VyIGZpbGUgaGFzIGJlZW4gdXBsb2FkZWQhIFlvdSBjYW4gYWNjZXNzIGl0IGhlcmU6IHt1cGxvYWRlZF9maWxlX3VybH0iLAogICAgICAgICAgICAgICAgICAgIGNvbG9yPTB4MDBGRjAwCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgICAgICB0aXRsZT0i4p2MIFVwbG9hZCBGYWlsZWQiLAogICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiRmFpbGVkIHRvIHVwbG9hZCB0aGUgZmlsZS4gQVBJIFJlc3BvbnNlOiB7cmVzcG9uc2UudGV4dH0iLAogICAgICAgICAgICAgICAgICAgIGNvbG9yPTB4RkYwMDAwCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i4pqg77iPIEZpbGUgTm90IEZvdW5kIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiVGhlIGZpbGUgJ3tmaWxlbmFtZX0nIHdhcyBub3QgZm91bmQgaW4gdGhlIGN1cnJlbnQgZGlyZWN0b3J5LiIsCiAgICAgICAgICAgICAgICBjb2xvcj0weEZGMDAwMAogICAgICAgICAgICApCiAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSJFcnJvciIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiQW4gZXJyb3Igb2NjdXJyZWQ6IHtzdHIoZSl9IiwKICAgICAgICAgICAgY29sb3I9MHhGRjAwMDAKICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgcHVyZ2UoY3R4LCBhbW91bnQ6IGludCk6CiAgICB0cnk6CiAgICAgICAgYXdhaXQgY3R4LmNoYW5uZWwucHVyZ2UobGltaXQ9YW1vdW50KQogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IvCfmq4gUHVyZ2UiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj1mIlN1Y2Nlc3NmdWxseSBwdXJnZWQge2Ftb3VudH0gbWVzc2FnZXMgZnJvbSB0aGlzIGNoYW5uZWwuIiwKICAgICAgICAgICAgY29sb3I9MHgwMDAwOEIKICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZiJFcnJvcjoge3N0cihlKX0iKQoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIHJlY3JlYXRlKGN0eCwgY2hhbm5lbDogZGlzY29yZC5UZXh0Q2hhbm5lbCk6CiAgICB0cnk6CiAgICAgICAgYXdhaXQgY2hhbm5lbC5kZWxldGUoKQogICAgICAgIGF3YWl0IGN0eC5ndWlsZC5jcmVhdGVfdGV4dF9jaGFubmVsKGNoYW5uZWwubmFtZSkKICAgICAgICAKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLwn5SEIENoYW5uZWwgUmVjcmVhdGVkIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJDaGFubmVsIHtjaGFubmVsLm5hbWV9IGhhcyBiZWVuIGRlbGV0ZWQgYW5kIHJlY3JlYXRlZC4iLAogICAgICAgICAgICBjb2xvcj0weDAwMDA4QgogICAgICAgICkKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBhd2FpdCBjdHguc2VuZChmIkVycm9yOiB7c3RyKGUpfSIpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgbmV0KGN0eCk6CiAgICB0cnk6CiAgICAgICAgYm90bmV0X2NoYW5uZWwgPSBkaXNjb3JkLnV0aWxzLmdldChjdHguZ3VpbGQudGV4dF9jaGFubmVscywgbmFtZT0iYm90bmV0IikKICAgICAgICAKICAgICAgICBpZiBib3RuZXRfY2hhbm5lbDoKICAgICAgICAgICAgYXdhaXQgYm90bmV0X2NoYW5uZWwuZGVsZXRlKCkKICAgICAgICAgICAgYXdhaXQgY3R4Lmd1aWxkLmNyZWF0ZV90ZXh0X2NoYW5uZWwoImJvdG5ldCIpCiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLimqEgQm90bmV0IFJlY3JlYXRlZCIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj0iVGhlIEJvdG5ldCBjaGFubmVsIGhhcyBiZWVuIHJlY3JlYXRlZC4iLAogICAgICAgICAgICAgICAgY29sb3I9MHgwMDAwOEIKICAgICAgICAgICAgKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGF3YWl0IGN0eC5ndWlsZC5jcmVhdGVfdGV4dF9jaGFubmVsKCJib3RuZXQiKQogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i4pqhIEJvdG5ldCBDcmVhdGVkIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJUaGUgQm90bmV0IGNoYW5uZWwgaGFzIGJlZW4gY3JlYXRlZC4iLAogICAgICAgICAgICAgICAgY29sb3I9MHgwMDAwOEIKICAgICAgICAgICAgKQoKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBhd2FpdCBjdHguc2VuZChmIkVycm9yOiB7c3RyKGUpfSIpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgYWRtaW4oY3R4KToKICAgIHRyeToKICAgICAgICBpZiBpc19hZG1pbigpOgogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i8J+UpyBBZG1pbiBQZXJtaXNzaW9ucyIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj0iVGhlIGNvbW1hbmQgaXMgcnVubmluZyB3aXRoIGFkbWluIHByaXZpbGVnZXMgb24gdGhlIG1hY2hpbmUhIPCfm6DvuI8iLAogICAgICAgICAgICAgICAgY29sb3I9MHgwMGZmMDAKICAgICAgICAgICAgKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLwn5SnIEFkbWluIFBlcm1pc3Npb25zIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJUaGUgY29tbWFuZCBpcyBub3QgcnVubmluZyB3aXRoIGFkbWluIHByaXZpbGVnZXMgb24gdGhlIG1hY2hpbmUuIOKdjCIsCiAgICAgICAgICAgICAgICBjb2xvcj0weGZmMDAwMAogICAgICAgICAgICApCgogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBhd2FpdCBjdHguc2VuZChmIkVycm9yOiB7c3RyKGUpfSIpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgY2xpcGJvYXJkKGN0eCk6CiAgICB0cnk6CiAgICAgICAgY2xpcGJvYXJkX2NvbnRlbnQgPSBweXBlcmNsaXAucGFzdGUoKQogICAgICAgIGlmIGNsaXBib2FyZF9jb250ZW50OgogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i8J+TiyBDbGlwYm9hcmQgQ29udGVudCIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkhlcmUgaXMgdGhlIGNvbnRlbnQgb2YgdGhlIGNsaXBib2FyZDoiLAogICAgICAgICAgICAgICAgY29sb3I9MHgwMGZmMDAKICAgICAgICAgICAgKQogICAgICAgICAgICBlbWJlZC5hZGRfZmllbGQobmFtZT0iQ2xpcGJvYXJkIENvbnRlbnQiLCB2YWx1ZT1jbGlwYm9hcmRfY29udGVudCwgaW5saW5lPUZhbHNlKQogICAgICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBhd2FpdCBjdHguc2VuZCgiQ2xpcGJvYXJkIGlzIGVtcHR5LiIpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGF3YWl0IGN0eC5zZW5kKGYiRXJyb3I6IHtzdHIoZSl9IikKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiB3YWxscGFwZXIoY3R4KToKICAgIHRyeToKICAgICAgICBpZiBsZW4oY3R4Lm1lc3NhZ2UuYXR0YWNobWVudHMpID4gMDogIAogICAgICAgICAgICBhdHRhY2htZW50ID0gY3R4Lm1lc3NhZ2UuYXR0YWNobWVudHNbMF0KICAgICAgICAgICAgaW1hZ2VfdXJsID0gYXR0YWNobWVudC51cmwKICAgICAgICAgICAgaW1hZ2VfcGF0aCA9IG9zLnBhdGguam9pbih0ZW1wX2ZvbGRlciwgIndhbGxwYXBlci5qcGciKQoKICAgICAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQoaW1hZ2VfdXJsKQogICAgICAgICAgICB3aXRoIG9wZW4oaW1hZ2VfcGF0aCwgJ3diJykgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGUocmVzcG9uc2UuY29udGVudCkKCiAgICAgICAgICAgIGNoYW5nZV93YWxscGFwZXJfd2luZG93cyhpbWFnZV9wYXRoKQoKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IvCflrzvuI8gV2FsbHBhcGVyIENoYW5nZSIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj1mIldhbGxwYXBlciBoYXMgYmVlbiBzZXQgdG86IHtpbWFnZV91cmx9IiwKICAgICAgICAgICAgICAgIGNvbG9yPTB4MDBmZjAwCiAgICAgICAgICAgICkKICAgICAgICAgICAgZW1iZWQuc2V0X2ltYWdlKHVybD1pbWFnZV91cmwpCiAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKCJObyBhdHRhY2htZW50IGZvdW5kISBQbGVhc2UgYXR0YWNoIGFuIGltYWdlIGZvciB0aGUgd2FsbHBhcGVyLiIpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGF3YWl0IGN0eC5zZW5kKGYiRXJyb3I6IHtzdHIoZSl9IikKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBwdWJsaWNpcChjdHgpOgogICAgdHJ5OgogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KCdodHRwczovL2FwaS5pcGlmeS5vcmc/Zm9ybWF0PWpzb24nKQogICAgICAgIHB1YmxpY19hZGRyZXNzID0gcmVzcG9uc2UuanNvbigpLmdldCgnaXAnLCAnTi9BJykKICAgICAgICAKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLwn4yQIFB1YmxpYyBJUCIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiVmljdGltJ3MgUHVibGljIElQOiB7cHVibGljX2FkZHJlc3N9IPCfjJAiLAogICAgICAgICAgICBjb2xvcj0weGZmMDAwMAogICAgICAgICkKICAgICAgICAKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBhd2FpdCBjdHguc2VuZChmIkVycm9yOiB7c3RyKGUpfSIpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgc2h1dGRvd24oY3R4KToKICAgIHBjX25hbWUgPSBnZXRfc3lzdGVtX2luZm8oKS5nZXQoIlBDIE5hbWUiLCAiTm9OYW1lIikKICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICB0aXRsZT0i8J+bkSAqKlNodXR0aW5nIGRvd24qKiIsCiAgICAgICAgZGVzY3JpcHRpb249ZiIqKntwY19uYW1lfSoqIGlzIHNodXR0aW5nIGRvd24uLi4gR29vZGJ5ZSEg8J+RiyIsCiAgICAgICAgY29sb3I9MHhmZjAwMDAKICAgICkKICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgCiAgICB0cnk6CiAgICAgICAgaWYgc3lzLnBsYXRmb3JtLnN0YXJ0c3dpdGgoJ3dpbicpOgogICAgICAgICAgICBzdWJwcm9jZXNzLnJ1bihbInNodXRkb3duIiwgIi9zIiwgIi90IiwgIjAiXSwgY2hlY2s9VHJ1ZSkKICAgICAgICBlbGlmIHN5cy5wbGF0Zm9ybS5zdGFydHN3aXRoKCdsaW51eCcpIG9yIHN5cy5wbGF0Zm9ybS5zdGFydHN3aXRoKCdkYXJ3aW4nKToKICAgICAgICAgICAgc3VicHJvY2Vzcy5ydW4oWyJzdWRvIiwgInNodXRkb3duIiwgIi1oIiwgIm5vdyJdLCBjaGVjaz1UcnVlKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGF3YWl0IGN0eC5zZW5kKGYi4p2MIEVycm9yOiB7ZX0iKQoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIHJlc3RhcnQoY3R4KToKICAgIHBjX25hbWUgPSBnZXRfc3lzdGVtX2luZm8oKS5nZXQoIlBDIE5hbWUiLCAiTm9OYW1lIikKICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICB0aXRsZT0i8J+UhCAqKlJlc3RhcnRpbmcqKiIsCiAgICAgICAgZGVzY3JpcHRpb249ZiIqKntwY19uYW1lfSoqIGlzIHJlc3RhcnRpbmcuLi4gUGxlYXNlIHdhaXQhIPCflIQiLAogICAgICAgIGNvbG9yPTB4MDAwMGZmCiAgICApCiAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKICAgIAogICAgdHJ5OgogICAgICAgIGlmIHN5cy5wbGF0Zm9ybS5zdGFydHN3aXRoKCd3aW4nKToKICAgICAgICAgICAgc3VicHJvY2Vzcy5ydW4oWyJzaHV0ZG93biIsICIvciIsICIvdCIsICIwIl0sIGNoZWNrPVRydWUpICAKICAgICAgICBlbGlmIHN5cy5wbGF0Zm9ybS5zdGFydHN3aXRoKCdsaW51eCcpIG9yIHN5cy5wbGF0Zm9ybS5zdGFydHN3aXRoKCdkYXJ3aW4nKToKICAgICAgICAgICAgc3VicHJvY2Vzcy5ydW4oWyJzdWRvIiwgInNodXRkb3duIiwgIi1yIiwgIm5vdyJdLCBjaGVjaz1UcnVlKSAgCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZiLinYwgRXJyb3I6IHtlfSIpCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBjb21tYW5kKGN0eCwgKiwgY21kOiBzdHIpOgogICAgdHJ5OgogICAgICAgIHByb2Nlc3MgPSBzdWJwcm9jZXNzLlBvcGVuKAogICAgICAgICAgICBjbWQsIHNoZWxsPVRydWUsIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUsIHN0ZGVycj1zdWJwcm9jZXNzLlBJUEUsIHRleHQ9VHJ1ZQogICAgICAgICkKCiAgICAgICAgc3Rkb3V0LCBzdGRlcnIgPSBwcm9jZXNzLmNvbW11bmljYXRlKCkKCiAgICAgICAgaWYgcHJvY2Vzcy5yZXR1cm5jb2RlID09IDA6CiAgICAgICAgICAgIG91dHB1dCA9IHN0ZG91dAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG91dHB1dCA9IHN0ZGVycgoKICAgICAgICBpZiBsZW4ob3V0cHV0KSA+IDIwMDA6CiAgICAgICAgICAgIHRlbXBfZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKHRlbXBfZm9sZGVyLCAiY29tbWFuZF9vdXRwdXQudHh0IikKCiAgICAgICAgICAgIHdpdGggb3Blbih0ZW1wX2ZpbGVfcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgZi53cml0ZShvdXRwdXQpCgogICAgICAgICAgICBhd2FpdCBjdHguc2VuZCgKICAgICAgICAgICAgICAgIGNvbnRlbnQ9IlRoZSBvdXRwdXQgd2FzIHRvbyBsb25nLCBzbyBpdCBoYXMgYmVlbiBzYXZlZCB0byBhIGZpbGUuIFlvdSBjYW4gZG93bmxvYWQgaXQgYmVsb3c6IiwKICAgICAgICAgICAgICAgIGZpbGU9ZGlzY29yZC5GaWxlKHRlbXBfZmlsZV9wYXRoKQogICAgICAgICAgICApCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IvCfkrsgQ29tbWFuZCBPdXRwdXQiLAogICAgICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJFeGVjdXRlZCBjb21tYW5kOiBge2NtZH1gIiwKICAgICAgICAgICAgICAgIGNvbG9yPTB4MDBmZjAwCiAgICAgICAgICAgICkKICAgICAgICAgICAgZW1iZWQuYWRkX2ZpZWxkKG5hbWU9Ik91dHB1dCIsIHZhbHVlPW91dHB1dCwgaW5saW5lPUZhbHNlKQogICAgICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i4p2MIENvbW1hbmQgRXJyb3IiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkFuIGVycm9yIG9jY3VycmVkIHdoaWxlIGV4ZWN1dGluZyB0aGUgY29tbWFuZDoge3N0cihlKX0iLAogICAgICAgICAgICBjb2xvcj0weGZmMDAwMAogICAgICAgICkKICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBjZChjdHgsIHBhdGg6IHN0ciA9IE5vbmUpOgogICAgZ2xvYmFsIGN1cnJlbnRfZGlyZWN0b3J5CgogICAgdHJ5OgogICAgICAgIGlmIHBhdGggaXMgTm9uZToKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IvCfk4IgQ3VycmVudCBEaXJlY3RvcnkiLAogICAgICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJUaGUgY3VycmVudCB3b3JraW5nIGRpcmVjdG9yeSBpczoge2N1cnJlbnRfZGlyZWN0b3J5fSIsCiAgICAgICAgICAgICAgICBjb2xvcj0weDAwZmYwMAogICAgICAgICAgICApCiAgICAgICAgZWxpZiBwYXRoID09ICIuLiI6CiAgICAgICAgICAgIHBhcmVudF9kaXJlY3RvcnkgPSBvcy5wYXRoLmRpcm5hbWUoY3VycmVudF9kaXJlY3RvcnkpCiAgICAgICAgICAgIGN1cnJlbnRfZGlyZWN0b3J5ID0gcGFyZW50X2RpcmVjdG9yeQogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i8J+boO+4jyBDRCBDb21tYW5kIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiTW92ZWQgdXAgb25lIGRpcmVjdG9yeSB0bzoge2N1cnJlbnRfZGlyZWN0b3J5fSIsCiAgICAgICAgICAgICAgICBjb2xvcj0weDAwZmYwMAogICAgICAgICAgICApCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbmV3X3BhdGggPSBvcy5wYXRoLmpvaW4oY3VycmVudF9kaXJlY3RvcnksIHBhdGgpCgogICAgICAgICAgICBpZiBvcy5wYXRoLmlzZGlyKG5ld19wYXRoKToKICAgICAgICAgICAgICAgIGN1cnJlbnRfZGlyZWN0b3J5ID0gbmV3X3BhdGgKICAgICAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgICAgICB0aXRsZT0i8J+boO+4jyBDRCBDb21tYW5kIiwKICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj1mIlN1Y2Nlc3NmdWxseSBjaGFuZ2VkIGRpcmVjdG9yeSB0bzoge2N1cnJlbnRfZGlyZWN0b3J5fSIsCiAgICAgICAgICAgICAgICAgICAgY29sb3I9MHgwMGZmMDAKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgICAgICB0aXRsZT0i4p2MIENEIENvbW1hbmQgRXJyb3IiLAogICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiRGlyZWN0b3J5IG5vdCBmb3VuZDoge3BhdGh9IiwKICAgICAgICAgICAgICAgICAgICBjb2xvcj0weGZmMDAwMAogICAgICAgICAgICAgICAgKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IuKdjCBDRCBDb21tYW5kIEVycm9yIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSBjaGFuZ2luZyBkaXJlY3Rvcnk6IHtzdHIoZSl9IiwKICAgICAgICAgICAgY29sb3I9MHhmZjAwMDAKICAgICAgICApCgogICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgbGlzdChjdHgpOgogICAgZ2xvYmFsIGN1cnJlbnRfZGlyZWN0b3J5CgogICAgdHJ5OgogICAgICAgIGZpbGVzID0gb3MubGlzdGRpcihjdXJyZW50X2RpcmVjdG9yeSkKCiAgICAgICAgaWYgbm90IGZpbGVzOgogICAgICAgICAgICBmaWxlcyA9IFsiTm8gZmlsZXMgb3IgZGlyZWN0b3JpZXMgZm91bmQuIl0KICAgICAgICAKICAgICAgICBpdGVtc19wZXJfcGFnZSA9IDEwCiAgICAgICAgdG90YWxfZmlsZXMgPSBsZW4oZmlsZXMpCiAgICAgICAgdG90YWxfcGFnZXMgPSBtYXRoLmNlaWwodG90YWxfZmlsZXMgLyBpdGVtc19wZXJfcGFnZSkKCiAgICAgICAgY3VycmVudF9wYWdlID0gMQoKICAgICAgICBkZWYgY3JlYXRlX2VtYmVkKHBhZ2UpOgogICAgICAgICAgICBzdGFydCA9IChwYWdlIC0gMSkgKiBpdGVtc19wZXJfcGFnZQogICAgICAgICAgICBlbmQgPSBtaW4oc3RhcnQgKyBpdGVtc19wZXJfcGFnZSwgdG90YWxfZmlsZXMpCiAgICAgICAgICAgIGZpbGVfbGlzdCA9IGZpbGVzW3N0YXJ0OmVuZF0KCiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLwn5OCIEZpbGUgTGlzdCIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkZpbGVzIGluIHtjdXJyZW50X2RpcmVjdG9yeX0gKFBhZ2Uge3BhZ2V9L3t0b3RhbF9wYWdlc30pOiIsCiAgICAgICAgICAgICAgICBjb2xvcj0weDAwZmYwMAogICAgICAgICAgICApCiAgICAgICAgICAgIGVtYmVkLmFkZF9maWVsZChuYW1lPSJGaWxlcyIsIHZhbHVlPSJcbiIuam9pbihmaWxlX2xpc3QpLCBpbmxpbmU9RmFsc2UpCiAgICAgICAgICAgIHJldHVybiBlbWJlZAoKICAgICAgICBlbWJlZCA9IGNyZWF0ZV9lbWJlZChjdXJyZW50X3BhZ2UpCiAgICAgICAgbWVzc2FnZSA9IGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKICAgICAgICBpZiB0b3RhbF9wYWdlcyA+IDE6CiAgICAgICAgICAgIGF3YWl0IG1lc3NhZ2UuYWRkX3JlYWN0aW9uKCLirIXvuI8iKQogICAgICAgICAgICBhd2FpdCBtZXNzYWdlLmFkZF9yZWFjdGlvbigi4p6h77iPIikKCiAgICAgICAgZGVmIGNoZWNrKHJlYWN0aW9uLCB1c2VyKToKICAgICAgICAgICAgcmV0dXJuIHVzZXIgPT0gY3R4LmF1dGhvciBhbmQgc3RyKHJlYWN0aW9uLmVtb2ppKSBpbiBbIuKshe+4jyIsICLinqHvuI8iXSBhbmQgcmVhY3Rpb24ubWVzc2FnZS5pZCA9PSBtZXNzYWdlLmlkCgogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlYWN0aW9uLCB1c2VyID0gYXdhaXQgYm90LndhaXRfZm9yKCdyZWFjdGlvbl9hZGQnLCB0aW1lb3V0PTEwLCBjaGVjaz1jaGVjaykKCiAgICAgICAgICAgICAgICBpZiBzdHIocmVhY3Rpb24uZW1vamkpID09ICLinqHvuI8iIGFuZCBjdXJyZW50X3BhZ2UgPCB0b3RhbF9wYWdlczoKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X3BhZ2UgKz0gMQogICAgICAgICAgICAgICAgZWxpZiBzdHIocmVhY3Rpb24uZW1vamkpID09ICLirIXvuI8iIGFuZCBjdXJyZW50X3BhZ2UgPiAxOgogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfcGFnZSAtPSAxCgogICAgICAgICAgICAgICAgbmV3X2VtYmVkID0gY3JlYXRlX2VtYmVkKGN1cnJlbnRfcGFnZSkKICAgICAgICAgICAgICAgIGF3YWl0IG1lc3NhZ2UuZWRpdChlbWJlZD1uZXdfZW1iZWQpCiAgICAgICAgICAgICAgICBhd2FpdCBtZXNzYWdlLnJlbW92ZV9yZWFjdGlvbihyZWFjdGlvbi5lbW9qaSwgdXNlcikKCiAgICAgICAgICAgIGV4Y2VwdCBhc3luY2lvLlRpbWVvdXRFcnJvcjoKICAgICAgICAgICAgICAgIGF3YWl0IG1lc3NhZ2UuY2xlYXJfcmVhY3Rpb25zKCkKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IuKdjCBMaXN0IENvbW1hbmQgRXJyb3IiLAogICAgICAgICAgICBkZXNjcmlwdGlvbj1mIkFuIGVycm9yIG9jY3VycmVkIHdoaWxlIGxpc3RpbmcgdGhlIGZpbGVzOiB7c3RyKGUpfSIsCiAgICAgICAgICAgIGNvbG9yPTB4ZmYwMDAwCiAgICAgICAgKQogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIGRvd25sb2FkKGN0eCwgZmlsZW5hbWU6IHN0cik6CiAgICBnbG9iYWwgY3VycmVudF9kaXJlY3RvcnkKCiAgICB0cnk6CiAgICAgICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKGN1cnJlbnRfZGlyZWN0b3J5LCBmaWxlbmFtZSkKCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoZmlsZV9wYXRoKSBhbmQgb3MucGF0aC5pc2ZpbGUoZmlsZV9wYXRoKToKICAgICAgICAgICAgYXdhaXQgY3R4LnNlbmQoZmlsZT1kaXNjb3JkLkZpbGUoZmlsZV9wYXRoKSkKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IvCfk6QgRmlsZSBTZW50IiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiU3VjY2Vzc2Z1bGx5IHNlbnQgdGhlIGZpbGU6IHtmaWxlbmFtZX0iLAogICAgICAgICAgICAgICAgY29sb3I9MHgwMGZmMDAKICAgICAgICAgICAgKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLinYwgRmlsZSBTZW5kIEVycm9yIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiRmlsZSBub3QgZm91bmQ6IHtmaWxlbmFtZX0gaW4ge2N1cnJlbnRfZGlyZWN0b3J5fSIsCiAgICAgICAgICAgICAgICBjb2xvcj0weGZmMDAwMAogICAgICAgICAgICApCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i4p2MIEZpbGUgU2VuZCBFcnJvciIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiQW4gZXJyb3Igb2NjdXJyZWQgd2hpbGUgc2VuZGluZyB0aGUgZmlsZToge3N0cihlKX0iLAogICAgICAgICAgICBjb2xvcj0weGZmMDAwMAogICAgICAgICkKCiAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBzdGFydHVwKGN0eCk6CiAgICBoenpoKCkKICAgIGh6emh0ZW1wKCkKICAgIGh6emhyZWcoKQogICAgaHp6aF90YXNrX3NjaGVkdWxlcigpCiAgICBoenpoX3J1bm9uY2UoKQoKICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICB0aXRsZT0i8J+QgCBTdGFydFVwIiwKICAgICAgICBkZXNjcmlwdGlvbj0iVGhlIGZvbGxvd2luZyBhY3Rpb25zIHdlcmUgcGVyZm9ybWVkIHRvIGFkZCBILXp6LUggdG8gc3RhcnR1cDoiLAogICAgICAgIGNvbG9yPTB4MDBmZjAwCiAgICApCgogICAgZW1iZWQuYWRkX2ZpZWxkKG5hbWU9IlNoZWxsOlN0YXJ0dXAiLCB2YWx1ZT0iUHV0IEgtenotSCBpbiBzaGVsbDpzdGFydHVwIPCfkIAiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZC5hZGRfZmllbGQobmFtZT0iVGVtcCBTdGFydFVwIiwgdmFsdWU9IlB1dCBILXp6LUggaW4gVGVtcCBTdGFydFVwIPCfkIAiLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZC5hZGRfZmllbGQobmFtZT0iV2luZG93cyBSZWdpc3RyeSIsIHZhbHVlPSJQdXQgSC16ei1IIGluIFdpbmRvd3MgUmVnaXN0cnkgU3RhcnRVcCDwn5CAIiwgaW5saW5lPUZhbHNlKQogICAgZW1iZWQuYWRkX2ZpZWxkKG5hbWU9IlRhc2sgU2NoZWR1bGVyIiwgdmFsdWU9IlB1dCBILXp6LUggaW4gVGFzayBTY2hlZHVsZXIg8J+QgCIsIGlubGluZT1GYWxzZSkKICAgIGVtYmVkLmFkZF9maWVsZChuYW1lPSJSZWdpc3RyeSAoUnVuT25jZSkiLCB2YWx1ZT0iUHV0IEgtenotSCBpbiBXaW5kb3dzIFJlZ2lzdHJ5IFN0YXJ0VXAgMiDwn5CAIiwgaW5saW5lPUZhbHNlKQoKICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIHNjcmVlbihjdHgpOgogICAgdHJ5OgogICAgICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbih0ZW1wX2ZvbGRlciwgImh6emgucG5nIikKICAgICAgICBzY3JlZW5zaG90ID0gcHlhdXRvZ3VpLnNjcmVlbnNob3QoKQogICAgICAgIHNjcmVlbnNob3Quc2F2ZShmaWxlX3BhdGgpCgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IvCflrzvuI8gU2NyZWVuc2hvdCIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJTdWNjZXNmdWxseSB0b29rIGEgU2NyZWVuc2hvdDoiLAogICAgICAgICAgICBjb2xvcj0weDAwZmYwMAogICAgICAgICkKICAgICAgICAKICAgICAgICBmaWxlID0gZGlzY29yZC5GaWxlKGZpbGVfcGF0aCwgZmlsZW5hbWU9InNjcmVlbnNob3QucG5nIikKICAgICAgICBlbWJlZC5zZXRfaW1hZ2UodXJsPSJhdHRhY2htZW50Oi8vc2NyZWVuc2hvdC5wbmciKQogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkLCBmaWxlPWZpbGUpCgogICAgICAgIG9zLnJlbW92ZShmaWxlX3BhdGgpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGF3YWl0IGN0eC5zZW5kKGYi4p2MIEZlaGxlciBiZWltIEVyc3RlbGxlbiBkZXMgU2NyZWVuc2hvdHM6IHtlfSIpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgZXJyb3IoY3R4LCAqLCBtZXNzYWdlOiBzdHIpOgogICAgdHJ5OgogICAgICAgIGlmICJ8IiBpbiBtZXNzYWdlOgogICAgICAgICAgICB0aXRsZSwgbXNnID0gbWVzc2FnZS5zcGxpdCgifCIsIDEpCiAgICAgICAgICAgIHRpdGxlID0gdGl0bGUuc3RyaXAoKSAKICAgICAgICAgICAgbXNnID0gbXNnLnN0cmlwKCkgIAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRpdGxlID0gIlVua25vd24gRXJyb3IiCiAgICAgICAgICAgIG1zZyA9IG1lc3NhZ2Uuc3RyaXAoKQoKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPWYi4pqg77iPIHt0aXRsZX0iLCAKICAgICAgICAgICAgZGVzY3JpcHRpb249ZiIqKk1lc3NhZ2U6KipcbmB7bXNnfWAiLCAKICAgICAgICAgICAgY29sb3I9MHhGRjAwMDAgIAogICAgICAgICkKCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgogICAgICAgIGN0eXBlcy53aW5kbGwudXNlcjMyLk1lc3NhZ2VCb3hXKDAsIG1zZywgdGl0bGUsIDB4MTApCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IuKaoO+4jyBGYWtlIEVycm9yIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249IkZha2UgRXJyb3IgZmFpbGVkIHRvIGRpc3BsYXkhIiwKICAgICAgICAgICAgY29sb3I9MHhGRjAwMDAKICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgaW5mb3JtYXRpb24oY3R4KToKICAgIHN5c3RlbV9pbmZvID0gZ2V0X3N5c3RlbV9pbmZvKCkKICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICB0aXRsZT0i8J+Wpe+4jyBTeXN0ZW0gSW5mb3JtYXRpb24iLAogICAgICAgIGRlc2NyaXB0aW9uPWYiKipQQyBOYW1lOiDwn5al77iPKipcbiB7c3lzdGVtX2luZm9bJ1BDIE5hbWUnXX1cbiIKICAgICAgICAgICAgICAgICAgICBmIioqSVAgQWRkcmVzczog8J+MkCoqXG4ge3N5c3RlbV9pbmZvWydJUCBBZGRyZXNzJ119XG4iCiAgICAgICAgICAgICAgICAgICAgZiIqKkdlb2xvY2F0aW9uOiDwn5ONKipcbiB7c3lzdGVtX2luZm9bJ0dlb2xvY2F0aW9uJ119XG4iCiAgICAgICAgICAgICAgICAgICAgZiIqKlN5c3RlbSBWZXJzaW9uOiDwn5ax77iPKipcbiB7c3lzdGVtX2luZm9bJ1N5c3RlbSBWZXJzaW9uJ119XG4iCiAgICAgICAgICAgICAgICAgICAgZiIqKkNQVSBVc2FnZTog4pqZ77iPKipcbiB7c3lzdGVtX2luZm9bJ0NQVSBVc2FnZSddfVxuIgogICAgICAgICAgICAgICAgICAgIGYiKipNZW1vcnkgVXNhZ2U6IPCfkr4qKlxuIHtzeXN0ZW1faW5mb1snTWVtb3J5IFVzYWdlJ119XG4iCiAgICAgICAgICAgICAgICAgICAgZiIqKkRpc2sgVXNhZ2U6IPCfl4LvuI8qKlxuIHtzeXN0ZW1faW5mb1snRGlzayBJbmZvJ119XG5cbiIKICAgICAgICAgICAgICAgICAgICAiTWFkZSB3aXRoIOKdpCBieSBILXp6LUguIiwKICAgICAgICBjb2xvcj0weDAwZmYwMAogICAgKQogICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgpkZWYgcnVuX2NvbW1hbmQoY29tbWFuZCwgZW5jb2Rpbmc9J3V0Zi04Jyk6CiAgICB0cnk6CiAgICAgICAgc3VicHJvY2Vzcy5ydW4oImNoY3AgNjUwMDEiLCBjYXB0dXJlX291dHB1dD1UcnVlLCBzaGVsbD1UcnVlLCB0ZXh0PVRydWUpCiAgICAgICAgCiAgICAgICAgcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oY29tbWFuZCwgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSwgdGV4dD1UcnVlLCBzaGVsbD1UcnVlLCBlbmNvZGluZz1lbmNvZGluZykKICAgICAgICByZXR1cm4gcmVzdWx0LnN0ZG91dAogICAgZXhjZXB0IFVuaWNvZGVEZWNvZGVFcnJvcjoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlc3VsdCA9IHN1YnByb2Nlc3MucnVuKGNvbW1hbmQsIGNhcHR1cmVfb3V0cHV0PVRydWUsIHRleHQ9VHJ1ZSwgc2hlbGw9VHJ1ZSwgZW5jb2Rpbmc9J2NwMTI1MicpCiAgICAgICAgICAgIHJldHVybiByZXN1bHQuc3Rkb3V0CiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICByZXR1cm4gZiJFcnJvciBleGVjdXRpbmcgY29tbWFuZDoge2V9IgoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIG5ldHdvcmsoY3R4KToKICAgIHRyeToKICAgICAgICBvdXRwdXQgPSBydW5fY29tbWFuZCgibmV0c2ggd2xhbiBzaG93IHByb2ZpbGVzIikKICAgICAgICAKICAgICAgICBpZiBvdXRwdXQ6CiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLwn4yQIE5ldHdvcmsiLAogICAgICAgICAgICAgICAgZGVzY3JpcHRpb249ZiLwn4yQICoqV2ktRmkgTmV0d29ya3MqKjpcbmBgYFxue291dHB1dH1cbmBgYCIsCiAgICAgICAgICAgICAgICBjb2xvcj0weDAwZmYwMAogICAgICAgICAgICApCiAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgICAgIHRpdGxlPSLwn4yQIE5ldHdvcmsiLAogICAgICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJObyBXaS1GaSBuZXR3b3JrcyBmb3VuZC4iLAogICAgICAgICAgICAgICAgY29sb3I9MHgwMGZmMDAKICAgICAgICAgICAgKQogICAgICAgICAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKICAgIAogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICAgICAgdGl0bGU9IvCfjJAgTmV0d29yayIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYiRXJyb3I6IHtlfSIsCiAgICAgICAgICAgIGNvbG9yPTB4MDBmZjAwCiAgICAgICAgKQogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIG5ldF9wYXNzKGN0eCwgd2lmaV9uYW1lOiBzdHIpOgogICAgdHJ5OgogICAgICAgIG91dHB1dCA9IHJ1bl9jb21tYW5kKGYnbmV0c2ggd2xhbiBzaG93IHByb2ZpbGUgbmFtZT0ie3dpZmlfbmFtZX0iIGtleT1jbGVhcicpCiAgICAgICAgaWYgb3V0cHV0OgogICAgICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgICAgICB0aXRsZT0i8J+UkSBOZXR3b3JrIFBhc3N3b3JkIiwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWYi8J+UkSAqKlBhc3N3b3JkIGZvciB7d2lmaV9uYW1lfSoqOiBge291dHB1dH1gIiwKICAgICAgICAgICAgICAgIGNvbG9yPTB4MDBmZjAwCiAgICAgICAgICAgICkKICAgICAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICAgICAgdGl0bGU9IvCflJEgTmV0d29yayBQYXNzd29yZCIsCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbj1mIvCflJEgTm8gUGFzc3dvcmQgZm9yIHt3aWZpX25hbWV9IGZvdW5kLiIsCiAgICAgICAgICAgICAgICBjb2xvcj0weDAwZmYwMAogICAgICAgICAgICApCiAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQogICAgICAgIAogICAgCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgICAgICB0aXRsZT0i8J+UkSBOZXR3b3JrIFBhc3N3b3JkIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJFcnJvcjoge2V9IiwKICAgICAgICAgICAgY29sb3I9MHgwMGZmMDAKICAgICAgICApCiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgZGlzayhjdHgpOgogICAgc3lzdGVtX2luZm8gPSBnZXRfc3lzdGVtX2luZm8oKQogICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgIHRpdGxlPSLwn5OmIERpc2sgVXNhZ2UiLAogICAgICAgIGRlc2NyaXB0aW9uPWYiRGlzayBVc2FnZToge3N5c3RlbV9pbmZvWydEaXNrIEluZm8nXX0iLAogICAgICAgIGNvbG9yPTB4MDBmZjAwCiAgICApCiAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBjcHUoY3R4KToKICAgIHN5c3RlbV9pbmZvID0gZ2V0X3N5c3RlbV9pbmZvKCkKICAgIGVtYmVkID0gZGlzY29yZC5FbWJlZCgKICAgICAgICB0aXRsZT0i4pqZ77iPIENQVSBVc2FnZSIsCiAgICAgICAgZGVzY3JpcHRpb249ZiJDUFUgVXNhZ2U6IHtzeXN0ZW1faW5mb1snQ1BVIFVzYWdlJ119IiwKICAgICAgICBjb2xvcj0weDAwZmYwMAogICAgKQogICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgcmFtKGN0eCk6CiAgICBzeXN0ZW1faW5mbyA9IGdldF9zeXN0ZW1faW5mbygpCiAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgdGl0bGU9IvCfkr4gUkFNIFVzYWdlIiwKICAgICAgICBkZXNjcmlwdGlvbj1mIlJBTSBVc2FnZToge3N5c3RlbV9pbmZvWydSQU0gVXNhZ2UnXX0iLAogICAgICAgIGNvbG9yPTB4MDBmZjAwCiAgICApCiAgICBhd2FpdCBjdHguc2VuZChlbWJlZD1lbWJlZCkKCkBib3QuY29tbWFuZCgpCmFzeW5jIGRlZiBvdmVydmlldyhjdHgpOgogICAgc3lzdGVtX2luZm8gPSBnZXRfc3lzdGVtX2luZm8oKQogICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgIHRpdGxlPSLwn5ug77iPIFN5c3RlbSBPdmVydmlldyIsCiAgICAgICAgY29sb3I9MHgwMGZmMDAKICAgICkKICAgIGVtYmVkLmFkZF9maWVsZChuYW1lPSLimpnvuI8gQ1BVIFVzYWdlIiwgdmFsdWU9c3lzdGVtX2luZm9bIkNQVSBVc2FnZSJdLCBpbmxpbmU9RmFsc2UpCiAgICBlbWJlZC5hZGRfZmllbGQobmFtZT0i8J+SviBSQU0gVXNhZ2UiLCB2YWx1ZT1zeXN0ZW1faW5mb1siUkFNIFVzYWdlIl0sIGlubGluZT1GYWxzZSkKICAgIGVtYmVkLmFkZF9maWVsZChuYW1lPSLwn5eC77iPIERpc2sgVXNhZ2UiLCB2YWx1ZT1zeXN0ZW1faW5mb1siRGlzayBJbmZvIl0sIGlubGluZT1GYWxzZSkKICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIGJhdHRlcnkoY3R4KToKICAgIGJhdHRlcnlfaW5mbyA9IGdldF9iYXR0ZXJ5X3N0YXR1cygpCiAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgdGl0bGU9IvCflIsgQmF0dGVyeSBTdGF0dXMiLAogICAgICAgIGRlc2NyaXB0aW9uPWJhdHRlcnlfaW5mbywKICAgICAgICBjb2xvcj0weDAwZmYwMAogICAgKQogICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgd2ViY2FtKGN0eCk6CiAgICB0cnk6CiAgICAgICAgd2ViY2FtX2ltYWdlcyA9IFtdCgogICAgICAgIGZvciBjYW1faW5kZXggaW4gcmFuZ2UoMTApOgogICAgICAgICAgICB3ZWJjYW0gPSBjdjIuVmlkZW9DYXB0dXJlKGNhbV9pbmRleCkKICAgICAgICAgICAgcmV0LCBmcmFtZSA9IHdlYmNhbS5yZWFkKCkKICAgICAgICAgICAgd2ViY2FtLnJlbGVhc2UoKQoKICAgICAgICAgICAgaWYgcmV0OgogICAgICAgICAgICAgICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKHRlbXBfZm9sZGVyLCBmIndlYmNhbV9pbWFnZV97Y2FtX2luZGV4fS5wbmciKQogICAgICAgICAgICAgICAgY3YyLmltd3JpdGUoZmlsZV9wYXRoLCBmcmFtZSkKICAgICAgICAgICAgICAgIHdlYmNhbV9pbWFnZXMuYXBwZW5kKGZpbGVfcGF0aCkKCiAgICAgICAgaWYgbm90IHdlYmNhbV9pbWFnZXM6CiAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKCLinYwgTm8gYXZhaWxhYmxlIHdlYmNhbXMgZGV0ZWN0ZWQuIFBsZWFzZSBlbnN1cmUgdGhleSBhcmUgY29ubmVjdGVkIGFuZCBhY2Nlc3NpYmxlLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLwn5O4IFdlYmNhbSIsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJTdWNjZXNzZnVsbHkgY2FwdHVyZWQgaW1hZ2VzIGZyb20gYXZhaWxhYmxlIHdlYmNhbXM6IiwKICAgICAgICAgICAgY29sb3I9MHgwMGZmMDAKICAgICAgICApCgogICAgICAgIGZvciBmaWxlX3BhdGggaW4gd2ViY2FtX2ltYWdlczoKICAgICAgICAgICAgZmlsZSA9IGRpc2NvcmQuRmlsZShmaWxlX3BhdGgsIGZpbGVuYW1lPW9zLnBhdGguYmFzZW5hbWUoZmlsZV9wYXRoKSkKICAgICAgICAgICAgZW1iZWQuc2V0X2ltYWdlKHVybD1mImF0dGFjaG1lbnQ6Ly97b3MucGF0aC5iYXNlbmFtZShmaWxlX3BhdGgpfSIpCiAgICAgICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkLCBmaWxlPWZpbGUpCgogICAgICAgICAgICBvcy5yZW1vdmUoZmlsZV9wYXRoKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBhd2FpdCBjdHguc2VuZChmIuKdjCBBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSBhY2Nlc3NpbmcgdGhlIHdlYmNhbXM6IHtlfSIpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgdGFza3MoY3R4KToKICAgIHRhc2tzX2luZm8gPSBnZXRfcnVubmluZ190YXNrcygpCiAgICAKICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbih0ZW1wX2ZvbGRlciwgInRhc2tzX2xpc3QudHh0IikKICAgIAogICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgInciKSBhcyBmaWxlOgogICAgICAgIGZpbGUud3JpdGUoIlxuIi5qb2luKHRhc2tzX2luZm8pKQogICAgCiAgICBhd2FpdCBjdHguc2VuZChmaWxlPWRpc2NvcmQuRmlsZShmaWxlX3BhdGgpKQoKQGJvdC5jb21tYW5kKCkKYXN5bmMgZGVmIGZha2VjbWQoY3R4LCBjb3VudDogaW50KToKICAgIHRyeToKICAgICAgICBlbWJlZCA9IGRpc2NvcmQuRW1iZWQoCiAgICAgICAgICAgIHRpdGxlPSLwn5K7IEZha2UgQ01EIiwKICAgICAgICAgICAgZGVzY3JpcHRpb249ZiJTdWNjZXNzZnVsbHkgc3BhbW1lZCB7Y291bnR9IENNRCB3aW5kb3dzOiIsCiAgICAgICAgICAgIGNvbG9yPTB4MDBmZjAwCiAgICAgICAgKQogICAgICAgIGF3YWl0IGN0eC5zZW5kKGVtYmVkPWVtYmVkKQoKICAgICAgICBmb3IgaSBpbiByYW5nZShjb3VudCk6CiAgICAgICAgICAgIHN1YnByb2Nlc3MuUG9wZW4oJ3N0YXJ0IGNtZC5leGUnLCBzaGVsbD1UcnVlKQoKICAgICAgICAgICAgdGltZS5zbGVlcCgwLjAzKQoKICAgICAgICAgICAgc3VicHJvY2Vzcy5Qb3BlbigndGFza2tpbGwgL2YgL2ltIGNtZC5leGUnLCBzaGVsbD1UcnVlKQogICAgCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgYXdhaXQgY3R4LnNlbmQoZiLinYwgQW4gZXJyb3Igb2NjdXJyZWQ6IHtlfSIpCgpAYm90LmNvbW1hbmQoKQphc3luYyBkZWYgd2ViX29wZW4oY3R4LCB1cmwpOgogICAgb3Muc3lzdGVtKGYic3RhcnQge3VybH0iKQogICAgZW1iZWQgPSBkaXNjb3JkLkVtYmVkKAogICAgICAgIHRpdGxlPSLwn4yNIFdlYmJyb3dzZXIiLAogICAgICAgIGRlc2NyaXB0aW9uPWYi8J+MjSBPcGVuZWQge3VybH0gaW4gdGhlIGJyb3dzZXIhIiwKICAgICAgICBjb2xvcj0weDAwZmYwMAogICAgKQogICAgYXdhaXQgY3R4LnNlbmQoZW1iZWQ9ZW1iZWQpCgpjaGVja190b2tlbigpCmh6emgoKQpoenpodGVtcCgpCmh6emhyZWcoKQpoenpoX3J1bm9uY2UoKQp3YWl0X2Zvcl93aWZpKCkKYm90LnJ1bihIenpIKQ=="

exec(base64.b64decode(encoded_content).decode())
