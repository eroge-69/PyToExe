import random
import time
import os
import sys
import threading
from datetime import datetime
import re
import traceback

def global_except_hook(exctype, value, tb):
    """Глобальный обработчик исключений"""
    error_msg = ''.join(traceback.format_exception(exctype, value, tb))
    print(f"\n⚠️ КРИТИЧЕСКАЯ ОШИБКА:\n{error_msg}")
    print("Программа будет закрыта через 30 секунд...")
    time.sleep(30)
    sys.exit(1)

# Устанавливаем глобальный обработчик исключений
sys.excepthook = global_except_hook

class Timer:
    """Класс для управления временем ответа"""
    def __init__(self, duration):
        self.duration = duration
        self.start_time = time.time()
        self.running = True
        self.remaining = duration
        self.timeout_occurred = False
        self.lock = threading.Lock()
    
    def update(self):
        """Обновляет оставшееся время"""
        with self.lock:
            if not self.running:
                return self.remaining, self.timeout_occurred
                
            elapsed = time.time() - self.start_time
            self.remaining = max(0, self.duration - elapsed)
            if self.remaining <= 0:
                self.timeout_occurred = True
                self.running = False
            return self.remaining, self.timeout_occurred
    
    def stop(self):
        """Останавливает таймер"""
        with self.lock:
            self.running = False

def display_timer(timer):
    """Отображает таймер в отдельной строке"""
    try:
        last_remaining = timer.duration
        print(f"⏱ Осталось времени: {int(last_remaining)} сек.")
        
        while timer.running:
            time.sleep(1)
            remaining, timeout = timer.update()
            if timeout or not timer.running:
                break
            
            # Обновляем каждые 10 секунд
            if int(remaining) % 10 == 0 and int(remaining) != int(last_remaining):
                print(f"⏱ Осталось времени: {int(remaining)} сек.")
                last_remaining = remaining
        
        if timer.timeout_occurred:
            print("⏱ Время вышло! Ответ не засчитан.")
    except Exception as e:
        print(f"Ошибка в таймере: {str(e)}")

def clear_screen():
    """Очистка экрана консоли"""
    try:
        os.system('cls' if os.name == 'nt' else 'clear')
    except:
        print("\n" * 100)  # Простой способ очистки экрана

def shuffle_options(question):
    """Перемешивает варианты ответов"""
    try:
        options = question["options"]
        shuffled_options = random.sample(options, len(options))
        correct_indices = [shuffled_options.index(options[i]) for i in question["correct_answers"]]
        return {
            "question": question["question"],
            "options": shuffled_options,
            "correct_answers": correct_indices
        }
    except Exception as e:
        print(f"Ошибка при перемешивании: {str(e)}")
        return question

def get_random_questions(questions, num_questions=15):
    """Выбирает случайные вопросы из базы"""
    try:
        num = min(num_questions, len(questions))
        selected_questions = random.sample(questions, num)
        return [shuffle_options(q) for q in selected_questions]
    except Exception as e:
        print(f"Ошибка при выборе вопросов: {str(e)}")
        return questions[:num_questions]

def display_question(question, question_num, total_questions, duration=60):
    """Отображает вопрос и обрабатывает ответ"""
    try:
        clear_screen()
        print("="*70)
        print(f"ВОПРОС {question_num} ИЗ {total_questions}")
        print("="*70)
        print(f"{question['question']}\n")
        
        for i, option in enumerate(question["options"], 1):
            print(f"{i}. {option}")
        
        print(f"\nУ вас есть {duration} секунд на ответ")
        print("Вводите номера правильных вариантов через запятую (например: 1,3)")
        
        # Создаем и запускаем таймер
        timer = Timer(duration)
        timer_thread = threading.Thread(target=display_timer, args=(timer,))
        timer_thread.daemon = True
        timer_thread.start()
        
        start_time = time.time()
        timeout_occurred = False
        
        try:
            # Получаем ответ пользователя
            user_input = input("\nВаш ответ: ")
        except:
            user_input = ""
        
        # Останавливаем таймер
        timer.stop()
        if timer_thread.is_alive():
            timer_thread.join(0.1)
        
        elapsed_time = time.time() - start_time
        
        # Проверка истечения времени
        if timer.timeout_occurred:
            return {
                "question": question["question"],
                "user_answers": [],
                "correct_answers": question["correct_answers"],
                "score": 0.0,
                "time_elapsed": elapsed_time,
                "timeout": True,
                "empty_input": False,
                "options": question["options"]
            }
        
        # Обработка пустого ввода с дополнительной попыткой
        if user_input.strip() == "":
            print("\n⚠ Вы не ввели ответ! У вас есть последняя попытка.")
            
            # Даем пользователю еще одну попытку
            try:
                user_input = input("Повторите ввод: ")
            except:
                user_input = ""
            
            # Если после второй попытки все еще пусто
            if user_input.strip() == "":
                print("\n⚠ Вы не ввели ответ! Вопрос засчитан как неправильный.")
                return {
                    "question": question["question"],
                    "user_answers": [],
                    "correct_answers": question["correct_answers"],
                    "score": 0.0,
                    "time_elapsed": elapsed_time,
                    "timeout": False,
                    "empty_input": True,
                    "options": question["options"]
                }
        
        # Обработка введенного ответа
        try:
            user_answers = [int(i.strip()) - 1 for i in user_input.split(',') if i.strip().isdigit()]
        except ValueError:
            user_answers = []
        
        correct_answers = question["correct_answers"]
        
        # Рассчитываем частичный балл
        correct_count = 0
        total_correct = len(correct_answers)
        
        # Считаем количество правильных ответов
        for answer in user_answers:
            if answer in correct_answers:
                correct_count += 1
        
        # Рассчитываем балл (0.0 - 1.0)
        score = correct_count / total_correct if total_correct > 0 else 0.0

        return {
            "question": question["question"],
            "user_answers": user_answers,
            "correct_answers": correct_answers,
            "score": score,
            "time_elapsed": elapsed_time,
            "timeout": False,
            "empty_input": False,
            "options": question["options"]
        }
    except Exception as e:
        print(f"Ошибка при обработке вопроса: {str(e)}")
        return {
            "question": question["question"],
            "user_answers": [],
            "correct_answers": question["correct_answers"],
            "score": 0.0,
            "time_elapsed": 0,
            "timeout": False,
            "empty_input": True,
            "options": question["options"]
        }

def generate_report(results, user_name, department, full_report=False):
    """Генерирует отчет о результатах тестирования"""
    try:
        total_score = sum(result["score"] for result in results)
        total_count = len(results)
        percentage_score = (total_score / total_count) * 100 if total_count > 0 else 0
        test_date = datetime.now().strftime("%d.%m.%Y %H:%M:%S")

        report = []
        report.append("="*70)
        report.append(f"ОТЧЕТ О ПРОХОЖДЕНИИ ТЕСТА ПО МЕТРОЛОГИИ")
        report.append("="*70)
        report.append(f"ФИО: {user_name}")
        report.append(f"Подразделение: {department}")
        report.append(f"Дата тестирования: {test_date}")
        report.append(f"Результат: {total_score:.2f} из {total_count} ({percentage_score:.2f}%)")
        
        # Оценка результата
        if percentage_score >= 90:
            evaluation = "Отлично! Вы демонстрируете отличное знание нормативных документов"
        elif percentage_score >= 75:
            evaluation = "Хорошо! Вы хорошо ориентируетесь в метрологических требованиях"
        elif percentage_score >= 60:
            evaluation = "Удовлетворительно. Рекомендуется дополнительное изучение материалов"
        else:
            evaluation = "Неудовлетворительно. Требуется дополнительное обучение"
        
        report.append(f"Оценка: {evaluation}")
        report.append("="*70)
        
        # Детализированный отчет только для файла
        if full_report:
            report.append("\nДЕТАЛИЗИРОВАННЫЙ ОТЧЕТ ПО ВОПРОСАМ:")
            for idx, result in enumerate(results, start=1):
                # Формирование ответов пользователя
                user_responses = []
                for i in result["user_answers"]:
                    if 0 <= i < len(result.get("options", [])):
                        user_responses.append(f"{i+1}. {result['options'][i]}")
                
                # Формирование правильных ответов
                correct_responses = []
                for i in result["correct_answers"]:
                    if 0 <= i < len(result.get("options", [])):
                        correct_responses.append(f"{i+1}. {result['options'][i]}")
                
                # Статус ответа
                if result["score"] == 1.0:
                    status = "✓ ПРАВИЛЬНО"
                elif result["score"] > 0:
                    status = f"✓ ЧАСТИЧНО ПРАВИЛЬНО ({result['score']:.1f} балла)"
                else:
                    status = "✗ НЕПРАВИЛЬНО"
                
                report.append(f"\n{'='*70}")
                report.append(f"ВОПРОС {idx}: {status}")
                report.append(f"Текст вопроса: {result['question']}")
                
                # Добавляем варианты ответов
                if "options" in result:
                    report.append("\nВарианты ответов:")
                    for i, option in enumerate(result.get("options", []), 1):
                        report.append(f"  {i}. {option}")
                
                report.append(f"\nВаш ответ: {', '.join(user_responses) if user_responses else 'Нет ответа'}")
                report.append(f"Правильный ответ: {', '.join(correct_responses)}")
                report.append(f"Затраченное время: {result['time_elapsed']:.1f} сек")
                report.append(f"Балл: {result['score']:.2f}")
                
                # Специальные отметки
                if result.get("timeout", False):
                    report.append("⚠ ВРЕМЯ ВЫШЛО! Ответ не засчитан")
                elif result.get("empty_input", False):
                    report.append("⚠ ОТВЕТ НЕ ВВЕДЕН! Нажатие Enter без выбора вариантов")
        
        return "\n".join(report)
    except Exception as e:
        return f"Ошибка при генерации отчета: {str(e)}"

def sanitize_filename(name):
    """Очищает строку для использования в имени файла"""
    try:
        return re.sub(r'[\\/*?:"<>|]', "_", name)
    except:
        return "report"

def save_report(report_text, user_name, department):
    """Сохраняет отчет в текстовый файл"""
    try:
        # Форматирование имени файла
        safe_name = sanitize_filename(user_name.strip())
        safe_dept = sanitize_filename(department.strip())
        date_str = datetime.now().strftime("%Y%m%d")
        filename = f"{safe_dept}_{safe_name}_{date_str}.txt"
        
        with open(filename, 'w', encoding='utf-8') as file:
            file.write(report_text)
        return os.path.abspath(filename)
    except Exception as e:
        print(f"\n❌ Ошибка при сохранении отчета: {str(e)}")
        return None

def run_quiz():
    """Основная функция запуска тестирования"""
    try:
        clear_screen()
        # Заголовок программы
        print("="*70)
        print("ТЕСТИРОВАНИЕ ПО НОРМАТИВНЫМ ДОКУМЕНТАМ В СФЕРЕ МЕТРОЛОГИИ")
        print("ФБУ \"НИЦ ПМ - Ростест\"")
        print("="*70)
        
        # Ввод данных пользователя
        user_name = input("Введите ваше ФИО: ")
        department = input("Введите ваше подразделение: ")
        
        # Полная база из 51 вопроса
        questions = [
            {
                "question": "Заявитель представляет с заявкой на проведение испытаний средств измерений:",
                "options": [
                    "Эксплуатационные документы средства измерений (руководство по эксплуатации, формуляр, паспорт)",
                    "Сертификат соответствия ТР ТС, протокол предварительных испытаний",
                    "Фотографии общего вида средств измерений и (или) рекламные проспекты",
                    "Заключение о соответствии ГОСТ Р."
                ],
                "correct_answers": [0, 2]
            },
            {
                "question": "Какие требования к эталонам единиц величин установлены Постановлением Правительства РФ №734?",
                "options": [
                    "Прослеживаемость к государственным первичным эталонам.",
                    "Обязательное использование утвержденных СИ.",
                    "Допуск к применению после сличений с иностранными эталонами.",
                    "Ежегодная переаттестация."
                ],
                "correct_answers": [0, 2]
            },
            {
                "question": "Согласно ФЗ №102-ФЗ, средства измерений должны иметь:",
                "options": [
                    "Заводские/серийные номера или другие буквенно-цифровые обозначения.",
                    "Логотип производителя.",
                    "Защиту от несанкционированного доступа.",
                    "Сертификат соответствия ЕАЭС."
                ],
                "correct_answers": [0, 2]
            },
            {
                "question": "Какой интервал между поверками устанавливается для новых типов СИ (МИ 3650-2022)?",
                "options": [
                    "Всегда 1 год.",
                    "На основе анализа надежности и аналогов.",
                    "По решению изготовителя.",
                    "В соответствии с приказом Росстандарта №1502."
                ],
                "correct_answers": [1, 3]
            },
            {
                "question": "Какие изменения вносятся в описание типа без испытаний?",
                "options": [
                    "Исправление опечаток.",
                    "Добавление производственной площадки.",
                    "Внесение изменений в адрес производства.",
                    "Введение нового ПО."
                ],
                "correct_answers": [0, 2]
            },
            {
                "question": "Согласно приказу Минпромторга №2510, протокол поверки должен включать:",
                "options": [
                    "Результаты измерений.",
                    "Подпись руководителя аккредитованного лица.",
                    "Регистрационный номер СИ в ФИФ ОЕИ.",
                    "Сведения о владельце."
                ],
                "correct_answers": [0, 2]
            },
            {
                "question": "В каком случае лаборатория может быть лишена аккредитации в соответствии с ФЗ № 412-ФЗ (ст.22)?",
                "options": [
                    "Выявление в течение года более двух фактов нарушений аккредитованным лицом требований законодательства Российской Федерации к деятельности аккредитованных лиц, повлекших за собой приостановление действия аккредитации.",
                    "Если не проводила измерений в течение года.",
                    "Установление факта предоставления заведомо ложных и (или) недостоверных сведений.",
                    "Только по решению суда."
                ],
                "correct_answers": [0, 2]
            },
            {
                "question": "При изменении методики поверки (Приказ Минпромторга №2907) необходимо:",
                "options": [
                    "Провести испытания в полном объеме.",
                    "Опробовать новую методику поверки.",
                    "Согласовать изменения с Росстандартом.",
                    "Указать изменения в описании типа СИ."
                ],
                "correct_answers": [1, 3]
            },
            {
                "question": "Согласно ФЗ №102-ФЗ, конструкция СИ должна обеспечивать:",
                "options": [
                    "Возможность нанесения знака поверки.",
                    "Наличие заводского/серийного номера.",
                    "Нанесение знака утверждения типа.",
                    "Ограничение доступа к определенным частям средств измерений (включая программное обеспечение) в целях предотвращения несанкционированных настройки и вмешательства, которые могут привести к искажениям результатов измерений."
                ],
                "correct_answers": [1, 3]
            },
            {
                "question": "Какие разделы есть в программе испытаний (МИ 3650-2022)?",
                "options": [
                    "Методы (методики) испытаний средств измерений.",
                    "Условия проведения испытаний средств измерений.",
                    "Ресурсные испытания.",
                    "Анализ конструкции испытываемого СИ на наличие ограничений доступа к определенным частям средств измерений (включая программное обеспечение) с целью предотвращения несанкционированной настройки и вмешательства, которые могут привести к искажению результатов измерений, на наличие заводских и (или) серийных номеров, обеспечивающих идентификацию каждого экземпляра средств измерений, на установление места, способа и формата нанесения заводского и (или) серийного номера с целью обеспечения возможности прочтения и сохранности номера в процессе эксплуатации средства измерений (в соответствии с требованиями части 2 статьи 9 Федерального закона N 102-ФЗ), на возможность нанесения знака утверждения типа и знака поверки в местах, доступных для просмотра."
                ],
                "correct_answers": [0, 1, 3]
            },
            {
                "question": "Согласно Приказу №2907, методика поверки для группы СИ:",
                "options": [
                    "Должна быть разработана для каждого типа отдельно.",
                    "Может применяться при схожей конструкции и принципе действия.",
                    "Требует обязательного согласования с Росстандартом.",
                    "Может допускать выборочную поверку при наличии соответствующих критериев."
                ],
                "correct_answers": [1, 3]
            },
            {
                "question": "При внесении изменений в ПО СИ необходимо:",
                "options": [
                    "Уведомить Росстандарт.",
                    "Провести анализ влияния на метрологические характеристики.",
                    "Обновить описание типа.",
                    "Получить новый сертификат."
                ],
                "correct_answers": [1, 2]
            },
            {
                "question": "Согласно ФЗ 102-ФЗ, кто утверждает тип средств измерений?",
                "options": [
                    "Минпромторг.",
                    "Росстандарт.",
                    "ФБУ \"НИЦ ПМ - Ростест\".",
                    "Аккредитованное юридическое лицо."
                ],
                "correct_answers": [1]
            },
            {
                "question": "Какой документ подтверждает полномочия заявителя при подаче заявки на испытания?",
                "options": [
                    "Учредительный договор.",
                    "Доверенность.",
                    "Доверенность, заверенная нотариусом.",
                    "Выписка из ЕГРЮЛ.",
                    "Приказ о назначении ответственного лица."
                ],
                "correct_answers": [1]
            },
            {
                "question": "Срок действия сертификата об утверждении типа средств измерений:",
                "options": [
                    "5 лет.",
                    "До истечения срока действия типа.",
                    "Указывается в приказе Росстандарта об утверждении типа средств измерений.",
                    "Не ограничен."
                ],
                "correct_answers": [2]
            },
            {
                "question": "Какие требования к знаку утверждения типа (Приказ Минпромторга №2905)?",
                "options": [
                    "Размер не менее 5×5 мм.",
                    "Указание цвета знака.",
                    "Нанесение на СИ или документацию.",
                    "Указание даты утверждения."
                ],
                "correct_answers": [2]
            },
            {
                "question": "Какие сведения включаются в раздел \"Программное обеспечение\" описания типа средств измерений?",
                "options": [
                    "Наименование ПО и его разработчик.",
                    "Срок действия лицензии ПО.",
                    "Требования к операционной системе.",
                    "Идентификационный номер версии ПО."
                ],
                "correct_answers": [0, 3]
            },
            {
                "question": "Какие данные указываются в акте испытаний?",
                "options": [
                    "Сведения о поверке эталонов.",
                    "Наименование и обозначение типа СИ, представленного Заявителем.",
                    "Рекомендации по эксплуатации СИ.",
                    "Срок действия сертификата."
                ],
                "correct_answers": [1]
            },
            {
                "question": "Какие сведения содержит проект описания типа средств измерений?",
                "options": [
                    "Сведения о методике поверки.",
                    "Наименование и обозначение типа СИ.",
                    "Межповерочный интервал.",
                    "Применяемые при поверке эталоны."
                ],
                "correct_answers": [1]
            },
            {
                "question": "Согласно приказу Минпромторга № 2905, испытания средств измерений единичного производства проводятся:",
                "options": [
                    "На одном образце.",
                    "На всех образцах партии.",
                    "На выборке из 10% партии.",
                    "Не требуются."
                ],
                "correct_answers": [1]
            },
            {
                "question": "При продлении срока действия типа СИ необходимо:",
                "options": [
                    "Повторные испытания.",
                    "Заключение о соответствии документации.",
                    "Заявление с обоснованием неизменности характеристик.",
                    "Согласование с Росстандартом."
                ],
                "correct_answers": [1, 2]
            },
            {
                "question": "Кто подписывает программу испытаний?",
                "options": [
                    "Руководитель Заявителя.",
                    "Главный метролог Испытателя.",
                    "Представитель Росстандарта.",
                    "Главный метролог Заявителя."
                ],
                "correct_answers": [0]
            },
            {
                "question": "Согласно ФЗ №102-ФЗ, обязательные требования к СИ устанавливаются:",
                "options": [
                    "Техническими регламентами.",
                    "Производителем.",
                    "Государственными поверочными схемами.",
                    "Международными стандартами."
                ],
                "correct_answers": [0, 2]
            },
            {
                "question": "Что указывается в разделе «Программное обеспечение» описания типа?",
                "options": [
                    "Идентификационный номер версии.",
                    "Разработчик ПО.",
                    "Уровень защиты от изменений.",
                    "Рекомендации по обновлению."
                ],
                "correct_answers": [0, 2]
            },
            {
                "question": "Какие изменения требуют проведения испытаний?",
                "options": [
                    "Увеличение диапазона измерений.",
                    "Исправление опечаток в руководстве.",
                    "Изменение материалов корпуса СИ.",
                    "Обновление логотипа производителя."
                ],
                "correct_answers": [0, 2]
            },
            {
                "question": "Какие основания для отказа в утверждении типа средств измерений?",
                "options": [
                    "Отсутствие сертификата ISO 9001.",
                    "Отсутствие фотографий общего вида.",
                    "Нарушение требований к оформлению программы испытаний.",
                    "Несоответствие заявленным метрологическим характеристикам."
                ],
                "correct_answers": [2, 3]
            },
            {
                "question": "Какие требования к методике поверки неверны?",
                "options": [
                    "Методика должна быть согласована с Росстандартом.",
                    "Допускается отсутствие критериев выборки.",
                    "Требуется опробование при внесении изменений.",
                    "Прослеживаемость к эталонам обязательна."
                ],
                "correct_answers": [0, 1]
            },
            {
                "question": "Какие данные указываются в разделе \"Назначение средства измерений\"?",
                "options": [
                    "Область применения.",
                    "Измеряемые величины.",
                    "Габаритные размеры.",
                    "Номер патента."
                ],
                "correct_answers": [1]
            },
            {
                "question": "Какие требования к знаку поверки?",
                "options": [
                    "Наносится в доступном для просмотра месте.",
                    "Должен содержать дату следующей поверки.",
                    "Размер не менее 3×3 мм.",
                    "Изготавливается только в виде наклейки."
                ],
                "correct_answers": [0]
            },
            {
                "question": "Кто может осуществлять поверку?",
                "options": [
                    "Любой индивидуальный предприниматель (ИП)",
                    "Аккредитованные в соответствии с законодательством Российской Федерации об аккредитации в национальной системе аккредитации на проведение поверки средств измерений юридические лиц и индивидуальные предприниматели",
                    "Любое юридическое лицо, имеющее средства измерения",
                    "Нет верного ответа"
                ],
                "correct_answers": [1]
            },
            {
                "question": "В каком случае СИ подлежит первичной поверке?",
                "options": [
                    "Находящиеся в процессе эксплуатации",
                    "Законсервированные",
                    "До ввода в эксплуатацию",
                    "Нет верного ответа"
                ],
                "correct_answers": [2]
            },
            {
                "question": "Сроки выгрузки по передачи сведений в аршин РСИ и эталонов?",
                "options": [
                    "Сведения о результатах поверки средств измерений в целях подтверждения поверки должны быть переданы в ФИФ АРШИН в сроки, не превышающие 20 рабочих дней для СИ, применяемых в качестве эталонов, и 40 рабочих дней для остальных средств измерений с даты проведения поверки средств измерений.",
                    "Сведения о результатах поверки средств измерений в целях подтверждения поверки должны быть переданы в ФИФ АРШИН в сроки, не превышающие 40 рабочих дней для СИ, применяемых в качестве эталонов, и 20 рабочих дней для остальных средств измерений с даты проведения поверки средств измерений.",
                    "Сведения о результатах поверки средств измерений в целях подтверждения поверки должны быть передани в ФИФ АРШИН в любые сроки.",
                    "Нет верного ответа"
                ],
                "correct_answers": [0]
            },
            {
                "question": "Чем подтверждается результат поверки?",
                "options": [
                    "Наличием свидетельства о поверке.",
                    "Наличием записи во ФГИС АРШИН."
                ],
                "correct_answers": [1]
            },
            {
                "question": "Какие организации могут проводить аттестацию эталона?",
                "options": [
                    "Государственные научные метрологические институты, государственные региональные центры метрологии, которые содержат и применяют эталоны единиц величин с более высокими показателями точности.",
                    "Государственные научные метрологические институты, государственные региональные центры метрологии, индивидуальные предприниматели, все частные организации, которые содержат и применяют эталоны единиц величин с более высокими показателями точности.",
                    "Государственные научные метрологические институты.",
                    "Государственные научные метрологические институты, государственные региональные центры метрологии."
                ],
                "correct_answers": [0]
            },
            {
                "question": "Что такое тип средств измерений?",
                "options": [
                    "Совокупность средств измерений, предназначенных для измерений одних и тех же величин, выраженных в одних и тех же единицах величин, основанных на одном и том же принципе действия, имеющих одинаковую конструкцию и изготовленных по одной и той же технической документации.",
                    "Совокупность средств измерений, предназначенных для измерений одних и тех же величин, выраженных в одних и тех же единицах величин, основанных на одном и том же принципе действия.",
                    "Совокупность средств измерений, предназначенных для измерений одних и тех же величин.",
                    "Нет верного ответа"
                ],
                "correct_answers": [0]
            },
            {
                "question": "Что такое эталон единицы величины?",
                "options": [
                    "Эталон единицы величины --- техническое средство, предназначенное для измерений.",
                    "Эталон единицы величины --- техническое средство, предназначенное для воспроизведения и (или) хранения и передачи единицы величины.",
                    "Эталон единицы величины --- это любое средство измерений.",
                    "Эталон единицы величины --- это любое средство измерений, имеющее запись в ФИФ АРШИН."
                ],
                "correct_answers": [1]
            },
            {
                "question": "Каким нормативным документом регламентируется признание результатов калибровки при поверке?",
                "options": [
                    "ФЗ 102",
                    "Приказ Минпромторга РФ от 11 февраля 2020 г. N 456",
                    "Приказ Минпромторга РФ от 31.07.2020 N 2510",
                    "Приказ Минпромторга РФ от 27.01.2025 N 336"
                ],
                "correct_answers": [3]
            },
            {
                "question": "В какой статье 102 ФЗ регламентируется содержание сертификата о калибровке?",
                "options": [
                    "Статья 2. Основные понятия",
                    "Статья 18. Калибровка средств измерений",
                    "Статья 13. Поверка средств измерений",
                    "Нет верного ответа"
                ],
                "correct_answers": [3]
            },
            {
                "question": "На какие стандартные образцы и средства измерений серийного производства распространяется решение об утверждении типа?",
                "options": [
                    "Соответствующие описанию их типа и изготавливаемые в период действия утвержденного типа (в течение 5 лет от даты подписания приказа об утверждении типа стандартных образцов или типа средств измерений).",
                    "С момента даты выпуска приказа Ростандарта.",
                    "Изготовленные для испытаний, СИ, сведения о которых содержатся в материалах испытаний, изготовленные после утверждения акта испытаний.",
                    "С даты внесения СИ в перечень утвержденных средств измерений."
                ],
                "correct_answers": [0, 2]
            },
            {
                "question": "Какие СИ подлежат обязательной поверке?",
                "options": [
                    "Выпущенные после 2018 года.",
                    "Предназначенные для применения в сфере государственного регулирования.",
                    "Выпущенные до 1991 года.",
                    "Предназначенные для применения во всех государственных компаниях."
                ],
                "correct_answers": [1]
            },
            {
                "question": "Какие СИ подлежат обязательной калибровке?",
                "options": [
                    "Предназначенные для применения в сфере государственного регулирования.",
                    "Не предназначенные для применения в сфере государственного регулирования.",
                    "Эксплуатируемые в организациях по обеспечению безопасности жизнедеятельности граждан.",
                    "Нет верного ответа."
                ],
                "correct_answers": [3]
            },
            {
                "question": "Допускается ли проводить калибровку средством измерений по точности сопоставимо с калибруемым средством измерений?",
                "options": [
                    "Допускается",
                    "Не допускается"
                ],
                "correct_answers": [0]
            },
            {
                "question": "Допускается ли осуществлять поверку средства измерений вне области аккредитации?",
                "options": [
                    "Допускается, если согласовано с главным метрологом",
                    "Не допускается",
                    "Допускается, если поверка осуществляется в соответствии с Приказом от 27.01.2025 № 336"
                ],
                "correct_answers": [1]
            },
            {
                "question": "Кто согласует ЛПС?",
                "options": [
                    "Уполномоченные лица государственного научного метрологического института или государственного регионального центра метрологии.",
                    "Согласование не обязательно, достаточно утвердить ЛПС директором организации, где будет применяться ЛПС."
                ],
                "correct_answers": [0]
            },
            {
                "question": "В каких случаях копии протоколов поверки передаются в ФИФ?",
                "options": [
                    "Для всех СИ",
                    "Только для СИ, применяемых в качестве эталонов",
                    "При выполнении поверки СИ в сокращенном объеме",
                    "По требованию"
                ],
                "correct_answers": [1, 2]
            },
            {
                "question": "Какие сведения включаются в данные о результате поверки средства измерений согласно части 6 статьи 13 Федерального закона N 102-ФЗ?",
                "options": [
                    "Наименование средства измерений",
                    "Сведения об изготовителе типа СИ",
                    "Эталоны, стандартные образцы, средства измерений и материалы, применяемые при поверке",
                    "Все вышеперечисленное"
                ],
                "correct_answers": [0, 2]
            },
            {
                "question": "Для подтверждения сведений о результатах поверки средств измерений, передаваемых в ФИФ, достаточно:",
                "options": [
                    "Дать слово",
                    "Усиленной квалифицированной электронной подписи руководителя организации-владельца СИ",
                    "Ручной подписи руководителя организации, передающей сведения",
                    "Позвонить Оператору ФИФ",
                    "Усиленной квалифицированной электронной подписи руководителя организации, передающей сведения"
                ],
                "correct_answers": [4]
            },
            {
                "question": "Кто передает сведения о результатах поверки средств измерений в ФИФ?",
                "options": [
                    "Организации, проводящие поверку",
                    "Владельцы средств измерений",
                    "Курьер",
                    "Потребители",
                    "Все вышеперечисленные"
                ],
                "correct_answers": [0]
            },
            {
                "question": "Какие сведения относятся к непубликуемым данным об утвержденных типах средств измерений в ФИФ?",
                "options": [
                    "Копия акта испытаний",
                    "Наименование утвержденного типа",
                    "Интервал между поверками",
                    "Методики поверки",
                    "Сведения о правообладателе"
                ],
                "correct_answers": [0, 4]
            },
            {
                "question": "Посредством чего осуществляется предоставление документов и сведений, содержащихся в ФИФ?",
                "options": [
                    "Запрос в Минпромторг",
                    "Подписка на доступ к библиотеке ФБУ «НИЦ ПМ -- Ростест»",
                    "Доступ к электронным базам через официальный сайт ФИФ",
                    "Подписка на журнал «Главный метролог»",
                    "Через ФГИС «Единый портал государственных и муниципальных услуг (функций)»",
                    "Сообщений в форме электронного документа"
                ],
                "correct_answers": [0, 4, 5]
            },
            {
                "question": "Что образует состав Федерального информационного фонда?",
                "options": [
                    "Нормативные правовые акты РФ, содержащие требования к измерениям, СО и СИ",
                    "Международные документы в области обеспечения единства измерений",
                    "Сведения о результатах поверки средств измерений",
                    "Сведения об утвержденных типах СО и СИ",
                    "Все перечисленные варианты"
                ],
                "correct_answers": [4]
            }
        ]
        
        # Инструкция для пользователя
        clear_screen()
        print("="*70)
        print("ИНСТРУКЦИЯ ДЛЯ ПРОХОЖДЕНИЯ ТЕСТА:")
        print("- Тест состоит из 15 случайных вопросов из базы 51 вопроса")
        print("- На каждый вопрос дается 60 секунд")
        print("- Если время истечет до ввода ответа, ответ будет считаться неправильным")
        print("- Для вопросов с несколькими правильными ответами вводите номера через запятую (например: 1,3)")
        print("- Если нажмете Enter без ввода ответа, будет дана одна попытка повторить ввод")
        print("- Система оценки: за частично правильные ответы начисляются пропорциональные баллы")
        print("  (например, за 1 правильный ответ из 2 вы получите 0.5 балла)")
        print("="*70)
        
        input("\nНажмите Enter для начала тестирования...")
        
        # Запуск тестирования
        selected_questions = get_random_questions(questions, 15)
        results = []

        for i, question in enumerate(selected_questions, 1):
            result = display_question(question, i, len(selected_questions))
            results.append(result)
            
            # Краткая пауза перед переходом к следующему вопросу
            if i < len(selected_questions):
                print("\nПереход к следующему вопросу через 2 секунды...")
                time.sleep(2)
            else:
                print("\nТестирование завершено! Формируем отчет...")
                time.sleep(2)

        # Генерация и вывод краткого отчета
        clear_screen()
        short_report = generate_report(results, user_name, department)
        print(short_report)
        
        # Генерация полного отчета для файла
        full_report = generate_report(results, user_name, department, full_report=True)
        
        # Сохранение результатов
        file_path = save_report(full_report, user_name, department)
        
        if file_path:
            print(f"\n✅ Отчет успешно сохранен: {file_path}")
        else:
            print("\n❌ Не удалось сохранить отчет.")
        
        print("\nНажмите Enter для выхода...")
        input()
    
    except Exception as e:
        print(f"\n⚠️ Произошла ошибка в основном потоке: {str(e)}")
        print(traceback.format_exc())
        print("\nНажмите Enter для выхода...")
        input()

if __name__ == "__main__":
    run_quiz()