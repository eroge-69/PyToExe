# Made by Sora_
# Thanks to the Genshin Impact Modding Community for their help and support

# Fixes for texture, Cipher and Cyrene

# ##########################################################################################################################
#     ................                .... ..   ..               ............. ............                              
#     ................                ... ...                    .........................                               
#   ..............            ....                 ..            ........,]`.]............                               
# ................            ......                             ...,/\]/O],*,[\[]........                               
# ............                                           ........,/\@O@/,/\]]],`=`*,=\`...........                       
# .......... .        ..                                 ....../@\@@/`/*`,/\/\[,*,,**=OO]]]........                      
# ............                                        .. ..../O\O@[,,,///`********,*`,]\]*/\`.....                       
# ...........  ...                                    .. .../O@@^*,/\/`*/\***********,**/*/\/.....                       
# ............. .... .                     .  ............][\ooo\O\@^]/ooo`****,*****`*`^`/O@O..... ..                .. 
# ............. .... .                   ............,O\OOO\oo]OOo@`@OO//`***,\\,,``/^,\^,***[\....                      
# ............                            .............,//*,*]/oO^\@ooooo/^*]\]/`\*//**=**`[^*/^...                      
# ............                            ...=]]]]]/[**`*,,*/\o@`O@O/OO\=O/[O\``[/^/``*O]`**,^\\....                     
# ............ ...                       ......,OooooO/@@/o\[//=@o@o//,OOO/\//*/\OO\]`=\^*O]/@@\^..       .. .           
# ............    ..                      ........[@O\oooo\O@/@OOO\///O/\\@^]@\OOO\\\oOO^\@o]OO\^..       .. .           
# .......... .....    ..      .  .       ............/oo/\/,\@O@O@\OO\^]]@@/\,\//`=OO\O@^@O/=\\OO`....        ..         
# ..... ....... ..... .       ....        .........,//O[[]OOOOOO/O/@@@@@@\/]o\OO`=O@\=OO/O/,=/^@@@....        ..         
# ................            .....  .............=\`*`/\OOooO/@/@,O@@@@O^,@\OO*=O@\*oOOOO^=^/@/@,\... ..         .......
# ................            ....        ......,//*,/OOOoO\=/OOo^\\.\O/.../O//\/@\O\@@\OO*@\O=\@..=.....         ....   
# ................                    ........,/,/,//OO\/*,*@oOO\^O@......*O/`.**\@@@^@@@^/\O^**=^........               
# ...,]/\]].....                      .....]\\*/O\@oo\/,`*/@Oo/@o^=^.....,.......@O@`/@@^@/oO`\OO^... .                  
# .,/`@O[*............................,]/^**/@O/OOOO``*,\o@O/\OO/^=\..........[...,.*@O@@OO@,*/=/..                      
# O,[,`\]/[\/OOO\/^[*,\/**,]]]]]]O\Oo\,*,/OO@@oOO`**,*,oO\/*@@@@/o,@\`..............@O@Oo@@`*/./...                      
# \,/[,*`,\//@//oo\O]*,\`..\/**`,Oo/[OOo@O@\O/\//o\,`\//[*//@@@O@o`@^@`.[,......../@\@OO@@*=`......                      
# O/@//\`*/**[\/\OO\@\\`\[\..\][\/@OO\OO^OO/]o/o/o\[/\*,/O/\@@@\O@O@,/@\.`..,]/@@OOO@@o@@/`.......                       
# \/...,,[[\`*,*\\\/O[@.,//*./OOOO@@@OO@Ooo\o\@/\[,*\,OO@oo@@@@@O@@@=@@@@@@@@OO@=@@@OOO\O^.. ... .                       
# .......*``],,``/\O]*/..\\^=\/oOo///\oOOOOO\]`*/`/]OO/oOO\O@@@@@@@@@@@@@@@@@O@@@@O\O@OO=^...     .. .                   
# .../\\\\\=\/O\/[^\`=/...`.@\],/O`**\]`oooooo^O@\oo\@O@OOOOOOOO@@@@/@@@@@@@@@@\OO@@@/\/=.......  ..                     
# ./OooooOO/^/^***/\,/@`....@/`,,*`*`*/]]O/@//ooOOO/@@@@O\OOOOOOOOOOOO@O]\@@@@O@@@@@@OO@OO^......         ....           
# OooO/@\o\/*`******/@O^....@.*`*`***]/@@OOOOOOO/O@@OO\@@@@OOOOOO@@OO@OOOO@@@@@OOO@@@@@O@@O^.......               ....   
# OOO\Oo\/**`**,**\]`@,=^**//\\/\\\`O\oO@/`/@O\@@OOOOOOOO@@@@OOO/@@@@@@@OOO@@@@OOOOO@@@@@@@O\..  .                . ..   
# OOOOO@[,,*`]/Oooooo\Ooo\oo/O`/\@*[,[O@/O\OOO@@OOOOOO@OOOO@@@@OOOOO@@@@@O@@@/@\@@[OOOOO@@@@OO`...         .......       
# OOOo/*`,,@oooo\oooo\//@\oo/O\//,\@OooOOOoo@O@OOOOO@@O@@@@@@@O@OOOOOO@@\\@@OO\OO@@`\/OOO\@@OO@...          . ....       
# OOo@*``/\/[.......,.==@@OO/OO\/\^OO/@\OoO\@@@@@@@@@@@@@@@@@\@@@@@OOO@@@/@@OOOOO@@@@@OOOOOO@OO^...       ....           
# OOOO,,/............^,@@O\@^@O/\//OO@@@@@@@@@@@@@@@@OOO/OOOOOO@O\@OOO@@@@@O]]\]]/O@\OOOOOOOOO@O...         ..           
# =OO/.................@@OO@@@=]oo^OOO@@@@@OOOOOO/OO@O@@@@\OOOOOO@@@@/OOOOOO@@@@@@@@@@@OO@@@@@@@^.                       
# ............,\O`.....,@O@@@OO@/\/OOOOO@@@OOOOOOOOOOOO@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@^.                       
# ............/@^........\/OOOOOO@@O/OOO@@OOOOOOOOOOOOOOOOOO\@O@@@@@@@@@@@@@@@@@@@@@@@@OOOOOO@@@^.                       
# .. ... .....^*,].........\@O/@@@@@@@@@@@@@@@@@@OOOo/O@@@@@@O/o@@@@@@@@@@@@@@@OO@@@@@@@OOOOOOO@^.              ..       
# ............\,***[].......=@@@@@@@@@@@@@@@@@@@@@@@@@@@@@OOOOOoO\@@@@@@@@OO@O@OOOOOOO@@OOOOO@@@^.  ..        ......     
# ... .........\,***,*[`......@oO@@@@@@@@@@@@@@@@@@@@@@\/OOoO/O/`*\@@@@@@@OOOOO@OOOOOOO\\OOOOOO@^..   ...       ..   .   
# ....... .......\\,*``*,[]...,@OO@@@@@@@@@@@@@@@@@@[ooooo@/^*]/O\/\@@@@@OOOO@@@OOOOOOOOOO@OOOOO\..               ....   
# .................,@@]*^,,*``**,\\@@@@@@@@@@@@@/@\oOO[]]/@\oooooooo\@@@@O@OOO@@O@@@OO\OOO@@OOOO@..               ...... 
# ....    ............[@//]]`****]\]/@@@@@@@@@O@OOOooooooooooooOooO@\\/@@@@@@@OO/@@@@@@@@@OOOOOOO\....                   
# ....  .... .... .......,\Oo//[]*^ooooooo\/@@ooOoooooOoooooOoO/`.//ooO\@@@@@@@/O@OO/@@@@@@@/OOOOO^...                   
# .. ...  ....    ..   ......[\[`/=/oooooOooooooooOOOoo/OO[`...,/Ooo\\/./@@@@@@@@@OOOO\\@@@@@@@O@@@.....                 
# ......  ....           ........[\O/[[[[[OO[[[[[\O/[`.......,O/\ooO`..=OO@@@@@@@@@OOOOOOOO@\@OO@@@@.... .               
# ....    ....           .........,/\\......................///O/`......=@@@@@@@@@@OOOOOOOOOO@OO\@@@^.....               
# ....       .            .........*=....................,[///`.........=@@@@@@@@@@OOOOOOOOOOO@O@@@@@.....               
# ...... .                  ..   ...\\................,/][`.......... ..@@@@@@@@@@@@OOOOO@@@O\@@@@@@@@....               
# ........                        ....\`.........]/OO[`.......  .......=@@@@@@@@@@@@@@@O@@@@@@@@@@@@@@^...               
# . .... .... ....              ...........[`.............      .......@@@@@@@/OOO@@@@@@@@@@@@@@/@@@O@@^..               
#   ......... ...             .   ..... ..................        ...,/@@@@@@@OOOOO/@@@@@@@OOO@@@@@OOOO@`.               
#   ........  ....                    .    ......   ................/@@@@@@@@@@OOO@OOO@@@@@OOOOO@@@OOOOO@.........       
# .   .....   ....                        .. ..  .         .. ..../@@@@@@@@@@@@@@O@@@@@@@@@@@@/O/@@OOOOOOO/`.... ..      
#    ...    ..           .                                ....../OOO@@@@@@@@@@@@@O@@@@@@@@@@@@@@@=@@OOOO\/O/\.....       
#    .... .           ....                               ...../@OOOOOO@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@OOOO\//O\\.....      
# ........        ...... .                .           ....../@OOOOOOOO@@@@@@@@@@@@@@@@@@OoO@@@@@@@OOOOOOO/o`@]O....      
# ........        .....                   ...         .....,@OOOOOO@@@@@O@=]/[[[@@@@@@@@@OOOOOOO@@OOOOOOOOo/o///`...     
# ..  ...   ..                                    .....,/@@@@@OOO@@@@@@@@\oooooooooooo/o]\\\]]/@@@@OOOOOOO/]@[O`......   
# ##########################################################################################################################

import os
import re
import shutil

def has_special_blend_section(content):
    """检测是否包含特定的[Resource*Blend]节"""
    pattern = r'\[Resource[^\]]*Blend[^\]]*\][^\[]*?type\s*=\s*Buffer[^\[]*?stride\s*=\s*(?:8|4)'
    return re.search(pattern, content, re.IGNORECASE | re.DOTALL) is not None

def is_special_case(path):
    """检测路径是否包含特殊关键词（hair或特定NPC）"""
    special_keywords = [
        'hair', 
        'AmphoreusNPC', 
        'LuofuNPC', 
        'HertaSpaceStationNPC', 
        'Jarilo-VINPC', 
        'PenaconyNPC'
    ]
    return any(keyword.lower() in path.lower() for keyword in special_keywords)

def replace_ini_content(content):
    # 第一步：精确匹配纹理分配
    def replace_diffuse(match):
        path = match.group(1).strip()
        if is_special_case(path):
            return f'ps-t1 = Resource{path}Diffuse'
        else:
            return f'ps-t2 = Resource{path}Diffuse'
    
    def replace_lightmap(match):
        path = match.group(1).strip()
        if is_special_case(path):
            return f'ps-t2 = Resource{path}LightMap'
        else:
            return f'ps-t3 = Resource{path}LightMap'
    
    # 精确匹配纹理分配行
    content = re.sub(
        r'ps-t0\s*=\s*Resource([^;\n]*?)Diffuse', 
        replace_diffuse, 
        content, 
        flags=re.IGNORECASE
    )
    content = re.sub(
        r'ps-t1\s*=\s*Resource([^;\n]*?)LightMap', 
        replace_lightmap, 
        content, 
        flags=re.IGNORECASE
    )

    # 第二步：处理7行连续结构（无elif）
    pattern7 = re.compile(
        r'(ib\s*=\s*Resource([^;\n]*?)IB[^\n]*\n)'  # ib行
        r'((?:[^\n]*\n)?\s*if\s+ps-t0\s*==\s*[^\n]*\n)'  # if ps-t0行
        r'((?:[^\n]*\n)+?)'  # 中间内容（包含ps-t2分配）
        r'(\s*endif[^\n]*\n)'  # endif
        r'((?:[^\n]*\n)?\s*if\s+ps-t1\s*==\s*[^\n]*\n)'  # if ps-t1行
        r'((?:[^\n]*\n)+?)'  # 中间内容（包含ps-t3分配）
        r'(\s*endif[^\n]*\n)',  # endif
        re.IGNORECASE
    )
    
    def replace_block7(match):
        ib_line = match.group(1)           # ib = Resource*IB
        path = match.group(2).strip()       # 资源路径
        if_line1 = match.group(3)          # if ps-t0 == *
        content1 = match.group(4)          # 中间内容1
        endif1 = match.group(5)            # endif
        if_line2 = match.group(6)          # if ps-t1 == *
        content2 = match.group(7)          # 中间内容2
        endif2 = match.group(8)            # endif
        
        special = is_special_case(path)
        
        # 根据特殊情况进行寄存器替换
        if special:
            new_if_line1 = if_line1.replace("ps-t0", "ps-t1")
            new_if_line2 = if_line2.replace("ps-t1", "ps-t2")
        else:
            new_if_line1 = if_line1.replace("ps-t0", "ps-t2")
            new_if_line2 = if_line2.replace("ps-t1", "ps-t3")
        
        # 重建7行结构
        return (f"{ib_line}{new_if_line1}{content1}{endif1}"
                f"{new_if_line2}{content2}{endif2}")
    
    content = pattern7.sub(replace_block7, content)
    
    # 第三步：处理9行连续结构（有elif）
    pattern9 = re.compile(
        r'(ib\s*=\s*Resource([^;\n]*?)IB[^\n]*\n)'  # ib行
        r'((?:[^\n]*\n)?\s*if\s+ps-t0\s*==\s*[^\n]*\n)'  # if ps-t0行
        r'((?:[^\n]*\n)+?)'  # 中间内容1
        r'(\s*elif\s+ps-t0\s*==\s*[^\n]*\n)'  # elif ps-t0行
        r'((?:[^\n]*\n)+?)'  # 中间内容2
        r'(\s*endif[^\n]*\n)'  # endif
        r'((?:[^\n]*\n)?\s*if\s+ps-t1\s*==\s*[^\n]*\n)'  # if ps-t1行
        r'((?:[^\n]*\n)+?)'  # 中间内容3
        r'(\s*endif[^\n]*\n)',  # endif
        re.IGNORECASE
    )
    
    def replace_block9(match):
        ib_line = match.group(1)           # ib = Resource*IB
        path = match.group(2).strip()       # 资源路径
        if_line1 = match.group(3)          # if ps-t0 == *
        content1 = match.group(4)          # 中间内容1
        elif_line = match.group(5)         # elif ps-t0 == *
        content2 = match.group(6)          # 中间内容2
        endif1 = match.group(7)            # endif
        if_line2 = match.group(8)          # if ps-t1 == *
        content3 = match.group(9)          # 中间内容3
        endif2 = match.group(10)           # endif
        
        special = is_special_case(path)
        
        # 根据特殊情况进行不同的替换
        if special:
            # 特殊情况：转换为三个独立的if块
            return (f"{ib_line}"
                    f"{if_line1.replace('ps-t0', 'ps-t0')}{content1.replace('ps-t2', 'ps-t0')}{endif1}"
                    f"{elif_line.replace('ps-t0', 'ps-t1')}{content2.replace('ps-t3', 'ps-t1')}{endif1}"
                    f"{if_line2.replace('ps-t1', 'ps-t2')}{content3.replace('ps-t3', 'ps-t2')}{endif2}")
        else:
            # 普通情况：转换为三个独立的if块
            return (f"{ib_line}"
                    f"{if_line1.replace('ps-t0', 'ps-t0')}{content1.replace('ps-t2', 'ps-t0')}{endif1}"
                    f"{elif_line.replace('ps-t0', 'ps-t2')}{content2.replace('ps-t3', 'ps-t2')}{endif1}"
                    f"{if_line2.replace('ps-t1', 'ps-t3')}{content3.replace('ps-t3', 'ps-t3')}{endif2}")
    
    content = pattern9.sub(replace_block9, content)
    
    # 第四步：删除包含特定字符串的行
    patterns_to_delete = [
        r'^\s*ps-t4\s*=\s*Resource.*SilklightMap.*$',
        r'^\s*ps-t4\s*=\s*Resource.*StockingMap.*$',
        r'^\s*ps-t2\s*=\s*ResourceTingyunCt3.*$'
    ]
    
    for p in patterns_to_delete:
        content = re.sub(p, '', content, flags=re.IGNORECASE | re.MULTILINE)
    
    # 第五步：全局替换多个字符串
    replacements = [
        ('8fcd6b42', 'c011f88a'),
        ('9228670d', '406e217e'),
        ('8bb687ac', '4ce197db'),
        ('bd1b88e5', '8ca091e7')
    ]
    
    for old, new in replacements:
        content = content.replace(old, new)
    
    # ========================================================
    # 新增修改步骤1：处理AmphoreusNPC的特定结构
    # ========================================================
    pattern_amph = (
        r'ps-t1 = ResourceAmphoreusNPC(.*?)Diffuse\s*'
        r'if \$fix == 0\s*'
        r'(.*?)ps-t2 = ResourceAmphoreusNPC(.*?)LightMap\s*'
        r'else if \$fix == 1\s*'
        r'(.*?)ps-t2 = ResourceAmphoreusNPC(.*?)LightMap\s*'
        r'endif'
    )
    
    replacement_amph = (
        'if $fix == 0\n'
        '    ps-t1 = ResourceAmphoreusNPC\\1Diffuse\n'
        'else if $fix == 1\n'
        '    ps-t0 = ResourceAmphoreusNPC\\1Diffuse\n'
        'endif\n'
        'ps-t2 = ResourceAmphoreusNPC\\3LightMap'
    )
    
    content = re.sub(pattern_amph, replacement_amph, content, flags=re.IGNORECASE)
    
    # ========================================================
    # 新增修改步骤2：处理三行纹理分配
    # ========================================================
    pattern_triple = (
        r'([^\n]*ps-t1\s*=\s*Resource[^\s;]+Diffuse[^\n]*\n)'
        r'([^\n]*ps-t2\s*=\s*Resource[^\s;]+LightMap[^\n]*\n)'
        r'([^\n]*ps-t2\s*=\s*Resource[^\s;]+LightMap[^\n]*\n)'
    )
    
    def replace_triple(match):
        line1 = match.group(1).replace('ps-t1', 'ps-t0')
        line2 = match.group(2).replace('ps-t2', 'ps-t1').replace('LightMap', 'Diffuse')
        line3 = match.group(3)
        return line1 + line2 + line3
    
    content = re.sub(pattern_triple, replace_triple, content, flags=re.IGNORECASE)
    
    return content

def process_directory(directory):
    for root, dirs, files in os.walk(directory):
        for file in files:
            if file.lower().endswith('.ini'):
                file_path = os.path.join(root, file)
                try:
                    with open(file_path, 'r', encoding='utf-8') as f:
                        content = f.read()
                    
                    # 检测条件：必须包含ps-t0 = Resource*Diffuse
                    has_ps_t0_diffuse = re.search(r'ps-t0\s*=\s*Resource.*Diffuse', content, re.IGNORECASE)
                    
                    # 检测条件：必须包含TextureOverride*Blend 或 TextureOverride*Position
                    has_texture_override = (
                        re.search(r'TextureOverride.*Blend', content, re.IGNORECASE) or 
                        re.search(r'TextureOverride.*Position', content, re.IGNORECASE)
                    )
                    
                    # 检测特殊Blend节（新限定条件）
                    has_special_blend = has_special_blend_section(content)
                    
                    modified = False
                    new_content = content
                    
                    # 主要修改：只有满足所有条件才执行
                    if has_ps_t0_diffuse and has_texture_override and not has_special_blend:
                        # 创建备份文件
                        backup_path = os.path.join(root, f"DISABLED_{file}")
                        if not os.path.exists(backup_path):
                            shutil.copy2(file_path, backup_path)
                            print(f"已创建备份: {backup_path}")
                        
                        # 执行主要修改
                        processed_content = replace_ini_content(content)
                        if processed_content != content:
                            new_content = processed_content
                            modified = True
                    
                    # 全局替换（任何情况都执行）
                    global_replacements = [
                        ('8fcd6b42', 'c011f88a'),
                        ('9228670d', '406e217e'),
                        ('8bb687ac', '4ce197db'),
                        ('bd1b88e5', '8ca091e7')
                    ]
                    
                    for old, new in global_replacements:
                        if old in new_content:
                            # 如果内容还未被修改，但需要全局替换，则标记为已修改
                            if new_content == content and not modified:
                                modified = True
                            new_content = new_content.replace(old, new)
                    
                    # 写入修改（如果有变更）
                    if modified:
                        with open(file_path, 'w', encoding='utf-8') as f:
                            f.write(new_content)
                        print(f"已修改: {file_path}")
                    else:
                        # 记录不同情况的日志
                        if has_ps_t0_diffuse and has_texture_override:
                            if has_special_blend:
                                print(f"跳过特殊Blend文件: {file_path}")
                            else:
                                print(f"满足条件但无需修改: {file_path}")
                    
                except Exception as e:
                    print(f"处理失败: {file_path} - {str(e)}")

if __name__ == "__main__":
    current_dir = os.getcwd()
    print(f"开始处理目录: {current_dir}")
    process_directory(current_dir)
    print("处理完成！")